<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mathe Legends 13.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;800&family=Patrick+Hand&display=swap');
        
        :root { --bg-color: #f0f9ff; --primary: #3b82f6; --text: #1e293b; }
        
        body { font-family: 'Fredoka', sans-serif; background-color: var(--bg-color); color: var(--text); user-select: none; }
        .nunito { font-family: 'Nunito', sans-serif; }
        .handwritten { font-family: 'Patrick Hand', cursive; }
        
        /* Grid Input Felder */
        .grid-cell {
            width: 45px; height: 55px;
            border: 2px solid #cbd5e1; background: white; color: #334155;
            font-family: 'Patrick Hand', cursive; font-size: 1.8rem;
            text-align: center; border-radius: 8px; outline: none;
            transition: all 0.2s; box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }
        .grid-cell:focus { border-color: var(--primary); transform: scale(1.1); z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .grid-cell.readonly { background: transparent; border-color: transparent; box-shadow: none; font-weight: bold; cursor: default; }
        .grid-cell.carry { height: 30px; width: 45px; font-size: 1.2rem; color: #ef4444; border: 1px dashed #fca5a5; background: #fff1f2; margin-bottom: 2px; }

        /* Shop Cards */
        .item-card { transition: all 0.2s; position: relative; overflow: hidden; }
        .item-card:active { transform: scale(0.95); }
        .rarity-common { border-color: #cbd5e1; }
        .rarity-rare { border-color: #3b82f6; background: linear-gradient(to bottom right, #eff6ff, #dbeafe); }
        .rarity-epic { border-color: #a855f7; background: linear-gradient(to bottom right, #faf5ff, #f3e8ff); }
        .rarity-legendary { border-color: #eab308; background: linear-gradient(to bottom right, #fefce8, #fef9c3); box-shadow: 0 0 15px rgba(234, 179, 8, 0.3); }
        
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .star-filled { color: #fbbf24; filter: drop-shadow(0 0 2px orange); }
        .star-empty { color: #e2e8f0; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GROSSE DATENBANK ---
        const LEVELS = [0, 200, 500, 1000, 2000, 4000, 7000, 12000, 20000, 35000, 50000, 100000];
        
        const AVATARS = [
            // Starter (Kostenlos)
            { id: 'bear', icon: 'üêª', name: 'Bruno', cost: 0, rarity: 'common' },
            { id: 'cat', icon: 'üê±', name: 'Mimi', cost: 50, rarity: 'common' },
            { id: 'dog', icon: 'üê∂', name: 'Bello', cost: 50, rarity: 'common' },
            
            // Rare (Cool)
            { id: 'fox', icon: 'ü¶ä', name: 'Foxy', cost: 250, rarity: 'rare' },
            { id: 'panda', icon: 'üêº', name: 'Pando', cost: 300, rarity: 'rare' },
            { id: 'tiger', icon: 'üêØ', name: 'Tigra', cost: 500, rarity: 'rare' },
            { id: 'lion', icon: 'ü¶Å', name: 'Leo', cost: 600, rarity: 'rare' },
            
            // Epic (Teuer)
            { id: 'robot', icon: 'ü§ñ', name: 'Robo X', cost: 1500, rarity: 'epic' },
            { id: 'alien', icon: 'üëΩ', name: 'Zorg', cost: 2000, rarity: 'epic' },
            { id: 'ghost', icon: 'üëª', name: 'Spooky', cost: 2500, rarity: 'epic' },
            { id: 'ninja', icon: 'ü•∑', name: 'Shadow', cost: 3000, rarity: 'epic' },
            
            // Legendary (Status Symbole)
            { id: 'unicorn', icon: 'ü¶Ñ', name: 'Sparkle', cost: 8000, rarity: 'legendary' },
            { id: 'dragon', icon: 'üê≤', name: 'Drago', cost: 12000, rarity: 'legendary' },
            { id: 'king', icon: 'üëë', name: 'King', cost: 25000, rarity: 'legendary' },
            { id: 'diamond', icon: 'üíé', name: 'Richie', cost: 50000, rarity: 'legendary' }
        ];

        const THEMES = [
            { id: 'default', name: 'Standard', cost: 0, bg: '#f0f9ff' },
            { id: 'dark', name: 'Nachtmodus', cost: 500, bg: '#1e293b', text: '#f8fafc' },
            { id: 'pink', name: 'Candy Welt', cost: 1000, bg: '#fdf2f8' },
            { id: 'green', name: 'Dschungel', cost: 1000, bg: '#f0fdf4' },
            { id: 'gold', name: 'Luxus', cost: 5000, bg: '#fffbeb' },
        ];

        // --- HELPER ---
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);
        const formatCH = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "'");
        
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            const now = ctx.currentTime;
            
            if (type === 'correct') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
            } else if (type === 'cash') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.2);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
            }
            osc.start(now); osc.stop(now + 0.4);
        };

        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                let clean = text.replace(/'/g, '').replace(/(\d)\.(\d)/g, '$1 Komma $2').replace(/(\d)\./g, '$1 ').replace(/\+/g, ' plus ').replace(/-/g, ' minus ').replace(/¬∑/g, ' mal ').replace(/:/g, ' geteilt durch ').replace(/Fr\./g, ' Franken ').replace(/Rp\./g, ' Rappen ').replace(/=/g, ' gleich ');
                const msg = new SpeechSynthesisUtterance(clean); msg.lang = 'de-DE'; msg.rate = 0.95;
                const voices = window.speechSynthesis.getVoices();
                const v = voices.find(v => v.lang === 'de-DE' && (v.name.includes('Google') || v.name.includes('Premium')));
                if (v) msg.voice = v;
                window.speechSynthesis.speak(msg);
            }
        };

        // --- COMPONENTS ---
        const VisualTeacher = ({ type, a, b, onClose }) => {
            const sA = a.toString().split('').map(Number); const sB = b.toString().split('').map(Number);
            const cols = Math.max(sA.length, sB.length) + 1;
            const [step, setStep] = useState(0);
            const pad = (arr) => { const p = Array(cols).fill(null); for(let i=0; i<arr.length; i++) p[cols-1-i] = arr[arr.length-1-i]; return p; };
            const pA = pad(sA); const pB = pad(sB);
            const steps = [];
            let c = 0;
            for(let i=cols-1; i>=0; i--) {
                const va = pA[i] || 0; const vb = pB[i] || 0;
                if (type === 'add') {
                    const sum = va + vb + c; const digit = sum % 10; const nextC = Math.floor(sum / 10);
                    if (i===0 && sum===0) continue;
                    let txt = `Einer: ${va} plus ${vb}`; if (c > 0) txt += ` plus ${c} (Behalte)`; txt += ` gibt ${sum}.`;
                    if (nextC > 0) txt += ` Schreibe ${digit}, behalte ${nextC}.`; else txt += ` Schreibe ${digit}.`;
                    steps.push({ col: i, text: txt, carry: nextC, res: digit }); c = nextC;
                } else { 
                    let lower = vb + c; let upper = va; let nextC = 0;
                    if (i===0 && lower===0 && upper===0) continue;
                    let txt = "";
                    if (lower > upper) {
                        txt = `Von ${lower} bis ${upper+10}. Das sind ${upper+10-lower}. Schreibe ${upper+10-lower}, behalte 1.`;
                        nextC = 1;
                    } else {
                        txt = `Von ${lower} bis ${upper} sind ${upper-lower}. Schreibe ${upper-lower}.`;
                        nextC = 0;
                    }
                    steps.push({ col: i, text: txt, carry: nextC, res: (upper>=lower ? upper-lower : (upper+10)-lower) }); c = nextC;
                }
            }
            const cur = steps[step]; const finished = step >= steps.length;
            useEffect(() => { if(cur && !finished) speak(cur.text); }, [step]);

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white p-6 rounded-3xl w-full max-w-md shadow-2xl border-4 border-yellow-400 pop-in relative text-center">
                         <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 font-bold hover:text-red-500 text-2xl">√ó</button>
                        <h2 className="font-bold text-xl text-yellow-600 mb-4 uppercase tracking-wider">üë®‚Äçüè´ Lehrer Modus</h2>
                        <div className="bg-blue-50 p-4 rounded-xl mb-6 min-h-[80px] flex items-center justify-center font-bold text-slate-700 text-lg">{step>=steps.length ? "Alles klar? Jetzt du!" : cur?.text}</div>
                        
                        <div className="flex justify-center mb-6">
                            <div className="grid gap-1 justify-center" style={{gridTemplateColumns: `repeat(${cols}, 40px)`}}>
                                {type==='add' && Array(cols).fill(0).map((_,i) => <div key={'c'+i} className="h-8 flex items-end justify-center text-red-500 text-sm font-bold">{step>0 && steps[step-1] && steps[step-1].col===i+1 && steps[step-1].carry>0 ? steps[step-1].carry : ''}</div>)}
                                {pA.map((val,i) => <div key={'a'+i} className={`flex justify-center text-2xl font-bold ${cur && cur.col===i ? 'text-blue-600 bg-blue-50 rounded' : 'text-slate-400'}`}>{val!==undefined?val:''}</div>)}
                                {pB.map((val,i) => <div key={'b'+i} className={`flex justify-center text-2xl font-bold relative ${cur && cur.col===i ? 'text-blue-600 bg-blue-50 rounded' : 'text-slate-400'}`}>{i===0 && <span className="absolute -left-6 text-slate-400">{type==='add'?'+':'-'}</span>}{val!==undefined?val:''}</div>)}
                                {type==='sub' && Array(cols).fill(0).map((_,i) => <div key={'c'+i} className="h-8 flex items-start justify-center text-red-500 text-sm font-bold">{step>0 && steps[step-1] && steps[step-1].col===i+1 && steps[step-1].carry>0 ? steps[step-1].carry : ''}</div>)}
                                <div className="col-span-full h-0.5 bg-slate-400 rounded"></div>
                                {Array(cols).fill(0).map((_,i) => { const s = steps.find(x=>x.col===i); const show = s && step>steps.indexOf(s); return <div key={'r'+i} className="flex justify-center text-green-600 font-bold text-2xl">{show ? s.res : ''}</div> })}
                            </div>
                        </div>
                        <button onClick={step>=steps.length ? onClose : ()=>setStep(s=>s+1)} className="w-full bg-blue-600 text-white py-3 rounded-xl text-lg shadow-lg active:scale-95 font-bold">
                            {step>=steps.length ? "Verstanden!" : "Weiter ‚ñ∂"}
                        </button>
                    </div>
                </div>
            );
        };

        const WrittenCalculator = ({ type, a, b, onCorrect }) => {
            const sA = a.toString().split('').map(Number); const sB = b.toString().split('').map(Number);
            const cols = Math.max(sA.length, sB.length) + 1;
            const [res, setRes] = useState(Array(cols).fill('')); const [carry, setCarry] = useState(Array(cols).fill(''));
            const [teacher, setTeacher] = useState(false);
            const handleInput = (arr, setArr, i, val) => { if(!/^\d*$/.test(val)) return; const n=[...arr]; n[i]=val.slice(-1); setArr(n); };
            const check = () => {
                const userRes = parseInt(res.join(''));
                if (userRes === (type === 'add' ? a + b : a - b)) onCorrect(); else { playSound('wrong'); alert("Noch nicht ganz richtig."); }
            };
            return (
                <div className="bg-white/90 p-6 rounded-xl border-4 border-blue-200 shadow-xl inline-block relative">
                    {teacher && <VisualTeacher type={type} a={a} b={b} onClose={()=>setTeacher(false)} />}
                    <button onClick={()=>setTeacher(true)} className="absolute -top-4 -right-4 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full font-bold shadow-lg border-2 border-yellow-200 z-10 text-sm flex gap-1 items-center hover:scale-110 transition">üí° Hilfe</button>
                    <div className="grid gap-1 justify-center mb-6" style={{gridTemplateColumns: `repeat(${cols}, 45px)`}}>
                        {type==='add' && carry.map((v,i) => <div key={'c'+i} className="flex justify-center items-end h-[30px]">{i<cols-1 && <input className="grid-cell carry" value={v} onChange={e=>handleInput(carry, setCarry, i, e.target.value)} placeholder="¬π"/>}</div>)}
                        {Array(cols).fill(0).map((_,i) => <div key={'a'+i} className="grid-cell readonly flex items-center justify-center text-2xl">{sA[sA.length-(cols-i)] ?? ''}</div>)}
                        {Array(cols).fill(0).map((_,i) => <div key={'b'+i} className="grid-cell readonly flex items-center justify-center text-2xl relative">{i===0 && <span className="absolute -left-6 font-bold text-slate-400 text-3xl">{type==='add'?'+':'-'}</span>}{sB[sB.length-(cols-i)] ?? ''}</div>)}
                        {type==='sub' && carry.map((v,i) => <div key={'c'+i} className="flex justify-center items-start h-[30px]">{i<cols-1 && <input className="grid-cell carry" value={v} onChange={e=>handleInput(carry, setCarry, i, e.target.value)} placeholder="1"/>}</div>)}
                        <div className="col-span-full h-1 bg-slate-800 rounded"></div>
                        {res.map((v,i) => <input key={'r'+i} className="grid-cell font-bold text-blue-600 border-2 border-blue-200" value={v} onChange={e=>handleInput(res, setRes, i, e.target.value)} />)}
                    </div>
                    <button onClick={check} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 text-xl">Pr√ºfen ‚úÖ</button>
                </div>
            );
        };
        
        const Clock = ({ h, m }) => {
            const mDeg = m * 6; const hDeg = h * 30 + m * 0.5;
            return (
                <div className="relative w-40 h-40 rounded-full border-8 border-slate-700 bg-white shadow-xl mx-auto my-4">
                    {[...Array(12)].map((_, i) => <div key={i} className="absolute w-1 h-3 bg-slate-400 left-1/2 top-1 origin-bottom transform -translate-x-1/2" style={{transform: `rotate(${i*30}deg) translateY(2px)`}}></div>)}
                    <div className="absolute w-1.5 h-12 bg-slate-800 left-1/2 top-1/2 origin-bottom transform -translate-x-1/2 -translate-y-full rounded-full" style={{transform: `translateX(-50%) rotate(${hDeg}deg) translateY(-50%)`}}></div>
                    <div className="absolute w-1 h-16 bg-red-500 left-1/2 top-1/2 origin-bottom transform -translate-x-1/2 -translate-y-full rounded-full" style={{transform: `translateX(-50%) rotate(${mDeg}deg) translateY(-50%)`}}></div>
                    <div className="absolute w-3 h-3 bg-slate-800 rounded-full left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                </div>
            );
        };
        
        const GeometryShape = ({ type }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const cvs = canvasRef.current; const ctx = cvs.getContext('2d');
                ctx.clearRect(0,0,200,200); ctx.lineWidth = 4; ctx.strokeStyle = '#3b82f6'; ctx.fillStyle = '#dbeafe';
                ctx.beginPath();
                if (type === 'quadrat') ctx.rect(50, 50, 100, 100); else if (type === 'rechteck') ctx.rect(30, 60, 140, 80); else if (type === 'kreis') ctx.arc(100, 100, 60, 0, 2*Math.PI); else if (type === 'dreieck') { ctx.moveTo(100, 40); ctx.lineTo(160, 150); ctx.lineTo(40, 150); ctx.closePath(); } else if (type === 'winkel') { ctx.moveTo(150, 50); ctx.lineTo(50, 50); ctx.lineTo(50, 150); ctx.moveTo(50, 70); ctx.lineTo(70, 70); ctx.lineTo(70, 50); ctx.stroke(); ctx.beginPath(); ctx.arc(60, 60, 2, 0, 2*Math.PI); ctx.fill(); return; }
                ctx.fill(); ctx.stroke();
            }, [type]);
            return <canvas ref={canvasRef} width={200} height={200} className="mx-auto drop-shadow-md" />;
        };

        // --- MAIN APP ---
        const App = () => {
            const [user, setUser] = useState({name:'Gast', coins:0, xp:0, level:1, avatar:'bear', theme:'default', stats:{total:0, correct:0, earned:0}, unlockedAvatars:['bear']});
            const [view, setView] = useState('menu');
            const [problem, setProblem] = useState(null);
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState(null);

            useEffect(() => { 
                const s = localStorage.getItem('math_v13'); 
                if(s) setUser(JSON.parse(s)); 
            }, []);
            
            const save = (u) => { setUser(u); localStorage.setItem('math_v13', JSON.stringify(u)); };

            const updateProgress = (correct, topic) => {
                const u = { ...user, stats: {...user.stats, total: user.stats.total+1} };
                if(correct) { 
                    const reward = 15 + Math.floor(u.level * 0.5); // Skalierung
                    u.coins+=reward; u.xp+=20; u.stats.correct++; u.stats.earned+=reward;
                    if(topic) u.mastery = {...u.mastery, [topic]: (u.mastery?.[topic]||0)+1};
                    if(u.xp >= LEVELS[u.level]) { u.level++; alert("LEVEL UP! üéâ"); }
                    if(window.confetti) window.confetti();
                } else u.coins+=2;
                save(u);
            };

            const startProblem = (t) => {
                const r = randomInt; let p = { topic: t };
                
                // GENERATOR
                if(t==='add') { const a=r(100,50000); const b=r(100,40000); p={...p, q:`${formatCH(a)} + ${formatCH(b)}`, type:'written', op:'add', a, b}; }
                else if(t==='sub') { const a=r(1000,90000); const b=r(100,a-100); p={...p, q:`${formatCH(a)} - ${formatCH(b)}`, type:'written', op:'sub', a, b}; }
                else if(t==='mul') { const a=r(2,9); const b=r(100,2000); p={...p, q:`${a} ¬∑ ${b}`, a:a*b, type:'calc', hint:`Zerlege: ${a} ¬∑ ${Math.floor(b/100)*100} ...`}; }
                else if(t==='div') { const d=r(2,9); const res=r(10,200); p={...p, q:`${d*res} : ${d}`, a:res, type:'calc', hint:`Zerlege die Zahl.`}; }
                else if(t==='money') { const p1=(r(1, 50) + r(0,9)*0.10).toFixed(2); const g=Math.ceil(p1/10)*10; p={...p, q:`Preis: Fr. ${p1}. Gegeben: Fr. ${g}.00`, a:(g-p1).toFixed(2), type:'calc', unit:'Fr.', hint:"Erg√§nzen!"}; }
                else if(t==='weight') { const m=r(1,2); if(m===1){const t=r(1,10); p={...p, q:`${t} t = ... kg`, a:t*1000, type:'calc', unit:'kg'};} else{const k=r(1,10); p={...p, q:`${k} kg = ... g`, a:k*1000, type:'calc', unit:'g'};} }
                else if(t==='len') { const m=r(1,3); if(m===1){const k=r(1,10); p={...p, q:`${k} km = ... m`, a:k*1000, type:'calc', unit:'m'};} else{const c=r(10,200); p={...p, q:`${c} cm = ... mm`, a:c*10, type:'calc', unit:'mm'};} }
                else if(t==='liq') { const m=r(1,3); if(m===1){const l=r(1,10); p={...p, q:`${l} l = ... dl`, a:l*10, type:'calc', unit:'dl'};} else{const l=r(1,5); p={...p, q:`${l} l = ... ml`, a:l*1000, type:'calc', unit:'ml'};} }
                else if(t==='time') { const h=r(1,11); const min=r(0,11)*5; p={...p, q:<Clock h={h} m={min}/>, text:"Wie sp√§t ist es?", a:`${h}:${min.toString().padStart(2,'0')}`, type:'time', hint:"Digital h:mm"}; }
                else if(t==='geo') { const shapes = ['quadrat','rechteck','kreis','dreieck','winkel']; const s = shapes[r(0,4)]; p={...p, type:'geo', target:s, q:"Welche Form ist das?", opts:[...shapes.filter(x=>x!==s).sort(()=>Math.random()-0.5).slice(0,3), s].sort(()=>Math.random()-0.5)}; }
                
                setProblem(p); setView('game'); setInput(''); setFeedback(null);
            };

            const handleSuccess = () => { setFeedback('correct'); updateProgress(true, problem.topic); playSound('correct'); };
            const checkSimple = (val) => {
                const userVal = val ? val : input.replace(',','.');
                const sol = problem.a ? problem.a.toString() : problem.target;
                let correct = false;
                if (problem.type === 'time') { if (userVal == sol || userVal == '0'+sol) correct = true; }
                else if (userVal.toLowerCase() == sol.toLowerCase()) correct = true;

                if (correct) { handleSuccess(); }
                else { setFeedback('wrong'); playSound('wrong'); updateProgress(false, problem.topic); }
            };

            const Stars = ({t}) => { const m = (user.mastery && user.mastery[t]) || 0; return <div className="flex text-xs gap-0.5">{[...Array(3)].map((_,i)=><i key={i} className={`fa-solid fa-star ${i<(m>30?3:m>10?2:m>2?1:0)?'text-yellow-400':'text-slate-300'}`}></i>)}</div>; };

            if(view==='menu') return (
                <div className="p-4 max-w-3xl mx-auto pb-20">
                    <header className="glass-panel p-4 mb-8 flex justify-between items-center bg-white rounded-2xl shadow">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={()=>setView('profile')}>
                            <div className="text-5xl bg-blue-50 p-2 rounded-2xl shadow-sm">{AVATARS.find(a=>a.id===user.avatar)?.icon}</div>
                            <div>
                                <div className="font-black text-xl text-slate-800">{user.name}</div>
                                <div className="text-sm text-slate-500 font-bold">Level {user.level}</div>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <a href="index.html" className="bg-slate-100 text-slate-500 px-4 py-3 rounded-xl font-bold hover:bg-slate-200 transition flex items-center gap-2"><i className="fa-solid fa-house"></i></a>
                            <button onClick={()=>setView('shop')} className="bg-yellow-100 text-yellow-800 px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-sm hover:scale-105 transition"><span>{user.coins}</span> üí∞</button>
                        </div>
                    </header>
                    
                    <div className="space-y-8">
                        <section>
                            <h2 className="font-black text-slate-400 text-sm uppercase tracking-widest mb-4 ml-2">Grundrechenarten</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {[{id:'add',n:'Schriftlich Plus',sub:'Bis 100k',c:'blue'},{id:'sub',n:'Schriftlich Minus',sub:'Erg√§nzen',c:'red'},{id:'mul',n:'Mal-Rechnen',sub:'Halbschriftlich',c:'purple'},{id:'div',n:'Geteilt-Rechnen',sub:'Zerlegen',c:'pink'}].map(x=>(
                                    <button key={x.id} onClick={()=>startProblem(x.id)} className={`glass-panel p-5 text-left flex justify-between items-center hover:scale-[1.02] transition bg-white rounded-xl shadow-sm border-l-8 border-${x.c}-500`}>
                                        <div><div className={`font-bold text-lg text-slate-700 group-hover:text-${x.c}-600`}>{x.n}</div><div className="text-sm text-slate-400">{x.sub}</div></div>
                                        <Stars t={x.id}/>
                                    </button>
                                ))}
                            </div>
                        </section>

                        <section>
                            <h2 className="font-black text-slate-400 text-sm uppercase tracking-widest mb-4 ml-2">Gr√∂ssen & Sachrechnen</h2>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                {[{id:'money',n:'Geld',i:'üí∞'},{id:'len',n:'L√§ngen',i:'üìè'},{id:'weight',n:'Gewicht',i:'‚öñÔ∏è'},{id:'liq',n:'Hohlmasse',i:'ü•õ'},{id:'time',n:'Zeit',i:'‚è±Ô∏è'},{id:'geo',n:'Geometrie',i:'üìê'}].map(x=>(
                                    <button key={x.id} onClick={()=>startProblem(x.id)} className="glass-panel p-4 text-center hover:scale-105 transition bg-white rounded-xl shadow-sm"><div className="text-3xl mb-2">{x.i}</div><div className="font-bold text-slate-700">{x.n}</div></button>
                                ))}
                            </div>
                        </section>
                    </div>
                </div>
            );

            if (view === 'shop') return (
                <div className="min-h-screen bg-yellow-50 p-4">
                    <div className="max-w-3xl mx-auto">
                        <div className="flex justify-between items-center mb-8"><button onClick={()=>setView('menu')} className="bg-white px-4 py-2 rounded-xl font-bold text-slate-600 shadow-sm">‚óÄ Zur√ºck</button><div className="font-black text-2xl text-yellow-600 bg-white px-6 py-2 rounded-xl shadow-sm">{user.coins} üí∞</div></div>
                        <h1 className="text-4xl font-black text-slate-800 mb-8 text-center">Avatar Shop</h1>
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            {AVATARS.map(a => {
                                const owned = (user.unlockedAvatars || ['bear']).includes(a.id);
                                const selected = user.avatar === a.id;
                                return <button key={a.id} disabled={!owned && user.coins<a.cost} onClick={()=>{ if(!owned) { save({...user, coins:user.coins-a.cost, unlockedAvatars:[...(user.unlockedAvatars||['bear']), a.id], avatar:a.id}); playSound('cash'); safeConfetti(); } else save({...user, avatar:a.id}); }} className={`bg-white p-6 rounded-3xl flex flex-col items-center shadow-sm item-card border-4 ${selected ? 'border-green-400 bg-green-50' : `rarity-${a.rarity}`} ${!owned && user.coins<a.cost ? 'opacity-50 grayscale' : ''}`}><div className="text-6xl mb-4">{a.icon}</div><div className="font-bold text-lg text-slate-700">{a.name}</div><div className={`font-bold text-sm mt-2 px-3 py-1 rounded-full ${owned ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'}`}>{owned ? 'Besitz' : `${a.cost} üí∞`}</div></button>
                            })}
                        </div>
                    </div>
                </div>
            );

            if (view === 'profile') return (
                <div className="min-h-screen bg-slate-100 p-4 flex items-center justify-center">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
                        <h2 className="text-3xl font-black text-slate-800 mb-6">Statistik</h2>
                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="bg-blue-50 p-4 rounded-2xl"><div className="text-3xl font-bold text-blue-600">{user.stats?.total || 0}</div><div className="text-xs text-slate-500 uppercase font-bold">Gel√∂st</div></div>
                            <div className="bg-green-50 p-4 rounded-2xl"><div className="text-3xl font-bold text-green-600">{user.stats?.earned || 0}</div><div className="text-xs text-slate-500 uppercase font-bold">Verdient</div></div>
                        </div>
                        <h3 className="font-bold text-slate-400 mb-4 uppercase text-sm">Troph√§en Sammlung</h3>
                        <div className="flex gap-2 justify-center flex-wrap mb-8">
                             {(user.stats?.total > 10) && <span className="text-4xl" title="Anf√§nger">ü•â</span>}
                             {(user.stats?.total > 50) && <span className="text-4xl" title="Fleissig">ü•à</span>}
                             {(user.stats?.total > 100) && <span className="text-4xl" title="Profi">ü•á</span>}
                             {(user.stats?.total > 500) && <span className="text-4xl" title="Legende">üèÜ</span>}
                             {(!user.stats?.total || user.stats.total <= 10) && <span className="text-slate-300 italic text-sm">L√∂se mehr Aufgaben...</span>}
                        </div>
                        <button onClick={()=>setView('menu')} className="btn-primary w-full py-3 rounded-xl shadow-lg">Cool!</button>
                    </div>
                </div>
            );

            if (view === 'game') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-lg glass-panel p-6 relative pop-in bg-white rounded-3xl">
                        <button onClick={()=>setView('menu')} className="absolute top-4 left-4 text-slate-400 hover:text-slate-600 font-bold text-xl w-10 h-10 bg-slate-100 rounded-full shadow-sm flex items-center justify-center">‚úï</button>
                        {!feedback && (problem.type === 'calc' || problem.type === 'time' || problem.type === 'written') ? <button onClick={()=>{ if(problem.hint) alert(problem.hint); }} className="absolute top-4 right-4 text-yellow-600 hover:text-yellow-700 font-bold bg-yellow-100 px-4 py-2 rounded-full shadow-sm flex items-center gap-2"><i className="fa-solid fa-lightbulb"></i> Tipp</button> : null}
                        {feedback ? (
                            <div className="pop-in text-center py-8">
                                {feedback === 'correct' ? <div><div className="text-8xl mb-4 animate-bounce">üèÜ</div><h2 className="text-4xl font-black text-slate-800 mb-2">Fantastisch!</h2><p className="text-slate-500 mb-8 font-bold">+15 M√ºnzen</p><button onClick={()=>startProblem(problem.topic)} className="bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold text-xl shadow-xl hover:shadow-2xl w-full transition transform hover:scale-105">N√§chste Aufgabe ‚ûú</button></div> : <div><div className="text-8xl mb-4">üßê</div><h2 className="text-3xl font-black text-slate-800 mb-2">Knapp daneben</h2><p className="text-slate-500 mb-8">Versuch es noch einmal!</p><button onClick={()=>{setFeedback(null);setInput('')}} className="bg-slate-200 text-slate-600 font-bold px-8 py-3 rounded-xl w-full hover:bg-slate-300">Nochmal probieren</button></div>}
                            </div>
                        ) : (
                            problem.type === 'written' ? <div className="text-center mt-8"><h2 className="text-slate-400 font-bold text-sm uppercase tracking-widest mb-4">Schriftliches Rechnen</h2><WrittenCalculator type={problem.op} a={problem.a} b={problem.b} onCorrect={handleWrittenSuccess} /></div> : 
                            <div className="text-center mt-10">
                                {problem.type === 'geo' && <GeometryShape type={problem.target} />}
                                <h2 className="text-slate-400 font-bold text-sm uppercase tracking-widest mb-2">Deine Aufgabe</h2>
                                <div className="text-4xl md:text-5xl font-black text-slate-800 mb-8">{problem.q}</div>
                                {problem.text && <p className="mb-8 text-lg text-slate-500 font-medium bg-slate-50 p-4 rounded-xl border border-slate-100">{problem.text}</p>}
                                {problem.opts ? <div className="grid grid-cols-1 gap-3">{problem.opts.map(o => <button key={o} onClick={()=>checkSimple(o)} className="bg-white text-blue-600 font-bold text-lg py-4 rounded-xl border-2 border-blue-100 hover:border-blue-500 hover:shadow-md transition capitalize">{o}</button>)}</div> : <div className="flex flex-col gap-4"><div className="flex gap-2 justify-center"><input value={input} onChange={e=>setInput(e.target.value)} className="text-center text-3xl p-4 border-4 border-blue-100 rounded-2xl outline-none focus:border-blue-500 w-full font-bold text-slate-700" autoFocus type="text" placeholder="?" />{problem.unit && <span className="flex items-center font-bold text-slate-400 text-2xl">{problem.unit}</span>}</div><button onClick={()=>checkSimple()} className="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 text-xl hover:bg-blue-700 transition">Pr√ºfen</button></div>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>