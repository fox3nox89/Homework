<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenten Mission 6.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&family=Roboto:wght@400;700&display=swap');
        
        body { 
            background-color: #000500; 
            color: #4ade80; 
            font-family: 'Roboto', sans-serif; 
            /* WICHTIG: Scrollen erlaubt! */
            min-height: 100vh;
            overflow-y: auto; 
            user-select: none;
        }
        
        .font-tech { font-family: 'Black Ops One', cursive; }
        .font-code { font-family: 'Share Tech Mono', monospace; }

        /* HINTERGRUND */
        .matrix-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #001a00 0%, #000000 100%);
        }
        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: 
                linear-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
        }

        /* RADAR MAP */
        .radar-container {
            position: relative;
            background: radial-gradient(circle, rgba(0,20,0,0.9) 0%, rgba(0,0,0,1) 100%);
            border: 2px solid #15803d;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(21, 128, 61, 0.5), inset 0 0 30px rgba(0,0,0,0.8);
            overflow: hidden;
            margin: 0 auto; /* Zentriert */
        }
        .radar-grid {
            position: absolute; inset: 0;
            background-image: radial-gradient(transparent 65%, rgba(0, 255, 0, 0.2) 70%),
                              linear-gradient(0deg, transparent 49%, rgba(0, 255, 0, 0.2) 50%, transparent 51%),
                              linear-gradient(90deg, transparent 49%, rgba(0, 255, 0, 0.2) 50%, transparent 51%);
            background-size: 100% 100%, 100% 100%, 100% 100%;
            border-radius: 50%;
        }
        .radar-sweep {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(34, 197, 94, 0.4) 360deg);
            border-radius: 50%;
            animation: sweep 4s linear infinite;
            opacity: 0.5;
        }
        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .map-node {
            position: absolute; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; transition: all 0.5s;
        }
        .node-icon {
            width: 24px; height: 24px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            background: #000; border: 1px solid #4ade80; color: #4ade80; font-size: 12px;
        }
        .node-active .node-icon { background: #22c55e; color: black; box-shadow: 0 0 15px #22c55e; transform: scale(1.3); }
        .node-visited .node-icon { background: #064e3b; border-color: #065f46; color: #34d399; }

        /* BUTTONS */
        .cyber-btn {
            background: rgba(0, 30, 0, 0.8);
            border: 1px solid #22c55e; color: #4ade80;
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .cyber-btn:hover { background: #22c55e; color: black; box-shadow: 0 0 20px #22c55e; }
        .cyber-btn:active { transform: scale(0.98); }
        
        .hack-btn {
            background: rgba(50, 0, 0, 0.8); border: 1px solid #ef4444; color: #fca5a5;
            animation: pulse-red 2s infinite;
        }
        .hack-btn:hover { background: #ef4444; color: white; box-shadow: 0 0 20px #ef4444; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* TYPEWRITER */
        .typing::after { content: '‚ñà'; animation: blink 1s infinite; color: #22c55e; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* UI BARS */
        .shield-bar { transition: width 0.5s ease; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen relative p-4">
    <div class="matrix-bg"></div>
    <div class="grid-overlay"></div>

    <div id="root" class="w-full max-w-6xl relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- AUDIO ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'click') {
                osc.type = 'triangle'; osc.frequency.value = 800; gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'hack') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3);
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                osc.start(now); osc.stop(now + 0.6);
            } else if (type === 'error') {
                osc.type = 'square'; osc.frequency.value = 150; gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
        };

        // --- MAP DATA ---
        const NODES = {
            home: { x: 15, y: 85, icon: "fa-house" },
            bus: { x: 35, y: 85, icon: "fa-bus" },
            school_gate: { x: 50, y: 70, icon: "fa-torii-gate" },
            gym: { x: 30, y: 60, icon: "fa-basketball" },
            hallway: { x: 50, y: 50, icon: "fa-route" },
            lab: { x: 20, y: 40, icon: "fa-flask" },
            archive: { x: 80, y: 40, icon: "fa-book" },
            office: { x: 50, y: 20, icon: "fa-server" }
        };

        const CONNECTIONS = [
            ['home', 'bus'], ['bus', 'school_gate'], ['school_gate', 'gym'], 
            ['gym', 'hallway'], ['school_gate', 'hallway'], ['hallway', 'lab'], 
            ['hallway', 'archive'], ['hallway', 'office'], ['lab', 'office'], ['archive', 'office']
        ];

        // --- STORY ---
        const STORY = {
            start: {
                title: "MISSION START",
                loc: "home",
                text: ["Agent! Griesgram plant etwas.", "Es ist 19:45 Uhr.", "Der Bus f√§hrt 20:15 Uhr.", "Minuten bis Abfahrt?"],
                input: "30",
                next: "bus_ride",
                fail: "Falsch. (15 bis 20:00 + 15)"
            },
            bus_ride: {
                title: "BUSFAHRT",
                loc: "bus",
                text: ["Du findest einen Code-Zettel.", "'Das Doppelte von 450'." , "Eingabe:"],
                input: "900",
                next: "school_gate",
                fail: "Zugriff verweigert. (450 + 450)"
            },
            school_gate: {
                title: "SCHULTOR",
                loc: "school_gate",
                text: ["Tor offen. Welcher Weg?", "Turnhalle (Geometrie)?", "Haupteingang (Schleichen)?"],
                choices: [
                    { txt: "Turnhalle", next: "gym_entry" },
                    { txt: "Haupteingang", next: "hallway_sneak" }
                ]
            },
            gym_entry: {
                title: "TURNHALLE",
                loc: "gym",
                text: ["Roboter-Wache!", "Frage: 'Form des Mittelkreises?'"],
                choices: [
                    { txt: "Quadrat", next: "alarm_soft" },
                    { txt: "Kreis", next: "hallway_sneak" },
                    { txt: "Dreieck", next: "alarm_soft" }
                ]
            },
            alarm_soft: {
                title: "ALARM!",
                loc: "gym",
                text: ["Roboter sieht dich!", "Flucht ergriffen!"],
                choices: [{ txt: "Zur√ºck", next: "gym_entry" }]
            },
            hallway_sneak: {
                title: "HAUPTFLUR",
                loc: "hallway",
                text: ["Du bist drin. Dunkel.", "Sammle 2 Items:", "1. ENERGIE-KRISTALL", "2. CODE-KARTE"],
                choices: [
                    { txt: "Zum Labor", next: "lab_door" },
                    { txt: "Zum Archiv", next: "archive_door" },
                    { txt: "Zur Zentrale", next: "office_gate" }
                ]
            },
            lab_door: {
                title: "LABOR T√úR",
                loc: "lab",
                text: ["Gewichts-Scanner.", "Was ist schwerer?", "1 Tonne oder 1000 kg?"],
                choices: [
                    { txt: "1 Tonne", next: "lab_fail" },
                    { txt: "1000 kg", next: "lab_fail" },
                    { txt: "Gleich schwer", next: "lab_inside" }
                ]
            },
            lab_fail: {
                title: "FEHLER",
                loc: "lab",
                text: ["Nein! 1 Tonne = 1000 kg.", "Sperre aktiv."],
                choices: [{ txt: "Nochmal", next: "lab_door" }]
            },
            lab_inside: {
                title: "IM LABOR",
                loc: "lab",
                text: ["Du findest den blauen Kristall.", "> ITEM: KRISTALL"],
                item: "Kristall",
                choices: [{ txt: "Zur√ºck zum Flur", next: "hallway_sneak" }]
            },
            archive_door: {
                title: "ARCHIV T√úR",
                loc: "archive",
                text: ["Laser-Gitter.", "3m 50cm in cm?"],
                input: "350",
                next: "archive_inside",
                fail: "Alarm! (1m = 100cm)"
            },
            archive_inside: {
                title: "IM ARCHIV",
                loc: "archive",
                text: ["Du findest die Code-Karte.", "> ITEM: KARTE"],
                item: "Karte",
                choices: [{ txt: "Zur√ºck zum Flur", next: "hallway_sneak" }]
            },
            office_gate: {
                title: "ZENTRALE T√úR",
                loc: "office",
                text: ["Panzert√ºr.", "Scanner pr√ºft Inventar..."],
                check: ["Kristall", "Karte"],
                next: "final_puzzle",
                failNext: "hallway_sneak"
            },
            final_puzzle: {
                title: "PASSWORT",
                loc: "office",
                text: ["T√ºr offen. Computer gesperrt.", "√úbersetze 'GAGNER'", "(Deutsch):"],
                input: "gewinnen",
                next: "win",
                fail: "Falsch."
            },
            win: {
                title: "MISSION ERF√úLLT",
                loc: "office",
                text: ["ZUGRIFF ERLAUBT!", "Griesgram gratuliert dir.", "Du bist jetzt Profi-Agent!", "GL√úCKWUNSCH!"],
                choices: [{ txt: "Neue Mission", next: "start" }]
            }
        };

        // --- COMPONENTS ---

        const RadarMap = ({ currentLoc, visited }) => {
            return (
                <div className="w-full flex items-center justify-center p-2 mb-4">
                    <div className="radar-container w-48 h-48 relative">
                        <div className="radar-grid"></div>
                        <div className="radar-sweep"></div>
                        
                        <svg className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-30">
                            {CONNECTIONS.map(([s, e], i) => {
                                const n1 = NODES[s]; const n2 = NODES[e];
                                return <line key={i} x1={`${n1.x}%`} y1={`${n1.y}%`} x2={`${n2.x}%`} y2={`${n2.y}%`} stroke="#4ade80" strokeWidth="1" />
                            })}
                        </svg>

                        {Object.entries(NODES).map(([key, data]) => {
                            const isActive = key === currentLoc;
                            const isVisited = visited.includes(key);
                            
                            return (
                                <div key={key} className={`map-node ${isActive ? 'node-active' : isVisited ? 'node-visited' : 'opacity-30'}`} style={{left: `${data.x}%`, top: `${data.y}%`}}>
                                    <div className={`node-icon ${isActive ? 'text-black' : ''}`}>
                                        <i className={`fa-solid ${data.icon}`}></i>
                                    </div>
                                    {isActive && <div className="absolute -top-5 text-[10px] text-green-400 font-mono bg-black px-1 z-30">{data.name}</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Typewriter = ({ text, onComplete }) => {
            const [lines, setLines] = useState([]);
            const [idx, setIdx] = useState(0);
            const [char, setChar] = useState(0);

            useEffect(() => { setLines([]); setIdx(0); setChar(0); }, [text]);

            useEffect(() => {
                if (idx < text.length) {
                    const line = text[idx];
                    if (char < line.length) {
                        const t = setTimeout(() => {
                            setChar(c => c + 1);
                            if (char % 4 === 0) playSound('click');
                        }, 20);
                        return () => clearTimeout(t);
                    } else {
                        const t = setTimeout(() => {
                            setLines(p => [...p, line]); setIdx(i => i + 1); setChar(0);
                        }, 300);
                        return () => clearTimeout(t);
                    }
                } else { onComplete(); }
            }, [char, idx, text, onComplete]);

            return (
                <div className="space-y-2 font-mono text-lg">
                    {lines.map((l, i) => <p key={i} className="text-green-400">{l}</p>)}
                    {idx < text.length && <p className="text-green-400 typing">{text[idx].slice(0, char)}</p>}
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [sceneId, setSceneId] = useState('start');
            const [inv, setInv] = useState([]);
            const [input, setInput] = useState('');
            const [ready, setReady] = useState(false);
            const [shield, setShield] = useState(100);
            const [visited, setVisited] = useState(['home']);

            const s = STORY[sceneId];

            useEffect(() => {
                if (s.item && !inv.includes(s.item)) {
                    setInv(prev => [...prev, s.item]);
                    playSound('success');
                }
                if (s.loc && !visited.includes(s.loc)) setVisited([...visited, s.loc]);
                if (sceneId === 'start') { setInv([]); setShield(100); setVisited(['home']); }
                setReady(false); setInput('');
            }, [sceneId]);

            const handleChoice = (next) => { playSound('success'); setSceneId(next); };

            const handleInput = () => {
                if (input.toLowerCase().trim() === s.input.toLowerCase()) {
                    playSound('success');
                    if(s.next === 'win') window.confetti();
                    setSceneId(s.next);
                } else {
                    playSound('error'); setShield(sh => Math.max(0, sh - 10));
                    alert(s.fail); setInput('');
                }
            };

            const hackSystem = () => {
                if (shield <= 20) { alert("WARNUNG: Schild zu schwach f√ºr Hack!"); return; }
                if (!s.input) return;
                playSound('hack');
                setShield(sh => sh - 25);
                setInput(s.input);
            };

            const checkItems = () => {
                const missing = s.check.find(i => !inv.includes(i));
                if (missing) { playSound('error'); alert(`Dir fehlt: ${missing}`); setSceneId(s.failNext); }
                else { playSound('success'); setSceneId(s.next); }
            };

            return (
                <div className="w-full flex flex-col md:flex-row gap-4 p-4 max-w-7xl mx-auto">
                    
                    {/* LEFT: GAME SCREEN */}
                    <div className="flex-1 flex flex-col bg-slate-900 border-2 border-green-800 rounded-xl overflow-hidden shadow-2xl relative min-h-[500px]">
                        
                        {/* HEADER */}
                        <div className="bg-slate-950 p-4 border-b border-green-900 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <div>
                                    <h1 className="font-tech text-xl text-green-400 tracking-widest">AGENT 007</h1>
                                    <div className="text-xs text-green-700">SCHILD: {shield}%</div>
                                </div>
                            </div>
                            <a href="index.html" className="cyber-btn px-4 py-1 text-xs font-bold rounded uppercase hover:text-black decoration-0">üè† Zentrale</a>
                        </div>

                        {/* CONTENT */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            <h2 className="text-xl font-bold text-white mb-4 font-tech border-l-4 border-green-500 pl-3">{s.title}</h2>
                            <Typewriter text={s.text} onComplete={() => setReady(true)} />
                        </div>

                        {/* ACTIONS */}
                        <div className={`p-4 bg-slate-950 border-t border-green-900 transition-opacity duration-500 ${ready ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                            {s.input && (
                                <div className="flex flex-col gap-2">
                                    <div className="flex gap-2">
                                        <input 
                                            value={input} onChange={e=>setInput(e.target.value)} 
                                            onKeyDown={e=>e.key==='Enter'&&handleInput()}
                                            className="flex-1 bg-black border border-green-500 p-3 text-green-400 font-code text-lg focus:outline-none placeholder-green-900"
                                            placeholder="CODE..." autoFocus
                                        />
                                        <button onClick={handleInput} className="cyber-btn px-6 font-bold">OK</button>
                                    </div>
                                    <button onClick={hackSystem} className="hack-btn w-full py-2 rounded font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2">
                                        ‚ö° SYSTEM HACKEN (-25% Schild)
                                    </button>
                                </div>
                            )}
                            {s.choices && <div className="grid gap-2">{s.choices.map((c,i)=><button key={i} onClick={()=>handleChoice(c.next)} className="cyber-btn w-full p-3 text-left font-bold hover:bg-green-900 transition">{c.txt}</button>)}</div>}
                            {s.check && <button onClick={checkItems} className="cyber-btn w-full p-4 font-bold animate-pulse">[ SCANNER STARTEN ]</button>}
                        </div>
                    </div>

                    {/* RIGHT: SIDEBAR (Map & Inv) */}
                    <div className="w-full md:w-80 flex flex-col gap-4">
                        <div className="bg-slate-900 border border-green-900 rounded-xl p-2 shadow-lg">
                            <RadarMap currentLoc={s.loc} visited={visited} />
                        </div>
                        
                        <div className="bg-slate-900 border border-green-900 rounded-xl p-4 flex-1">
                            <h3 className="text-green-600 font-tech text-center mb-4 tracking-widest text-sm border-b border-green-900 pb-2">RUCKSACK</h3>
                            <div className="space-y-2">
                                {[{id:'lupe',n:'UV-Lupe',i:'üîç'},{id:'plan',n:'Bauplan',i:'üó∫Ô∏è'},{id:'key',n:'Schl√ºssel',i:'üîë'},{id:'Kristall',n:'Kristall',i:'üíé'},{id:'Karte',n:'Code-Karte',i:'üí≥'}].map(item => {
                                    const has = inv.includes(item.id);
                                    return (
                                        <div key={item.id} className={`flex items-center gap-3 p-3 rounded border transition-all ${has ? 'border-green-500 bg-green-900/20 text-green-300 shadow-[0_0_10px_rgba(34,197,94,0.2)]' : 'border-slate-800 bg-black/40 text-slate-700 opacity-50'}`}>
                                            <div className="text-xl w-8 text-center">{has ? item.i : 'üîí'}</div>
                                            <div className="font-code font-bold text-sm">{item.n}</div>
                                            {has && <div className="ml-auto text-green-500 animate-bounce">üëç</div>}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>