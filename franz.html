<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Infinity Final</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;900&display=swap');
        
        :root { --bg-color: #eef2ff; --primary: #4f46e5; --text: #312e81; --card-bg: #ffffff; }
        
        /* THEMES */
        .theme-dark { --bg-color: #0f172a; --primary: #818cf8; --text: #f1f5f9; --card-bg: #1e293b; }
        .theme-pink { --bg-color: #fdf2f8; --primary: #db2777; --text: #831843; --card-bg: #fff1f2; }
        .theme-green { --bg-color: #f0fdf4; --primary: #16a34a; --text: #14532d; --card-bg: #dcfce7; }
        .theme-gold { --bg-color: #fffbeb; --primary: #d97706; --text: #78350f; --card-bg: #fef3c7; }
        
        body { 
            font-family: 'Fredoka', sans-serif; background-color: var(--bg-color); color: var(--text); 
            user-select: none; -webkit-tap-highlight-color: transparent; transition: background-color 0.5s, color 0.5s;
        }
        .nunito { font-family: 'Nunito', sans-serif; }
        
        /* FLIP CARD (Memory) */
        .scene { perspective: 600px; height: 100px; cursor: pointer; }
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.4s; transform-style: preserve-3d; }
        .card.is-flipped { transform: rotateY(180deg); }
        .card.is-matched { opacity: 0; pointer-events: none; transition: opacity 0.5s 0.5s; }
        .card__face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid white; }
        .card__face--front { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-size: 2rem; border: 4px solid white; }
        .card__face--back { background: white; transform: rotateY(180deg); font-weight: bold; font-size: 1rem; padding: 5px; text-align: center; }
        
        /* VERBINDEN KARTEN */
        .word-card {
            border-radius: 16px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 1.1rem; font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); cursor: pointer; transition: all 0.15s;
            min-height: 70px; position: relative; overflow: hidden; background-color: var(--card-bg); border: 3px solid transparent;
        }
        .word-card:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
        .word-card.matched { transform: scale(0); opacity: 0; pointer-events: none; transition: all 0.5s; }
        
        /* FARBEN */
        .card-fr { border-color: #3b82f6; color: #1e40af; background: #eff6ff; }
        .theme-dark .card-fr { background: #172554; border-color: #3b82f6; color: #bfdbfe; }
        .card-fr.selected { background: #3b82f6 !important; color: white !important; }
        
        .card-de { border-color: #f97316; color: #9a3412; background: #fff7ed; }
        .theme-dark .card-de { background: #431407; border-color: #f97316; color: #fed7aa; }
        .card-de.selected { background: #f97316 !important; color: white !important; }

        .card-fr .card__face--back { border: 3px solid #3b82f6; color: #1e40af; background: #eff6ff; }
        .card-de .card__face--back { border: 3px solid #f97316; color: #9a3412; background: #fff7ed; }

        /* AVATAR SAMMLUNG */
        .avatar-slot { aspect-ratio: 1; border-radius: 16px; background: white; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; position: relative; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .avatar-slot.locked { filter: grayscale(100%) opacity(0.4); background: #cbd5e1; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        .avatar-slot.unlocked { cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .avatar-slot.equipped { border-color: #22c55e; background: #f0fdf4; box-shadow: 0 0 0 4px #bbf7d0; }
        .rarity-common { border-bottom: 4px solid #94a3b8; }
        .rarity-rare { border-bottom: 4px solid #3b82f6; }
        .rarity-epic { border-bottom: 4px solid #a855f7; }
        .rarity-legendary { border-bottom: 4px solid #eab308; background: linear-gradient(135deg, #fffbeb, #fef3c7); }

        /* INPUTS */
        .input-field { width: 100%; padding: 1rem; text-align: center; font-size: 1.5rem; border: 4px solid #e2e8f0; border-radius: 16px; outline: none; background: var(--card-bg); color: var(--text); transition: all 0.3s; }
        .input-field:focus { border-color: var(--primary); }
        .input-field.error { border-color: #ef4444; background-color: #fef2f2; animation: shake 0.4s; }
        .input-field.success { border-color: #22c55e; background-color: #f0fdf4; }

        /* ANIMATIONS */
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .shake-box { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .xp-bar { transition: width 1s ease-out; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
    </style>
</head>
<body class="min-h-screen pb-20">
    
    <div id="loading">
        <div class="text-6xl mb-4 animate-bounce">üá´üá∑</div>
        <div class="text-xl font-bold text-teal-600">Lade Vokabeln...</div>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        setTimeout(() => { const l = document.getElementById('loading'); if(l) l.style.display = 'none'; }, 1000);

        const { useState, useEffect, useRef } = React;

        const LEVELS = [0, 100, 300, 600, 1000, 1500, 2200, 3000, 4000, 5000, 10000];
        const RANKS = ["Sch√ºler", "Entdecker", "Profi", "Meister", "Champion", "Legende"];

        // AVATAR LISTE
        const AVATARS = [
            { id: 'bear', icon: 'üêª', name: 'Bruno', rarity: 'common' },
            { id: 'cat', icon: 'üê±', name: 'Mimi', rarity: 'common' },
            { id: 'fox', icon: 'ü¶ä', name: 'Foxy', rarity: 'rare' },
            { id: 'lion', icon: 'ü¶Å', name: 'Leo', rarity: 'rare' },
            { id: 'robot', icon: 'ü§ñ', name: 'Robo', rarity: 'epic' },
            { id: 'alien', icon: 'üëΩ', name: 'Zorg', rarity: 'epic' },
            { id: 'dragon', icon: 'üê≤', name: 'Drago', rarity: 'legendary' },
            { id: 'king', icon: 'üëë', name: 'King', rarity: 'legendary' }
        ];

        const PACKS = [
            { id: 'basic', name: 'Starter Box', cost: 100, emoji: 'üì¶', prob: { common: 70, rare: 29, epic: 1, legendary: 0 } },
            { id: 'gold', name: 'Gold Box', cost: 500, emoji: 'üéÅ', prob: { common: 20, rare: 50, epic: 25, legendary: 5 } },
            { id: 'legend', name: 'Mystery Box', cost: 2000, emoji: 'üîÆ', prob: { common: 0, rare: 10, epic: 40, legendary: 50 } }
        ];

        // WORTSCHATZ (√áa roule 4)
        const VOCABULARY = [
            { fr: "Bonjour", de: "Guten Tag" }, { fr: "Salut", de: "Hallo" }, { fr: "Au revoir", de: "Auf Wiedersehen" },
            { fr: "Merci", de: "Danke" }, { fr: "S'il vous pla√Æt", de: "Bitte" }, 
            { fr: "L'√©cole", de: "Die Schule" }, { fr: "Le livre", de: "Das Buch" }, { fr: "Le cahier", de: "Das Heft" },
            { fr: "Le crayon", de: "Der Bleistift" }, { fr: "La gomme", de: "Der Gummi" }, { fr: "La trousse", de: "Das Etui" },
            { fr: "Le chien", de: "Der Hund" }, { fr: "Le chat", de: "Die Katze" }, { fr: "La souris", de: "Die Maus" },
            { fr: "L'oiseau", de: "Der Vogel" }, { fr: "La vache", de: "Die Kuh" }, { fr: "Le cheval", de: "Das Pferd" },
            { fr: "Jouer", de: "Spielen" }, { fr: "Chanter", de: "Singen" }, { fr: "Parler", de: "Sprechen" },
            { fr: "√âcouter", de: "Zuh√∂ren" }, { fr: "Regarder", de: "Schauen" }, { fr: "Manger", de: "Essen" },
            { fr: "D'abord", de: "Zuerst" }, { fr: "Puis", de: "Dann" }, { fr: "Apr√®s", de: "Danach" },
            { fr: "Finalement", de: "Schliesslich" }, { fr: "Peut-√™tre", de: "Vielleicht" }, { fr: "Toujours", de: "Immer" },
            { fr: "Rouge", de: "Rot" }, { fr: "Bleu", de: "Blau" }, { fr: "Vert", de: "Gr√ºn" }, { fr: "Jaune", de: "Gelb" },
            { fr: "Noir", de: "Schwarz" }, { fr: "Blanc", de: "Weiss" }, { fr: "Gris", de: "Grau" }, { fr: "Orange", de: "Orange" },
            { fr: "Un", de: "Eins" }, { fr: "Deux", de: "Zwei" }, { fr: "Trois", de: "Drei" }, { fr: "Quatre", de: "Vier" },
            { fr: "Cinq", de: "F√ºnf" }, { fr: "Six", de: "Sechs" }, { fr: "Sept", de: "Sieben" }, { fr: "Huit", de: "Acht" },
            { fr: "Neuf", de: "Neun" }, { fr: "Dix", de: "Zehn" },
            { fr: "Je", de: "Ich" }, { fr: "Tu", de: "Du" }, { fr: "Il", de: "Er" }, { fr: "Elle", de: "Sie" },
            { fr: "Nous", de: "Wir" }, { fr: "Vous", de: "Ihr" }, { fr: "Ils", de: "Sie (Plural)" }
        ];

        // --- HELPER ---
        const getXPForLevel = (lvl) => 200 * lvl;
        const getRankTitle = (lvl) => RANKS[Math.min(Math.floor((lvl-1)/2), RANKS.length-1)];
        
        const speak = (txt) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'fr-FR'; u.rate = 0.85;
                window.speechSynthesis.speak(u);
            }
        };

        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            const now = ctx.currentTime;
            
            if (type === 'correct') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1000, now+0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
            } else if (type === 'levelup') {
                [440, 554, 659, 880].forEach((f, i) => {
                    const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination);
                    o.type = 'square'; o.frequency.value = f; g.gain.setValueAtTime(0.1, ctx.currentTime + i*0.1); g.gain.linearRampToValueAtTime(0, ctx.currentTime + i*0.1 + 0.3);
                    o.start(ctx.currentTime + i*0.1); o.stop(ctx.currentTime + i*0.1 + 0.3);
                });
                return;
            } else if (type === 'cash') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(1800, now + 0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
            } else if (type === 'open') {
                osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(800, now+1); gain.gain.exponentialRampToValueAtTime(0.01, now+1); return;
            }
            osc.start(now); osc.stop(now+0.5);
        };

        const safeConfetti = () => { if (window.confetti) window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); };

        // --- COMPONENTS ---

        // 1. MATCH GAME (Verbinden)
        const MatchGame = ({ onFinish }) => {
            const [left, setLeft] = useState([]);
            const [right, setRight] = useState([]);
            const [selLeft, setSelLeft] = useState(null);
            const [solved, setSolved] = useState([]);

            useEffect(() => {
                const s = [...VOCABULARY].sort(()=>Math.random()-0.5).slice(0,5);
                setLeft(s.map(w => ({id: w.fr, txt: w.fr, pair: w.fr})));
                setRight(s.map(w => ({id: w.fr+'d', txt: w.de, pair: w.fr})).sort(()=>Math.random()-0.5));
            }, []);

            const clickLeft = (item) => {
                if(solved.includes(item.pair)) return;
                speak(item.txt);
                setSelLeft(item);
            };

            const clickRight = (item) => {
                if(solved.includes(item.pair) || !selLeft) return;
                if(selLeft.pair === item.pair) {
                    setSolved([...solved, item.pair]);
                    setSelLeft(null);
                    playSound('correct');
                    if(solved.length + 1 === 5) setTimeout(onFinish, 1000);
                } else {
                    playSound('wrong');
                    setSelLeft(null); // Reset
                }
            };

            return (
                <div className="flex gap-4 justify-between w-full h-full overflow-y-auto p-2">
                    <div className="w-1/2 flex flex-col gap-3">
                        {left.map(l => (
                            <div key={l.id} onClick={()=>clickLeft(l)} className={`word-card card-fr ${selLeft?.id===l.id?'selected':''} ${solved.includes(l.pair)?'matched':''}`}>
                                {l.txt}
                            </div>
                        ))}
                    </div>
                    <div className="w-1/2 flex flex-col gap-3">
                        {right.map(r => (
                            <div key={r.id} onClick={()=>clickRight(r)} className={`word-card card-de ${solved.includes(r.pair)?'matched':''}`}>
                                {r.txt}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // 2. MEMORY GAME (Echtes Flip)
        const MemoryCard = ({ card, onClick, flipped, matched }) => (
            <div className={`scene ${matched ? 'pointer-events-none' : ''}`} onClick={() => onClick(card)}>
                <div className={`card ${flipped ? 'is-flipped' : ''} ${matched ? 'is-matched' : ''}`}>
                    <div className="card__face card__face--front">?</div>
                    <div className={`card__face card__face--back ${card.type === 'fr' ? 'card-fr' : 'card-de'}`}>
                        {/* Kein Label mehr, nur Farbe und Text */}
                        <div className={card.type === 'fr' ? 'text-fr' : 'text-de'}>{card.txt}</div>
                    </div>
                </div>
            </div>
        );

        const MemoryGame = ({ onFinish }) => {
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);
            const [locked, setLocked] = useState(false);

            useEffect(() => {
                const s = [...VOCABULARY].sort(()=>Math.random()-0.5).slice(0,6);
                const d = s.flatMap(p => [
                    { id: p.fr, txt: p.fr, type: 'fr', pair: p.fr },
                    { id: p.fr+'d', txt: p.de, type: 'de', pair: p.fr }
                ]).sort(() => Math.random() - 0.5);
                setCards(d);
            }, []);

            const click = (card) => {
                if(locked || flipped.includes(card.id) || matched.includes(card.id)) return;
                
                if(card.type === 'fr') speak(card.txt);
                const newFlipped = [...flipped, card.id];
                setFlipped(newFlipped);

                if(newFlipped.length === 2) {
                    setLocked(true);
                    const c1 = cards.find(c=>c.id===newFlipped[0]);
                    const c2 = cards.find(c=>c.id===newFlipped[1]);
                    
                    if(c1.pair === c2.pair) {
                        playSound('correct');
                        setTimeout(() => {
                            setMatched([...matched, c1.id, c2.id]);
                            setFlipped([]);
                            setLocked(false);
                            if(matched.length + 2 === cards.length) setTimeout(onFinish, 500);
                        }, 800);
                    } else {
                        playSound('wrong');
                        setTimeout(() => {
                            setFlipped([]);
                            setLocked(false);
                        }, 1200);
                    }
                }
            };

            return (
                <div className="grid grid-cols-3 gap-3 p-2">
                    {cards.map(c => (
                        <MemoryCard 
                            key={c.id} 
                            card={c} 
                            flipped={flipped.includes(c.id) || matched.includes(c.id)} 
                            matched={matched.includes(c.id)}
                            onClick={click} 
                        />
                    ))}
                </div>
            );
        };

        // 3. QUIZ GAME
        const QuizGame = ({ onCorrect }) => {
            const [q, setQ] = useState(null);
            const next = () => {
                const t = VOCABULARY[Math.floor(Math.random()*VOCABULARY.length)];
                const opts = [...VOCABULARY.filter(w=>w.fr!==t.fr).sort(()=>Math.random()-0.5).slice(0,3), t].sort(()=>Math.random()-0.5);
                setQ({t, opts}); speak(t.fr);
            };
            useEffect(()=>next(),[]);
            const check = (opt) => {
                if(opt.fr===q.t.fr){ playSound('correct'); onCorrect(); next(); }
                else { playSound('wrong'); alert(`Falsch! ${q.t.fr} = ${q.t.de}`); }
            };
            if(!q) return null;
            return (
                <div className="pop-in text-center w-full max-w-md">
                    <div className="bg-white p-6 rounded-2xl shadow mb-6 border-t-4 border-indigo-500">
                        <h1 className="text-3xl font-black text-indigo-900 mb-2">{q.t.fr}</h1>
                        <button onClick={()=>speak(q.t.fr)} className="text-sm bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full font-bold">üîä H√∂ren</button>
                    </div>
                    <div className="grid gap-3">{q.opts.map((o,i)=><button key={i} onClick={()=>check(o)} className="bg-white p-4 rounded-xl shadow-sm font-bold text-left border-2 border-indigo-50 hover:border-indigo-400 hover:bg-indigo-50 transition text-slate-700">{o.de}</button>)}</div>
                </div>
            );
        };

        // 4. LISTEN GAME
        const ListenGame = ({ onCorrect }) => {
            const [q, setQ] = useState(null);
            const next = () => {
                const t = VOCABULARY[Math.floor(Math.random()*VOCABULARY.length)];
                const opts = [...VOCABULARY.filter(w=>w.fr!==t.fr).sort(()=>Math.random()-0.5).slice(0,3), t].sort(()=>Math.random()-0.5);
                setQ({t, opts}); speak(t.fr);
            };
            useEffect(()=>next(),[]);
            const check = (opt) => {
                if(opt.fr===q.t.fr){ playSound('correct'); onCorrect(); next(); } else { playSound('wrong'); }
            };
            if(!q) return null;
            return (
                <div className="pop-in text-center w-full max-w-md">
                    <div className="bg-white p-10 rounded-3xl shadow-lg mb-6 flex justify-center">
                        <button onClick={()=>speak(q.t.fr)} className="w-24 h-24 bg-purple-100 rounded-full text-5xl flex items-center justify-center shadow-inner hover:scale-110 transition animate-bounce">üîä</button>
                    </div>
                    <p className="text-slate-400 mb-4 text-sm font-bold uppercase">Was hast du geh√∂rt?</p>
                    <div className="grid gap-3">{q.opts.map((o,i)=><button key={i} onClick={()=>check(o)} className="bg-white p-4 rounded-xl shadow-sm font-bold text-left border-2 border-purple-50 hover:border-purple-400 hover:bg-purple-50 transition text-slate-700">{o.de}</button>)}</div>
                </div>
            );
        };

        // 5. WRITE GAME (Enter Taste Support)
        const WriteGame = ({ onCorrect }) => {
            const [t, setT] = useState(null);
            const [inp, setInp] = useState("");
            const [st, setSt] = useState("typing");
            const next = () => { const w=VOCABULARY[Math.floor(Math.random()*VOCABULARY.length)]; setT(w); setInp(""); setSt("typing"); speak(w.fr); };
            useEffect(()=>next(),[]);
            const check = () => {
                if(st!=="typing"){ if(st==="success"){onCorrect(); next();} else next(); return; }
                if(inp.toLowerCase().trim()===t.de.toLowerCase().split(' (')[0].toLowerCase()){ setSt("success"); playSound('correct'); } 
                else { setSt("error"); playSound('wrong'); }
            };
            if(!t) return null;
            return (
                <div className="pop-in text-center w-full max-w-md">
                    <div className="bg-white p-6 rounded-2xl shadow mb-6 border-t-4 border-emerald-500">
                        <h1 className="text-3xl font-black text-emerald-900 mb-2">{t.fr}</h1>
                        <button onClick={()=>speak(t.fr)} className="text-sm bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full font-bold">üîä H√∂ren</button>
                    </div>
                    <input value={inp} onChange={e=>setInp(e.target.value)} className={`input-field ${st==='error'?'error':st==='success'?'success':''}`} placeholder="Deutsch..." onKeyDown={e=>e.key==='Enter'&&check()} autoFocus readOnly={st!=="typing"} />
                    {st==="error" && <div className="mt-2 text-red-500 font-bold animate-bounce">L√∂sung: {t.de}</div>}
                    <button onClick={check} className={`w-full bg-emerald-600 text-white font-bold py-4 mt-4 rounded-xl shadow-lg ${st==='typing'?'':'bg-blue-600'}`}>{st==="typing"?"Pr√ºfen":"Weiter"}</button>
                </div>
            );
        };

        // --- PACK OPENER ---
        const PackOpener = ({ pack, onClose, onUnlock }) => {
            const [stage, setStage] = useState('closed');
            const [reward, setReward] = useState(null);

            const open = () => {
                setStage('shaking'); playSound('open');
                setTimeout(() => {
                    const rand = Math.random()*100;
                    let r = 'common';
                    if(rand < pack.prob.legendary) r='legendary';
                    else if(rand < pack.prob.legendary + pack.prob.epic) r='epic';
                    else if(rand < pack.prob.legendary + pack.prob.epic + pack.prob.rare) r='rare';
                    
                    const pool = AVATARS.filter(a=>a.rarity===r);
                    const item = pool.length ? pool[Math.floor(Math.random()*pool.length)] : AVATARS[0];
                    setReward(item); onUnlock(item); setStage('open'); safeConfetti();
                }, 2000);
            };

            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-50">
                    {stage==='closed' && <div onClick={open} className="text-9xl cursor-pointer animate-bounce">{pack.emoji}</div>}
                    {stage==='shaking' && <div className="text-9xl shake-box">{pack.emoji}</div>}
                    {stage==='open' && (
                        <div className="bg-white p-8 rounded-3xl text-center pop-in">
                            <div className="text-2xl font-bold mb-4">Du bekommst:</div>
                            <div className="text-8xl mb-4">{reward.icon}</div>
                            <div className="text-xl font-black uppercase text-indigo-600">{reward.name}</div>
                            <div className="text-xs font-bold uppercase bg-slate-200 px-2 py-1 rounded inline-block mt-2">{reward.rarity}</div>
                            <button onClick={onClose} className="mt-8 w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">OK</button>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP SHELL ---
        const App = () => {
            const [user, setUser] = useState({ name: 'Gast', coins: 100, xp: 0, level: 1, avatar: 'bear', unlockedAvatars: ['bear'] });
            const [view, setView] = useState('menu');
            const [pack, setPack] = useState(null);
            const [float, setFloat] = useState(null);

            useEffect(() => { const s = localStorage.getItem('franz_coll_v6'); if (s) setUser(JSON.parse(s)); document.getElementById('loading').style.display = 'none'; }, []);
            const save = (u) => { setUser(u); localStorage.setItem('franz_coll_v6', JSON.stringify(u)); };

            const addProgress = (c, x) => {
                const u = { ...user }; u.coins += c; u.xp += x;
                if (u.xp >= getXPForLevel(u.level + 1)) { u.level++; playSound('levelup'); alert("LEVEL UP! üéâ"); safeConfetti(); }
                save(u); if(c > 10) safeConfetti();
                setFloat(`+${c}üí∞ +${x}XP`); setTimeout(()=>setFloat(null), 1500);
            };

            const openBox = (p) => {
                if(user.coins < p.cost) { alert("Zu wenig M√ºnzen!"); return; }
                save({...user, coins: user.coins - p.cost});
                setPack(p); setView('loot');
            };
            const unlock = (item) => {
                if(!user.unlockedAvatars.includes(item.id)) save({...user, unlockedAvatars: [...user.unlockedAvatars, item.id], avatar: item.id});
            };
            const equip = (id) => { save({...user, avatar: id}); };

            if (view === 'menu') {
                const nextXP = getXPForLevel(user.level + 1);
                const progress = Math.min(100, (user.xp / nextXP) * 100);
                return (
                    <div className="max-w-md mx-auto p-4 min-h-screen flex flex-col justify-center">
                        <div className="bg-white rounded-3xl shadow-xl p-6 mb-6 border-b-8 border-teal-200 relative overflow-hidden">
                            <div className="flex justify-between items-center mb-4 bg-slate-50 p-3 rounded-2xl relative z-10">
                                 <div className="flex items-center gap-3">
                                    <div className="text-4xl bg-white p-2 rounded-xl shadow-sm">{AVATARS.find(a=>a.id===user.avatar)?.icon || 'üêª'}</div>
                                    <div className="text-left"><div className="font-bold text-teal-900">{user.name}</div><div className="text-xs text-teal-400 font-bold">{getRankTitle(user.level)}</div></div>
                                 </div>
                                 <button onClick={()=>setView('shop')} className="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-xl font-bold text-sm shadow-sm">{user.coins} üí∞</button>
                            </div>
                            <div className="xp-bar-container mb-1 relative z-10"><div className="xp-bar-fill" style={{width: `${progress}%`}}></div></div>
                            <div className="text-right text-xs font-bold text-slate-400 relative z-10">{user.xp}/{nextXP} XP</div>
                        </div>

                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <button onClick={()=>setView('match')} className="bg-blue-50 p-6 rounded-2xl border-2 border-blue-100 hover:border-blue-400 font-bold text-blue-800 text-xl flex flex-col items-center gap-2"><span className="text-4xl">üîó</span>Verbinden</button>
                            <button onClick={()=>setView('memory')} className="bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-100 hover:border-indigo-400 font-bold text-indigo-800 text-xl flex flex-col items-center gap-2"><span className="text-4xl">üÉè</span>Memory</button>
                            <button onClick={()=>setView('quiz')} className="bg-purple-50 p-6 rounded-2xl border-2 border-purple-100 hover:border-purple-400 font-bold text-purple-800 text-xl flex flex-col items-center gap-2"><span className="text-4xl">‚ùì</span>Quiz</button>
                            <button onClick={()=>setView('listen')} className="bg-pink-50 p-6 rounded-2xl border-2 border-pink-100 hover:border-pink-400 font-bold text-pink-800 text-xl flex flex-col items-center gap-2"><span className="text-4xl">üëÇ</span>H√∂ren</button>
                            <button onClick={()=>setView('write')} className="bg-emerald-50 p-6 rounded-2xl border-2 border-emerald-100 hover:border-emerald-400 font-bold text-emerald-800 text-xl flex flex-col items-center gap-2 col-span-2"><span className="text-4xl">‚úçÔ∏è</span>Schreiben</button>
                        </div>
                        <a href="index.html" className="text-center text-slate-400 font-bold text-sm bg-white p-3 rounded-xl">üè† Zentrale</a>
                    </div>
                );
            }

            if (view === 'shop') return (
                <div className="max-w-2xl mx-auto p-4 min-h-screen pb-20">
                    <div className="flex justify-between items-center mb-6"><button onClick={()=>setView('menu')} className="font-bold text-slate-500">‚óÄ Zur√ºck</button><div className="font-bold text-xl text-yellow-600">{user.coins} üí∞</div></div>
                    <div className="flex gap-4 overflow-x-auto pb-4 mb-8">{PACKS.map(p => (<button key={p.id} onClick={()=>openBox(p)} className="min-w-[140px] bg-white p-4 rounded-2xl shadow border-b-4 border-teal-200 flex flex-col items-center hover:scale-105 transition"><span className="text-5xl mb-2">{p.emoji}</span><span className="font-bold text-sm">{p.name}</span><span className="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold text-xs">{p.cost} üí∞</span></button>))}</div>
                    <h3 className="font-bold text-slate-400 uppercase text-xs mb-4">Sammelalbum</h3>
                    <div className="grid grid-cols-4 gap-3">
                        {AVATARS.map(a => {
                            const owned = user.unlockedAvatars.includes(a.id);
                            return <div key={a.id} onClick={()=>{if(owned)equip(a.id)}} className={`avatar-slot ${owned ? 'unlocked' : 'locked'} ${user.avatar===a.id ? 'equipped' : ''} ${'rarity-'+a.rarity}`}>{a.icon}</div>
                        })}
                    </div>
                </div>
            );

            if(view === 'loot') return <PackOpener pack={pack} onClose={()=>{setView('shop'); setPack(null);}} onUnlock={unlock} />;

            return (
                <div className="min-h-screen p-4 flex flex-col">
                    {float && <div className="float-text text-4xl text-yellow-500 fixed top-1/2 left-1/2" style={{marginLeft: -50}}>{float}</div>}
                    <div className="flex justify-between items-center max-w-4xl mx-auto w-full mb-6 relative z-20">
                        <button onClick={()=>setView('menu')} className="bg-white px-4 py-2 rounded-xl font-bold shadow text-slate-500 hover:text-red-500 transition">‚úï Ende</button>
                        <div className="font-bold text-teal-600 bg-white px-4 py-2 rounded-full shadow-sm">{user.coins} üí∞</div>
                    </div>
                    <div className="flex-1 flex flex-col justify-center items-center w-full">
                        {view === 'match' && <MatchGame onFinish={() => addProgress(20, 50)} />}
                        {view === 'memory' && <MemoryGame onFinish={() => addProgress(20, 50)} />}
                        {view === 'quiz' && <QuizGame onCorrect={() => addProgress(5, 10)} />}
                        {view === 'listen' && <ListenGame onCorrect={() => addProgress(10, 15)} />}
                        {view === 'write' && <WriteGame onCorrect={() => addProgress(15, 25)} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>