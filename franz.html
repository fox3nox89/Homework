<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Abenteuer ‚Äì 4. Klasse</title>

    <!-- Tailwind & React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Extras -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <style>
        body{
            font-family:'Nunito',sans-serif;
            background:linear-gradient(180deg,#0f172a 0%,#020617 60%,#0b1120 100%);
            color:#e5e7eb;
        }
        .font-fun{font-family:'Fredoka',sans-serif;}

        /* Karten f√ºr Memory */
        .memory-scene{perspective:1000px;height:110px;cursor:pointer;}
        .memory-card{
            width:100%;height:100%;position:relative;
            transform-style:preserve-3d;
            transition:transform .45s;
        }
        .memory-card.flipped{transform:rotateY(180deg);}
        .memory-face{
            position:absolute;inset:0;
            backface-visibility:hidden;
            border-radius:18px;
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 4px 10px rgba(0,0,0,.4);
            border:3px solid rgba(148,163,184,.6);
        }
        .memory-front{
            background:linear-gradient(135deg,#4f46e5,#ec4899);
            color:white;font-size:2.4rem;
        }
        .memory-back{
            transform:rotateY(180deg);
            background:#0f172a;
            font-size:1.2rem;
            font-weight:800;
            text-align:center;
            padding:6px;
        }

        .memory-back-fr{border-color:#60a5fa;color:#bfdbfe;}
        .memory-back-de{border-color:#f97316;color:#fed7aa;}

        /* Buttons */
        .btn-main{
            border-radius:999px;
            font-weight:800;
            text-transform:uppercase;
            letter-spacing:.05em;
            padding:.7rem 1.4rem;
            display:inline-flex;
            align-items:center;
            gap:.5rem;
            box-shadow:0 6px 0 rgba(15,23,42,.9);
            transition:transform .1s, box-shadow .1s;
        }
        .btn-main:active{
            transform:translateY(4px);
            box-shadow:0 0 0 rgba(15,23,42,.9);
        }

        /* Shop-Karten */
        .shop-card{
            border-radius:18px;
            padding:12px;
            border-width:3px;
            border-style:solid;
            background:#020617;
            display:flex;
            flex-direction:column;
            gap:6px;
            cursor:pointer;
            transition:transform .15s, box-shadow .15s, border-color .15s;
        }
        .shop-card:hover{
            transform:translateY(-3px);
            box-shadow:0 12px 25px rgba(0,0,0,.7);
        }
        .shop-common{border-color:#9ca3af;}
        .shop-rare{border-color:#3b82f6;box-shadow:0 0 12px rgba(59,130,246,.5);}
        .shop-epic{border-color:#a855f7;box-shadow:0 0 16px rgba(168,85,247,.6);}
        .shop-legendary{
            border-color:#eab308;
            box-shadow:0 0 22px rgba(234,179,8,.7);
            background:linear-gradient(135deg,#111827,#422006);
        }

        /* Overlay */
        .modal-overlay{
            position:fixed;inset:0;
            background:rgba(15,23,42,.85);
            display:flex;align-items:center;justify-content:center;
            z-index:50;
            backdrop-filter:blur(6px);
        }
    </style>
</head>
<body class="min-h-screen">

<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef} = React;

/* ---------- HILFSFUNKTIONEN ---------- */

const speakFR = (text)=>{
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    u.rate = 0.9;
    window.speechSynthesis.speak(u);
};

const fireConfetti = ()=>{
    if(window.confetti){
        window.confetti({particleCount:80,spread:70,origin:{y:0.6}});
    }
};

const normalize = s => s.toLowerCase().trim();
const stripFrArticle = s=>{
    s = normalize(s);
    if(s.startsWith("l'")) return s.slice(2);
    const arts = ["le ","la ","les "];
    for(const a of arts) if(s.startsWith(a)) return s.slice(a.length);
    return s;
};
const stripDeArticle = s=>{
    s = normalize(s);
    const arts = ["der ","die ","das "];
    for(const a of arts) if(s.startsWith(a)) return s.slice(a.length);
    return s;
};

/* ---------- STANDARD-W√ñRTER (Fallback, falls JSON fehlt) ---------- */

const fallbackWords = [
    // Pronomen
    {fr:"je",de:"ich",topic:"pronomen"},
    {fr:"tu",de:"du",topic:"pronomen"},
    {fr:"il",de:"er",topic:"pronomen"},
    {fr:"elle",de:"sie",topic:"pronomen"},
    {fr:"nous",de:"wir",topic:"pronomen"},
    {fr:"vous",de:"ihr",topic:"pronomen"},
    {fr:"ils",de:"sie (m)",topic:"pronomen"},
    {fr:"elles",de:"sie (w)",topic:"pronomen"},
    // slowUp / Transport
    {fr:"le train",de:"der Zug",topic:"slowup"},
    {fr:"la voiture",de:"das Auto",topic:"slowup"},
    {fr:"le parcours",de:"die Strecke",topic:"slowup"},
    {fr:"√† pied",de:"zu Fuss",topic:"slowup"},
    {fr:"jusqu'√†",de:"bis",topic:"slowup"},
    // Tiere
    {fr:"la souris",de:"die Maus",topic:"tiere"},
    {fr:"le lapin",de:"der Hase",topic:"tiere"},
    {fr:"la tortue",de:"die Schildkr√∂te",topic:"tiere"},
    {fr:"le chien",de:"der Hund",topic:"tiere"},
    {fr:"le chat",de:"die Katze",topic:"tiere"},
    {fr:"l'√©cureuil",de:"das Eichh√∂rnchen",topic:"tiere"},
    // Schule / Alltag
    {fr:"la biblioth√®que",de:"die Bibliothek",topic:"schule"},
    {fr:"l'√©cole",de:"die Schule",topic:"schule"},
    {fr:"le secret",de:"das Geheimnis",topic:"schule"},
    {fr:"la pomme",de:"der Apfel",topic:"schule"},
    {fr:"la bande dessin√©e",de:"der Comic",topic:"schule"},
    // Verben
    {fr:"organiser",de:"organisieren",topic:"verben"},
    {fr:"raconter",de:"erz√§hlen",topic:"verben"},
    {fr:"inviter",de:"einladen",topic:"verben"},
    {fr:"cacher",de:"verstecken",topic:"verben"},
    {fr:"garder",de:"(f√ºr sich) behalten",topic:"verben"},
    // Zahlen rund ums Geld
    {fr:"onze",de:"elf",topic:"zahlen"},
    {fr:"douze",de:"zw√∂lf",topic:"zahlen"},
    {fr:"treize",de:"dreizehn",topic:"zahlen"},
    {fr:"seize",de:"sechzehn",topic:"zahlen"},
    {fr:"dix-huit",de:"achtzehn",topic:"zahlen"},
    {fr:"vingt",de:"zwanzig",topic:"zahlen"},
    {fr:"dix-sept",de:"siebzehn",topic:"zahlen"}
];

/* ---------- LEVEL & PROFIL ---------- */

const MAX_LEVEL = 20;
const xpForLevel = lvl => 150 + (lvl-1)*80;
const calcLevel = (xp)=>{
    let lvl=1, rest=xp;
    while(lvl<MAX_LEVEL && rest>=xpForLevel(lvl)){
        rest-=xpForLevel(lvl);
        lvl++;
    }
    const next = lvl<MAX_LEVEL ? xpForLevel(lvl) : 0;
    return {level:lvl,progress: lvl===MAX_LEVEL?1:rest/next};
};

const defaultProfile = {
    xp:0,
    coins:0,
    avatar:"üêª",
    bought:[],
};

const loadProfile = ()=>{
    try{
        const raw = localStorage.getItem("franz_profile_v1");
        if(!raw) return defaultProfile;
        return {...defaultProfile,...JSON.parse(raw)};
    }catch(e){
        return defaultProfile;
    }
};

const saveProfile = (p)=>{
    try{
        localStorage.setItem("franz_profile_v1",JSON.stringify(p));
    }catch(e){}
};

/* ---------- SHOP-DATEN ---------- */

const shopItems = [
    // Avatare
    {id:"bear",type:"avatar",emoji:"üêª",name:"B√§r Bruno",desc:"Der gem√ºtliche Besch√ºtzer.",price:0,rarity:"common"},
    {id:"fox",type:"avatar",emoji:"ü¶ä",name:"Fuchs Foxy",desc:"Superschnell beim Denken.",price:80,rarity:"rare"},
    {id:"owl",type:"avatar",emoji:"ü¶â",name:"Eule Luna",desc:"Hilft beim Konzentrieren.",price:120,rarity:"rare"},
    {id:"turtle",type:"avatar",emoji:"üê¢",name:"Schildkr√∂te Turbo",desc:"Langsam, aber fehlerfrei.",price:180,rarity:"epic"},
    {id:"dragon",type:"avatar",emoji:"üê≤",name:"Drache Draco",desc:"Legend√§rer Lernmeister.",price:350,rarity:"legendary"},
    // Lern-Hilfen
    {id:"hint",type:"boost",emoji:"üí°",name:"Hinweis-Ticket",desc:"+1 Hinweis im Schreib-Modus.",price:40,rarity:"common"},
    {id:"doublexp",type:"boost",emoji:"‚ö°",name:"Doppel-XP (1 Runde)",desc:"N√§chste Runde +100% XP.",price:120,rarity:"epic"},
    {id:"heart",type:"boost",emoji:"‚ù§Ô∏è",name:"Extra Herz",desc:"Ein Fehler mehr erlaubt in H√∂r zu.",price:70,rarity:"rare"},
    // Kosmetik
    {id:"theme-forest",type:"theme",emoji:"üå≤",name:"Wald-Thema",desc:"Gr√ºner Hintergrund.",price:90,rarity:"rare"},
    {id:"theme-space",type:"theme",emoji:"‚ú®",name:"Galaxy-Thema",desc:"Leuchtende Sterne.",price:90,rarity:"rare"}
];

/* ---------- COMPONENTS ---------- */

function Header({profile,onReset}) {
    const {level,progress} = calcLevel(profile.xp);
    return (
        <header className="px-4 pt-4 pb-3 border-b border-slate-800 bg-slate-950/60 backdrop-blur">
            <div className="max-w-5xl mx-auto flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div className="flex items-center gap-3">
                    <a href="index.html" className="btn-main bg-white text-slate-800 text-xs md:text-sm">
                        <i className="fa-solid fa-house"></i>
                        Startseite
                    </a>
                    <div>
                        <h1 className="font-fun text-2xl md:text-3xl text-white flex items-center gap-2">
                            <span className="text-3xl">{profile.avatar}</span>
                            <span>Franz√∂sisch-Abenteuer</span>
                        </h1>
                        <p className="text-slate-400 text-xs md:text-sm">
                            4. Klasse ‚Ä¢ W√∂rter, H√∂ren, Schreiben & Shop
                        </p>
                    </div>
                </div>
                <div className="flex flex-col md:items-end gap-1 text-xs md:text-sm">
                    <div className="flex items-center gap-4">
                        <div>
                            <div className="flex justify-between text-slate-400 text-[11px] mb-1">
                                <span>Level {level}</span>
                                <span>{Math.round(progress*100)}%</span>
                            </div>
                            <div className="w-40 h-2 bg-slate-800 rounded-full overflow-hidden">
                                <div className="h-full bg-gradient-to-r from-emerald-400 to-lime-400"
                                     style={{width:`${progress*100}%`}}></div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="flex items-center gap-1 text-amber-300">
                                <i className="fa-solid fa-coins text-amber-400"></i>
                                {profile.coins}
                            </span>
                            <button
                                onClick={onReset}
                                className="text-xs text-red-300 hover:text-red-400 underline decoration-dotted">
                                Alles zur√ºcksetzen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    );
}

function ModeTabs({mode,setMode}) {
    const tab = (id,label,icon) => (
        <button
            key={id}
            onClick={()=>setMode(id)}
            className={`flex-1 px-3 py-2 rounded-full text-xs md:text-sm font-bold flex items-center justify-center gap-2
                        transition ${mode===id
                        ? "bg-indigo-500 text-white shadow-lg"
                        : "bg-slate-800/60 text-slate-300 hover:bg-slate-700"}`}>
            <i className={`fa-solid ${icon}`}></i>{label}
        </button>
    );
    return (
        <div className="max-w-5xl mx-auto px-4 mt-4">
            <div className="bg-slate-900/70 border border-slate-800 rounded-full p-1 flex gap-1">
                {tab("memory","Memory","fa-table-cells")}
                {tab("listen","H√∂r zu","fa-headphones")}
                {tab("write","Schreiben","fa-pen")}
                {tab("shop","Shop","fa-store")}
            </div>
        </div>
    );
}

/* ----- Memory ----- */

function MemoryGame({words,onReward}) {
    const [cards,setCards] = useState([]);
    const [open,setOpen] = useState([]);
    const [matched,setMatched] = useState([]);
    const [roundFinished,setRoundFinished] = useState(false);

    useEffect(()=>{
        const base = [...words].sort(()=>Math.random()-0.5).slice(0,8);
        const deck = base.flatMap((w,idx)=>[
            {id:`${idx}-fr`,pair:idx,txt:w.fr,lang:"fr"},
            {id:`${idx}-de`,pair:idx,txt:w.de,lang:"de"}
        ]).sort(()=>Math.random()-0.5);
        setCards(deck);
        setOpen([]);
        setMatched([]);
        setRoundFinished(false);
    },[words]);

    const handleClick = (id)=>{
        if(roundFinished) return;
        if(open.includes(id) || matched.includes(id)) return;
        if(open.length===2) return;
        const newOpen=[...open,id];
        setOpen(newOpen);
        if(newOpen.length===2){
            const c1 = cards.find(c=>c.id===newOpen[0]);
            const c2 = cards.find(c=>c.id===newOpen[1]);
            if(c1.pair===c2.pair){
                setTimeout(()=>{
                    setMatched(m=>[...m,c1.id,c2.id]);
                    setOpen([]);
                    if(matched.length+2===cards.length){
                        setRoundFinished(true);
                        fireConfetti();
                        onReward({xp:40,coins:15});
                    }
                },600);
            }else{
                setTimeout(()=>setOpen([]),800);
            }
        }
    };

    return (
        <section className="max-w-5xl mx-auto px-4 mt-6">
            <h2 className="font-fun text-xl text-white mb-2 flex items-center gap-2">
                <i className="fa-solid fa-table-cells-large text-indigo-400"></i>
                Memory ‚Äì FR & DE
            </h2>
            <p className="text-slate-400 text-sm mb-4">
                Decke immer zwei Karten auf. Ein Paar sind das franz√∂sische Wort und die deutsche √úbersetzung.
            </p>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                {cards.map(card=>{
                    const isOpen = open.includes(card.id) || matched.includes(card.id);
                    return (
                        <div key={card.id} className="memory-scene" onClick={()=>handleClick(card.id)}>
                            <div className={`memory-card ${isOpen?"flipped":""}`}>
                                <div className="memory-face memory-front">?</div>
                                <div className={`memory-face memory-back ${card.lang==="fr"?"memory-back-fr":"memory-back-de"}`}>
                                    <span className="px-1 leading-tight">
                                        {card.txt}
                                    </span>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
            {roundFinished && (
                <div className="mt-4 text-sm text-emerald-300">
                    Runde geschafft! Du hast XP und M√ºnzen bekommen. Klicke oben auf einen anderen Modus oder lade die Seite neu f√ºr ein neues Memory.
                </div>
            )}
        </section>
    );
}

/* ----- H√∂r zu (Multiple Choice, Anti-Cheat) ----- */

function ListenGame({words,onResult}) {
    const [current,setCurrent]=useState(null);
    const [options,setOptions]=useState([]);
    const [state,setState]=useState("ready"); // ready | answered
    const [wasCorrect,setWasCorrect]=useState(null);
    const [hearts,setHearts]=useState(3);

    const pickNew = ()=>{
        const pool=[...words].sort(()=>Math.random()-0.5);
        const correct=pool[0];
        const distractors = pool.slice(1,5).map(w=>w.de);
        const opt = [correct.de,...distractors].sort(()=>Math.random()-0.5);
        setCurrent(correct);
        setOptions(opt);
        setState("ready");
        setWasCorrect(null);
    };

    useEffect(()=>{pickNew()},[words]);

    const handleAnswer=(de)=>{
        if(state!=="ready") return;
        const correct = normalize(de)===normalize(current.de);
        setState("answered");
        setWasCorrect(correct);
        if(correct){
            speakFR(current.fr);
            fireConfetti();
            onResult({xp:20,coins:8});
        }else{
            onResult({xp:0,coins:-3});
            setHearts(h=>Math.max(0,h-1));
        }
    };

    const handleNext=()=>{
        if(hearts===0){
            setHearts(3);
        }
        pickNew();
    };

    if(!current) return null;

    return (
        <section className="max-w-5xl mx-auto px-4 mt-6">
            <div className="flex items-center justify-between mb-3">
                <h2 className="font-fun text-xl text-white flex items-center gap-2">
                    <i className="fa-solid fa-headphones text-sky-400"></i>
                    H√∂r zu & w√§hle
                </h2>
                <div className="flex items-center gap-1 text-red-300 text-sm">
                    {Array.from({length:3}).map((_,i)=>(
                        <span key={i}>{i<hearts?"‚ù§Ô∏è":"üñ§"}</span>
                    ))}
                </div>
            </div>
            <p className="text-slate-400 text-sm mb-4">
                Dr√ºcke auf den Lautsprecher. H√∂re das franz√∂sische Wort und w√§hle **genau eine** deutsche Bedeutung.
                Du hast nur einen Versuch pro Wort.
            </p>

            <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 flex flex-col gap-4">
                <div className="flex items-center gap-3">
                    <button
                        onClick={()=>speakFR(current.fr)}
                        className="btn-main bg-sky-500 text-white text-sm">
                        <i className="fa-solid fa-volume-high"></i> Abspielen
                    </button>
                    <span className="text-slate-300 text-sm">
                        Franz√∂sisches Wort: <span className="font-bold text-sky-300">{current.fr}</span>
                    </span>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {options.map(opt=>{
                        const isCorrect = normalize(opt)===normalize(current.de);
                        let color="bg-slate-800 hover:bg-slate-700 text-slate-100";
                        if(state==="answered"){
                            if(isCorrect) color="bg-emerald-600 text-white";
                            else if(wasCorrect===false && normalize(opt)===normalize(current.answer)) {
                                // nix
                            }
                        }
                        return (
                            <button
                                key={opt}
                                disabled={state!=="ready"}
                                onClick={()=>handleAnswer(opt)}
                                className={`w-full px-3 py-3 rounded-xl text-sm font-bold border border-slate-700 ${color}
                                           disabled:opacity-80 disabled:cursor-default`}>
                                {opt}
                            </button>
                        );
                    })}
                </div>

                {state==="answered" && (
                    <div className={`text-sm ${wasCorrect?"text-emerald-300":"text-red-300"}`}>
                        {wasCorrect
                            ? "Richtig! Du hast XP und M√ºnzen bekommen."
                            : `Leider falsch. Richtig w√§re: "${current.de}".`}
                    </div>
                )}

                <div className="flex justify-end">
                    <button
                        onClick={handleNext}
                        className="btn-main bg-indigo-500 text-white text-xs">
                        N√§chstes Wort <i className="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </section>
    );
}

/* ----- Schreiben (mit ‚Äûfast richtig‚Äú bei Artikeln) ----- */

function WriteGame({words,onResult}) {
    const [current,setCurrent]=useState(null);
    const [direction,setDirection]=useState("fr2de");
    const [input,setInput]=useState("");
    const [feedback,setFeedback]=useState(null);

    const pickNew = ()=>{
        const w = words[Math.floor(Math.random()*words.length)];
        setCurrent(w);
        setDirection(Math.random()<0.5?"fr2de":"de2fr");
        setInput("");
        setFeedback(null);
    };

    useEffect(()=>{pickNew()},[words]);

    if(!current) return null;

    const correctAnswer = direction==="fr2de" ? current.de : current.fr;

    const check = ()=>{
        const user = input.trim();
        if(!user) return;
        const normUser = normalize(user);
        const normCorrect = normalize(correctAnswer);

        if(normUser===normCorrect){
            fireConfetti();
            onResult({xp:25,coins:10});
            setFeedback({type:"full",msg:"Vollst√§ndig richtig! Super."});
            return;
        }

        const basicUser = direction==="fr2de" ? stripDeArticle(user) : stripFrArticle(user);
        const basicCorrect = direction==="fr2de" ? stripDeArticle(correctAnswer) : stripFrArticle(correctAnswer);

        if(basicUser===basicCorrect){
            onResult({xp:15,coins:5});
            setFeedback({
                type:"partial",
                msg:`Das Wort stimmt, aber der Artikel war anders. Richtig w√§re z.B.: "${correctAnswer}".`
            });
        }else{
            onResult({xp:0,coins:-2});
            setFeedback({
                type:"wrong",
                msg:`Leider falsch. Richtig w√§re: "${correctAnswer}".`
            });
        }
    };

    return (
        <section className="max-w-5xl mx-auto px-4 mt-6">
            <h2 className="font-fun text-xl text-white mb-2 flex items-center gap-2">
                <i className="fa-solid fa-pen text-emerald-400"></i>
                Schreiben & √úbersetzen
            </h2>
            <p className="text-slate-400 text-sm mb-4">
                Schreibe die √úbersetzung. Gross/klein ist egal. Bei falschem Artikel bekommst du noch halbe Punkte.
            </p>
            <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 flex flex-col gap-4">
                <div className="text-sm text-slate-300">
                    {direction==="fr2de" ? (
                        <>√úbersetze ins Deutsche: <span className="font-bold text-sky-300">{current.fr}</span></>
                    ) : (
                        <>√úbersetze ins Franz√∂sische: <span className="font-bold text-amber-300">{current.de}</span></>
                    )}
                </div>
                <input
                    className="w-full px-3 py-3 rounded-xl bg-slate-950 border border-slate-700 text-sm outline-none focus:ring-2 focus:ring-indigo-500"
                    value={input}
                    onChange={e=>setInput(e.target.value)}
                    onKeyDown={e=>{if(e.key==="Enter") check();}}
                    placeholder="Antwort hier eingeben..."
                />
                {feedback && (
                    <div className={`text-sm ${
                        feedback.type==="full" ? "text-emerald-300" :
                        feedback.type==="partial" ? "text-yellow-300" : "text-red-300"
                    }`}>
                        {feedback.msg}
                    </div>
                )}
                <div className="flex justify-between">
                    <button
                        onClick={pickNew}
                        className="btn-main bg-slate-800 text-slate-100 text-xs">
                        √úberspringen
                    </button>
                    <button
                        onClick={check}
                        className="btn-main bg-emerald-500 text-white text-xs">
                        Pr√ºfen <i className="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
        </section>
    );
}

/* ----- Shop ----- */

function Shop({profile,setProfile}) {
    const buy = (item)=>{
        if(profile.bought.includes(item.id)) return;
        if(profile.coins < item.price) return;
        const newProfile = {
            ...profile,
            coins: profile.coins - item.price,
            bought: [...profile.bought,item.id]
        };
        saveProfile(newProfile);
        setProfile(newProfile);
    };

    const equipAvatar = (item)=>{
        if(!profile.bought.includes(item.id) && item.price>0) return;
        const newProfile = {...profile,avatar:item.emoji};
        saveProfile(newProfile);
        setProfile(newProfile);
    };

    const cardClass = rarity=>{
        if(rarity==="legendary") return "shop-card shop-legendary";
        if(rarity==="epic") return "shop-card shop-epic";
        if(rarity==="rare") return "shop-card shop-rare";
        return "shop-card shop-common";
    };

    return (
        <section className="max-w-5xl mx-auto px-4 mt-6 mb-10">
            <h2 className="font-fun text-xl text-white mb-2 flex items-center gap-2">
                <i className="fa-solid fa-store text-amber-400"></i>
                Shop ‚Äì Tiere & Lern-Helfer
            </h2>
            <p className="text-slate-400 text-sm mb-4">
                Kaufe neue Tier-Avatare oder kleine Hilfen f√ºrs Lernen.
                Einige Dinge (z.B. Doppel-XP) gelten nur f√ºr die n√§chste Runde.
            </p>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                {shopItems.map(item=>{
                    const owned = profile.bought.includes(item.id) || item.price===0;
                    return (
                        <div key={item.id} className={cardClass(item.rarity)}>
                            <div className="flex items-center justify-between">
                                <div className="text-3xl">{item.emoji}</div>
                                <span className="text-[10px] uppercase tracking-wide text-slate-300">
                                    {item.type==="avatar"?"Avatar":item.type==="boost"?"Boost":"Thema"}
                                </span>
                            </div>
                            <div className="mt-1">
                                <div className="font-bold text-sm text-white">{item.name}</div>
                                <div className="text-[11px] text-slate-300">{item.desc}</div>
                            </div>
                            <div className="mt-2 flex items-center justify-between text-xs">
                                <span className="flex items-center gap-1 text-amber-300">
                                    <i className="fa-solid fa-coins text-amber-400"></i>
                                    {item.price}
                                </span>
                                {item.type==="avatar" ? (
                                    <div className="flex gap-1">
                                        <button
                                            onClick={()=>buy(item)}
                                            className="px-2 py-1 rounded-full bg-slate-800 text-slate-100 disabled:opacity-40"
                                            disabled={owned || profile.coins<item.price}>
                                            {owned?"Gekauft":"Kaufen"}
                                        </button>
                                        <button
                                            onClick={()=>equipAvatar(item)}
                                            className="px-2 py-1 rounded-full bg-indigo-500 text-white">
                                            Tragen
                                        </button>
                                    </div>
                                ):(
                                    <button
                                        onClick={()=>buy(item)}
                                        className="px-2 py-1 rounded-full bg-slate-800 text-slate-100 disabled:opacity-40"
                                        disabled={owned || profile.coins<item.price}>
                                        {owned?"Im Inventar":"Kaufen"}
                                    </button>
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>
        </section>
    );
}

/* ----- HAUPT-APP ----- */

function App(){
    const [words,setWords]=useState(fallbackWords);
    const [profile,setProfile]=useState(loadProfile());
    const [mode,setMode]=useState("memory");

    // JSON laden (falls vorhanden)
    useEffect(()=>{
        async function loadJson(){
            try{
                const res = await fetch("data/franz_words.json");
                if(!res.ok) return;
                const json = await res.json();
                if(Array.isArray(json.words)){
                    setWords(json.words);
                }else if(Array.isArray(json)){
                    setWords(json);
                }
            }catch(e){
                // Fallback bleibt
            }
        }
        loadJson();
    },[]);

    const addReward = ({xp,coins})=>{
        const newP = {...profile};
        if(xp) newP.xp = Math.max(0,newP.xp + xp);
        if(coins){
            newP.coins = Math.max(0,newP.coins + coins);
        }
        saveProfile(newP);
        setProfile(newP);
    };

    const resetAll = ()=>{
        if(!confirm("Wirklich alles l√∂schen? Level, M√ºnzen & Shop werden zur√ºckgesetzt.")) return;
        localStorage.removeItem("franz_profile_v1");
        setProfile(defaultProfile);
    };

    return (
        <div className="pb-10">
            <Header profile={profile} onReset={resetAll}/>
            <ModeTabs mode={mode} setMode={setMode}/>
            {mode==="memory" && <MemoryGame words={words} onReward={addReward}/>}
            {mode==="listen" && <ListenGame words={words} onResult={addReward}/>}
            {mode==="write" && <WriteGame words={words} onResult={addReward}/>}
            {mode==="shop" && <Shop profile={profile} setProfile={setProfile}/>}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
