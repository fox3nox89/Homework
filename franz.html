<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Galaxy ‚Äì 4. Klasse</title>

    <!-- ENGINE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Gemeinsames CSS (Hintergrund, Karten usw. von deiner index-Seite) -->
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #020617 55%, #000 100%);
            color: #e5e7eb;
            overflow-x: hidden;
        }

        .font-game {
            font-family: 'Baloo 2', cursive;
        }

        /* Sterne-Hintergrund */
        .stars {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
        }
        .star-dot {
            position: absolute;
            background: white;
            border-radius: 999px;
            opacity: 0.7;
            animation: twinkle 4s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Glas-Panel */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(18px);
        }

        /* Grosse Buttons */
        .big-btn {
            border-radius: 18px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 0.9rem 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 6px 0 rgba(0,0,0,0.4);
            transition: all 0.1s;
            border-bottom-width: 6px;
        }
        .big-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.4);
            border-bottom-width: 2px;
        }

        .btn-blue   { background: #3b82f6; border-color: #1d4ed8; color: white; }
        .btn-green  { background: #22c55e; border-color: #15803d; color: white; }
        .btn-purple { background: #8b5cf6; border-color: #6d28d9; color: white; }
        .btn-yellow { background: #eab308; border-color: #a16207; color: #111827; }
        .btn-red    { background: #ef4444; border-color: #b91c1c; color: white; }
        .btn-gray   { background: #1f2937; border-color: #111827; color: #e5e7eb; }

        /* Memory-Karten */
        .memory-scene {
            perspective: 1100px;
            height: 110px;
            cursor: pointer;
        }
        .memory-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.35s;
        }
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        .memory-face {
            position: absolute;
            inset: 0;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            border: 3px solid rgba(148, 163, 184, 0.5);
            backface-visibility: hidden;
        }
        .memory-front {
            background: linear-gradient(135deg, #4f46e5, #a855f7);
            color: white;
            font-size: 2.4rem;
        }
        .memory-back {
            background: #0f172a;
            transform: rotateY(180deg);
            font-size: 1.05rem;
            text-align: center;
            padding: 0.5rem;
        }
        .memory-back.fr {
            border-color: #3b82f6;
            color: #93c5fd;
        }
        .memory-back.de {
            border-color: #f97316;
            color: #fed7aa;
        }

        /* Shop-Karten */
        .shop-card {
            border-radius: 18px;
            padding: 0.9rem;
            border-width: 3px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .shop-card:active {
            transform: translateY(3px) scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        .shop-common {
            border-color: #9ca3af;
            background: #111827;
        }
        .shop-rare {
            border-color: #3b82f6;
            background: radial-gradient(circle at top, #1e3a8a, #020617);
        }
        .shop-epic {
            border-color: #a855f7;
            background: radial-gradient(circle at top, #581c87, #020617);
        }
        .shop-legendary {
            border-color: #eab308;
            background: radial-gradient(circle at top, #facc15, #92400e);
        }
        .owned-badge {
            font-size: 0.65rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(22, 163, 74, 0.2);
            border: 1px solid #22c55e;
            color: #bbf7d0;
        }

        /* Input */
        .input-field {
            background: #020617;
            border-radius: 16px;
            border: 2px solid #1f2937;
            color: #e5e7eb;
            padding: 0.8rem 1rem;
            font-size: 1.1rem;
            outline: none;
            width: 100%;
            text-align: center;
        }
        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }

        /* XP-Bar */
        .xp-track {
            height: 16px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            transition: width 0.4s ease-out;
        }

        /* Kleinzeug */
        .pill {
            border-radius: 999px;
            padding: 0.15rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .mode-tab {
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            font-size: 0.78rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        .mode-tab.active {
            background: #2563eb;
            border-color: #1d4ed8;
            color: white;
        }
        .mode-tab.inactive {
            background: #020617;
            border-color: #1f2937;
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="stars" id="stars"></div>

    <div id="root" class="min-h-screen flex items-center justify-center py-8 px-4"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Sterne erzeugen
        const starContainer = document.getElementById('stars');
        for (let i = 0; i < 70; i++) {
            const d = document.createElement('div');
            d.className = 'star-dot';
            const size = Math.random() * 3 + 1;
            d.style.width = size + 'px';
            d.style.height = size + 'px';
            d.style.top = Math.random() * 100 + '%';
            d.style.left = Math.random() * 100 + '%';
            d.style.animationDelay = (Math.random() * 5) + 's';
            starContainer.appendChild(d);
        }

        // --- Helper: Audio / Sprache ---
        const speak = (text, lang = 'fr-FR') => {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        };

        const playBeep = (type) => {
            const AC = window.AudioContext || window.webkitAudioContext;
            if (!AC) return;
            const ctx = new AC();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g);
            g.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'good') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1100, now + 0.2);
                g.gain.setValueAtTime(0.15, now);
                g.gain.linearRampToValueAtTime(0.0, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'bad') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                g.gain.setValueAtTime(0.18, now);
                g.gain.linearRampToValueAtTime(0.0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.35);
            }
        };

        const fireConfetti = () => {
            if (!window.confetti) return;
            window.confetti({
                particleCount: 80,
                spread: 70,
                origin: { y: 0.6 }
            });
        };

        // XP -> Level
        const levelThresholds = [0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200];

        const getLevelFromXP = (xp) => {
            let lvl = 1;
            for (let i = 0; i < levelThresholds.length; i++) {
                if (xp >= levelThresholds[i]) lvl = i + 1;
            }
            return lvl;
        };

        const getNextLevelXP = (lvl) => {
            if (lvl - 1 < levelThresholds.length) return levelThresholds[lvl - 1];
            return levelThresholds[levelThresholds.length - 1];
        };

        // Artikel aus deutschem Wort entfernen (f√ºr "le/la"-Fehler)
        const stripArticle = (s) => {
            if (!s) return '';
            const lower = s.toLowerCase().trim();
            const articles = ["der", "die", "das", "ein", "eine", "le", "la", "les", "un", "une", "des", "l'"];
            const parts = lower.split(/\s+/);
            if (articles.includes(parts[0])) {
                return parts.slice(1).join(' ');
            }
            return lower;
        };

        // --- Modes: Memory, H√∂r zu, Schreiben, Shop ---

        const MemoryMode = ({ words, onCorrectGain }) => {
            const [deck, setDeck] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);

            const buildDeck = () => {
                if (!words || words.length < 4) return;
                const pool = [...words].sort(() => Math.random() - 0.5).slice(0, 6);
                const tmp = [];
                pool.forEach((w, idx) => {
                    tmp.push({
                        id: 'fr-' + idx,
                        key: w.fr,
                        label: w.fr,
                        lang: 'fr'
                    });
                    tmp.push({
                        id: 'de-' + idx,
                        key: w.fr,
                        label: w.de,
                        lang: 'de'
                    });
                });
                const shuffled = tmp.sort(() => Math.random() - 0.5);
                setDeck(shuffled);
                setFlipped([]);
                setMatched([]);
            };

            useEffect(() => {
                buildDeck();
            }, [words]);

            const handleClick = (card) => {
                if (matched.includes(card.id)) return;
                if (flipped.find((c) => c.id === card.id)) return;
                if (flipped.length === 2) return;

                const newFlipped = [...flipped, card];
                setFlipped(newFlipped);

                if (card.lang === 'fr') {
                    speak(card.label, 'fr-FR');
                } else {
                    speak(card.label, 'de-DE');
                }

                if (newFlipped.length === 2) {
                    const [a, b] = newFlipped;
                    if (a.key === b.key && a.lang !== b.lang) {
                        // Match
                        setTimeout(() => {
                            setMatched((m) => [...m, a.id, b.id]);
                            setFlipped([]);
                            playBeep('good');
                            onCorrectGain(10, 5); // XP, Coins
                            if (matched.length + 2 === deck.length) {
                                fireConfetti();
                                setTimeout(buildDeck, 800);
                            }
                        }, 500);
                    } else {
                        // Kein Match
                        setTimeout(() => {
                            playBeep('bad');
                            setFlipped([]);
                        }, 800);
                    }
                }
            };

            return (
                <div className="space-y-4">
                    <h2 className="font-game text-2xl md:text-3xl font-black text-indigo-300 text-center">
                        üß† Memory ‚Äì Paare finden
                    </h2>
                    <p className="text-sm text-slate-300 text-center">
                        Tipp: Klick zuerst auf Franz√∂sisch (üá´üá∑), h√∂re zu, merk dir das Wort ‚Äì dann suche die deutsche Karte (üá©üá™).
                    </p>
                    <div className="grid grid-cols-3 sm:grid-cols-4 gap-3 mt-3">
                        {deck.map((card) => {
                            const isFlipped =
                                flipped.find((c) => c.id === card.id) || matched.includes(card.id);
                            return (
                                <div
                                    key={card.id}
                                    className="memory-scene"
                                    onClick={() => handleClick(card)}
                                >
                                    <div className={'memory-card ' + (isFlipped ? 'flipped' : '')}>
                                        <div className="memory-face memory-front">?</div>
                                        <div
                                            className={
                                                'memory-face memory-back ' +
                                                (card.lang === 'fr' ? 'fr' : 'de')
                                            }
                                        >
                                            <span className="text-xs opacity-70 mb-1 block">
                                                {card.lang === 'fr' ? 'FR' : 'DE'}
                                            </span>
                                            <span className="text-base sm:text-lg leading-tight">
                                                {card.label}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex justify-center mt-2">
                        <button
                            onClick={buildDeck}
                            className="big-btn btn-gray text-xs px-4 py-2"
                        >
                            Neu mischen
                        </button>
                    </div>
                </div>
            );
        };

        const ListenMode = ({ words, onCorrectGain }) => {
            const [current, setCurrent] = useState(null);
            const [options, setOptions] = useState([]);
            const [status, setStatus] = useState(null); // 'ok' | 'fail'
            const [attempts, setAttempts] = useState(0);

            const buildQuestion = () => {
                if (!words || words.length < 4) return;
                const all = [...words];
                const correct = all[Math.floor(Math.random() * all.length)];
                const others = all.filter((w) => w !== correct).sort(() => Math.random() - 0.5).slice(0, 3);
                const opts = [...others, correct].sort(() => Math.random() - 0.5);
                setCurrent(correct);
                setOptions(opts);
                setStatus(null);
                setAttempts(0);
                setTimeout(() => speak(correct.fr, 'fr-FR'), 100);
            };

            useEffect(() => {
                buildQuestion();
            }, [words]);

            const handleChoose = (opt) => {
                if (!current) return;
                const newAttempts = attempts + 1;
                setAttempts(newAttempts);

                if (opt.de === current.de) {
                    // Richtig
                    playBeep('good');
                    if (newAttempts === 1) {
                        onCorrectGain(8, 4); // Punkte nur bei 1. Versuch
                        setStatus({ type: 'ok', text: 'Richtig! Volle Punkte. üëå' });
                    } else {
                        setStatus({
                            type: 'ok',
                            text: 'Richtig ‚Äì aber ohne Punkte, weil du geraten hast.'
                        });
                    }
                    setTimeout(buildQuestion, 900);
                } else {
                    playBeep('bad');
                    setStatus({
                        type: 'fail',
                        text: 'Falsch. H√∂r nochmals gut hin und versuch es erneut.'
                    });
                }
            };

            if (!current) {
                return <p className="text-center text-slate-300">Lade W√∂rter...</p>;
            }

            return (
                <div className="space-y-4">
                    <h2 className="font-game text-2xl md:text-3xl font-black text-sky-300 text-center">
                        üëÇ H√∂r zu & w√§hle die Bedeutung
                    </h2>
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div className="text-sm text-slate-300">
                            <p>H√∂re das franz√∂sische Wort (üá´üá∑) und w√§hle die richtige deutsche Bedeutung.</p>
                            <p className="mt-1 text-xs text-slate-400">
                                Punkte gibt es nur, wenn du beim <strong>ersten Versuch</strong> richtig liegst.
                            </p>
                        </div>
                        <button
                            className="big-btn btn-blue text-xs"
                            onClick={() => speak(current.fr, 'fr-FR')}
                        >
                            Nochmal anh√∂ren <span>üîä</span>
                        </button>
                    </div>

                    <div className="glass-panel p-4 flex flex-col items-center gap-2">
                        <span className="uppercase text-xs tracking-[0.2em] text-slate-400">
                            Franz√∂sisches Wort
                        </span>
                        <div className="flex items-center gap-2">
                            <div className="px-4 py-2 rounded-full bg-indigo-600/30 border border-indigo-400/60 text-indigo-100 font-bold">
                                {current.fr}
                            </div>
                            <button
                                onClick={() => speak(current.fr, 'fr-FR')}
                                className="w-9 h-9 rounded-full bg-indigo-700 flex items-center justify-center text-white text-lg"
                            >
                                üîä
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {options.map((w, idx) => (
                            <button
                                key={idx}
                                onClick={() => handleChoose(w)}
                                className="w-full text-left shop-card shop-common flex items-center justify-between"
                            >
                                <div className="text-sm sm:text-base font-semibold">
                                    {w.de}
                                </div>
                                <button
                                    type="button"
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        speak(w.de, 'de-DE');
                                    }}
                                    className="ml-3 w-9 h-9 rounded-full bg-slate-800 flex items-center justify-center text-xs"
                                >
                                    üîä
                                </button>
                            </button>
                        ))}
                    </div>

                    {status && (
                        <div
                            className={
                                'mt-2 text-sm text-center font-semibold ' +
                                (status.type === 'ok' ? 'text-emerald-300' : 'text-rose-300')
                            }
                        >
                            {status.text}
                        </div>
                    )}
                </div>
            );
        };

        const WriteMode = ({ words, onCorrectGain }) => {
            const [current, setCurrent] = useState(null);
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [attempts, setAttempts] = useState(0);
            const [showSolutionCost] = useState(5); // M√ºnzen-Kosten f√ºr L√∂sung

            const buildQuestion = () => {
                if (!words || words.length === 0) return;
                const w = words[Math.floor(Math.random() * words.length)];
                setCurrent(w);
                setInput('');
                setFeedback(null);
                setAttempts(0);
            };

            useEffect(() => {
                buildQuestion();
            }, [words]);

            const handleCheck = () => {
                if (!current) return;
                const user = input.trim();
                if (!user) return;

                const correct = current.de;
                const normUser = user.toLowerCase();
                const normCorrect = correct.toLowerCase();

                const strippedUser = stripArticle(user);
                const strippedCorrect = stripArticle(correct);

                const sameMainWord = strippedUser === strippedCorrect;

                let msg = '';
                let ok = false;

                if (normUser === normCorrect) {
                    ok = true;
                    msg = 'Perfekt geschrieben! ‚úÖ';
                } else if (sameMainWord) {
                    ok = true;
                    msg =
                        'Das Hauptwort ist richtig, aber der Artikel ist nicht ganz korrekt. Trotzdem z√§hlt es als richtig ‚Äì achte auf der/die/das.';
                } else {
                    ok = false;
                    msg = 'Nicht ganz. Pr√ºfe nochmal Rechtschreibung und Bedeutung.';
                }

                const newAttempts = attempts + 1;
                setAttempts(newAttempts);

                if (ok) {
                    playBeep('good');
                    if (newAttempts === 1) {
                        onCorrectGain(10, 5);
                        msg += ' (Volle Punkte, 1. Versuch üëè)';
                    } else {
                        msg += ' (Richtig, aber ohne Punkte ‚Äì du hast probiert.)';
                    }
                } else {
                    playBeep('bad');
                }

                setFeedback({ ok, text: msg });

                if (ok) {
                    setTimeout(buildQuestion, 1200);
                }
            };

            const handleSolution = () => {
                // Nur Info anzeigen ‚Äì M√ºnzabzug wird im App-State gemacht
                if (!current) return;
                setFeedback({
                    ok: false,
                    text: `L√∂sung: "${current.de}". Versuche beim n√§chsten Mal wieder ohne Hilfe.`
                });
            };

            if (!current) {
                return <p className="text-center text-slate-300">Lade W√∂rter...</p>;
            }

            return (
                <div className="space-y-4">
                    <h2 className="font-game text-2xl md:text-3xl font-black text-rose-300 text-center">
                        ‚úèÔ∏è Schreiben ‚Äì Deutsch zum franz√∂sischen Wort
                    </h2>
                    <p className="text-sm text-slate-300 text-center max-w-xl mx-auto">
                        Du siehst das <span className="font-semibold text-indigo-200">franz√∂sische Wort</span> und schreibst das deutsche Wort.
                        Gross-/Kleinschreibung ist egal, aber versuch sie richtig zu schreiben.
                    </p>

                    <div className="glass-panel p-4 flex flex-col items-center gap-3">
                        <span className="uppercase text-xs tracking-[0.2em] text-slate-400">
                            Franz√∂sisches Wort
                        </span>
                        <div className="flex items-center gap-2 flex-wrap justify-center">
                            <div className="px-4 py-2 rounded-full bg-rose-600/30 border border-rose-400/60 text-rose-100 font-bold">
                                {current.fr}
                            </div>
                            <button
                                onClick={() => speak(current.fr, 'fr-FR')}
                                className="w-9 h-9 rounded-full bg-rose-700 flex items-center justify-center text-white text-lg"
                            >
                                üîä
                            </button>
                        </div>
                    </div>

                    <div className="space-y-3">
                        <input
                            className="input-field"
                            placeholder="Schreibe hier das deutsche Wort..."
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') handleCheck();
                            }}
                        />
                        <div className="flex flex-wrap gap-3 justify-center">
                            <button
                                onClick={handleCheck}
                                className="big-btn btn-purple text-xs px-6"
                            >
                                Pr√ºfen
                            </button>
                            <button
                                onClick={handleSolution}
                                className="big-btn btn-gray text-[0.68rem] px-4"
                            >
                                L√∂sung anzeigen (nur zur Kontrolle)
                            </button>
                        </div>
                    </div>

                    {feedback && (
                        <div
                            className={
                                'mt-1 text-sm text-center font-semibold ' +
                                (feedback.ok ? 'text-emerald-300' : 'text-amber-200')
                            }
                        >
                            {feedback.text}
                        </div>
                    )}
                </div>
            );
        };

        const ShopMode = ({ coins, owned, activeId, onBuy, onSelect }) => {
            const items = [
                { id: 'cat',    name: 'Katze',       emoji: 'üê±', cost: 20,  rarity: 'common' },
                { id: 'turtle', name: 'Schildkr√∂te', emoji: 'üê¢', cost: 25,  rarity: 'common' },
                { id: 'panda',  name: 'Panda',       emoji: 'üêº', cost: 40,  rarity: 'rare'   },
                { id: 'owl',    name: 'Eule',        emoji: 'ü¶â', cost: 50,  rarity: 'rare'   },
                { id: 'dragon', name: 'Drache',      emoji: 'üê≤', cost: 80,  rarity: 'epic'   },
                { id: 'alien',  name: 'Alien',       emoji: 'üëΩ', cost: 120, rarity: 'epic'   },
                // Fuchs & B√§r bewusst am Schluss (Special)
                { id: 'fox',    name: 'Fuchs',       emoji: 'ü¶ä', cost: 160, rarity: 'legendary' },
                { id: 'bear',   name: 'B√§r',         emoji: 'üêª', cost: 200, rarity: 'legendary' }
            ];

            const rarityLabel = {
                common: 'Normal',
                rare: 'Selten',
                epic: 'Episch',
                legendary: 'Legend√§r'
            };

            const rarityClass = {
                common: 'shop-common',
                rare: 'shop-rare',
                epic: 'shop-epic',
                legendary: 'shop-legendary'
            };

            return (
                <div className="space-y-4">
                    <h2 className="font-game text-2xl md:text-3xl font-black text-amber-300 text-center">
                        üõí Tier-Shop & Avatar
                    </h2>
                    <p className="text-sm text-slate-300 text-center max-w-xl mx-auto">
                        Gib deine M√ºnzen f√ºr Avatare aus. Legend√§re Tiere sind teuer und damit
                        etwas Besonderes. Kinder k√∂nnen den aktiven Avatar selbst ausw√§hlen.
                    </p>

                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-3">
                        {items.map((it) => {
                            const isOwned = owned.includes(it.id);
                            const isActive = activeId === it.id;
                            return (
                                <div
                                    key={it.id}
                                    className={
                                        'shop-card flex flex-col items-center text-center ' +
                                        rarityClass[it.rarity]
                                    }
                                    onClick={() => {
                                        if (isOwned) {
                                            onSelect(it.id);
                                        } else {
                                            onBuy(it);
                                        }
                                    }}
                                >
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-3xl">{it.emoji}</span>
                                        {isActive && (
                                            <span className="pill bg-emerald-500 text-xs text-slate-900">
                                                Aktiv
                                            </span>
                                        )}
                                    </div>
                                    <div className="font-bold text-sm">{it.name}</div>
                                    <div className="text-[0.7rem] text-slate-200 mt-1">
                                        {rarityLabel[it.rarity]}
                                    </div>
                                    <div className="mt-2 flex items-center gap-1 text-xs">
                                        <span className="text-amber-300 font-semibold">
                                            {it.cost}
                                        </span>
                                        <span>ü™ô</span>
                                    </div>
                                    <div className="mt-1">
                                        {isOwned ? (
                                            <span className="owned-badge">Gekauft</span>
                                        ) : null}
                                    </div>
                                    <div className="mt-2 text-[0.68rem] text-slate-300">
                                        Klick zum {isOwned ? 'Ausw√§hlen' : 'Kaufen'}.
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Haupt-App ---

        const App = () => {
            const [words, setWords] = useState([]);
            const [loading, setLoading] = useState(true);
            const [mode, setMode] = useState('menu'); // menu | memory | listen | write | shop

            const [xp, setXP] = useState(0);
            const [coins, setCoins] = useState(0);
            const [ownedAvatars, setOwnedAvatars] = useState(['cat']);
            const [activeAvatar, setActiveAvatar] = useState('cat');

            const level = getLevelFromXP(xp);
            const nextXP = getNextLevelXP(level);
            const prevXP = level > 1 ? getNextLevelXP(level - 1) : 0;
            const relXP = Math.max(xp - prevXP, 0);
            const spanXP = Math.max(nextXP - prevXP, 1);
            const xpPercent = Math.min(100, (relXP / spanXP) * 100);

            // Laden aus JSON
            useEffect(() => {
                fetch('data/franz_words.json')
                    .then((res) => res.json())
                    .then((data) => {
                        setWords(data);
                        setLoading(false);
                    })
                    .catch((err) => {
                        console.error(err);
                        setLoading(false);
                    });
            }, []);

            // Lokale Speicherung
            useEffect(() => {
                const saved = localStorage.getItem('franzProgressV1');
                if (saved) {
                    try {
                        const obj = JSON.parse(saved);
                        if (typeof obj.xp === 'number') setXP(obj.xp);
                        if (typeof obj.coins === 'number') setCoins(obj.coins);
                        if (Array.isArray(obj.ownedAvatars) && obj.ownedAvatars.length > 0)
                            setOwnedAvatars(obj.ownedAvatars);
                        if (obj.activeAvatar) setActiveAvatar(obj.activeAvatar);
                    } catch (e) {
                        console.warn('Konnte gespeicherten Fortschritt nicht lesen.');
                    }
                }
            }, []);

            useEffect(() => {
                const obj = {
                    xp,
                    coins,
                    ownedAvatars,
                    activeAvatar
                };
                localStorage.setItem('franzProgressV1', JSON.stringify(obj));
            }, [xp, coins, ownedAvatars, activeAvatar]);

            const addReward = (xpGain, coinGain) => {
                if (xpGain > 0) {
                    const newXP = xp + xpGain;
                    const oldLevel = getLevelFromXP(xp);
                    const newLevel = getLevelFromXP(newXP);
                    setXP(newXP);
                    if (newLevel > oldLevel) {
                        fireConfetti();
                    }
                }
                if (coinGain > 0) {
                    setCoins((c) => c + coinGain);
                }
            };

            const handleBuyAvatar = (item) => {
                if (ownedAvatars.includes(item.id)) {
                    setActiveAvatar(item.id);
                    return;
                }
                if (coins < item.cost) {
                    alert('Zu wenig M√ºnzen f√ºr dieses Tier.');
                    return;
                }
                if (!window.confirm(`"${item.name}" f√ºr ${item.cost} M√ºnzen kaufen?`)) return;
                setCoins((c) => c - item.cost);
                setOwnedAvatars((arr) => [...arr, item.id]);
                setActiveAvatar(item.id);
                playBeep('good');
            };

            const handleSelectAvatar = (id) => {
                if (!ownedAvatars.includes(id)) return;
                setActiveAvatar(id);
                playBeep('good');
            };

            const handleResetAll = () => {
                if (!window.confirm('Wirklich alles zur√ºcksetzen? Level, M√ºnzen, Shop?')) return;
                setXP(0);
                setCoins(0);
                setOwnedAvatars(['cat']);
                setActiveAvatar('cat');
                localStorage.removeItem('franzProgressV1');
            };

            const avatarEmoji = {
                cat: 'üê±',
                turtle: 'üê¢',
                panda: 'üêº',
                owl: 'ü¶â',
                dragon: 'üê≤',
                alien: 'üëΩ',
                fox: 'ü¶ä',
                bear: 'üêª'
            }[activeAvatar] || 'üê±';

            return (
                <div className="w-full max-w-5xl glass-panel p-4 sm:p-6 md:p-8">
                    {/* Header / Top-Bar */}
                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                        <div className="flex items-center gap-3">
                            <button
                                className="big-btn btn-gray text-xs px-3 py-2"
                                onClick={() => (window.location.href = 'index.html')}
                            >
                                ‚¨Ö Zur Startseite
                            </button>
                            <div>
                                <div className="flex items-center gap-2">
                                    <span className="text-2xl">{avatarEmoji}</span>
                                    <h1 className="font-game text-2xl sm:text-3xl font-black">
                                        Franz√∂sich-Galaxy
                                    </h1>
                                </div>
                                <p className="text-xs text-slate-400">
                                    4. Klasse ‚Äì H√∂rverstehen, Vokabeln, Schreiben & Shop
                                </p>
                            </div>
                        </div>
                        <div className="flex flex-col items-end gap-2">
                            <div className="flex items-center gap-3 text-xs">
                                <div className="flex items-center gap-1 pill bg-slate-900 text-slate-100">
                                    <span>Level</span>
                                    <span className="font-bold text-emerald-300">{level}</span>
                                </div>
                                <div className="flex items-center gap-1 pill bg-slate-900 text-amber-300">
                                    <span>{coins}</span>
                                    <span>ü™ô</span>
                                </div>
                            </div>
                            <div className="w-40">
                                <div className="xp-track">
                                    <div className="xp-fill" style={{ width: xpPercent + '%' }}></div>
                                </div>
                                <div className="flex justify-between text-[0.65rem] text-slate-400 mt-1">
                                    <span>{relXP} XP</span>
                                    <span>bis {nextXP} XP</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Mode Auswahl */}
                    <div className="mb-4 flex flex-wrap gap-2 justify-center">
                        <button
                            className={
                                'mode-tab ' +
                                (mode === 'menu' ? 'active' : 'inactive')
                            }
                            onClick={() => setMode('menu')}
                        >
                            Men√º
                        </button>
                        <button
                            className={
                                'mode-tab ' +
                                (mode === 'memory' ? 'active' : 'inactive')
                            }
                            onClick={() => setMode('memory')}
                        >
                            Memory
                        </button>
                        <button
                            className={
                                'mode-tab ' +
                                (mode === 'listen' ? 'active' : 'inactive')
                            }
                            onClick={() => setMode('listen')}
                        >
                            H√∂r zu
                        </button>
                        <button
                            className={
                                'mode-tab ' +
                                (mode === 'write' ? 'active' : 'inactive')
                            }
                            onClick={() => setMode('write')}
                        >
                            Schreiben
                        </button>
                        <button
                            className={
                                'mode-tab ' +
                                (mode === 'shop' ? 'active' : 'inactive')
                            }
                            onClick={() => setMode('shop')}
                        >
                            Shop
                        </button>
                        <button
                            className="mode-tab inactive"
                            onClick={handleResetAll}
                        >
                            Alles zur√ºcksetzen
                        </button>
                    </div>

                    {/* Inhalt */}
                    {loading ? (
                        <div className="py-10 text-center text-slate-300">
                            Lade W√∂rter aus <code>data/franz_words.json</code>...
                        </div>
                    ) : words.length === 0 ? (
                        <div className="py-10 text-center text-rose-300">
                            Keine W√∂rter gefunden. Pr√ºfe, ob <code>data/franz_words.json</code> existiert
                            und g√ºltiges JSON enth√§lt.
                        </div>
                    ) : (
                        <div className="mt-2">
                            {mode === 'menu' && (
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <button
                                        className="big-btn btn-blue flex-col items-start h-full"
                                        onClick={() => setMode('memory')}
                                    >
                                        <span className="text-xl">üß† Memory</span>
                                        <span className="text-xs opacity-90">
                                            Finde zusammengeh√∂rende Paare (FR‚ÄìDE).
                                        </span>
                                    </button>
                                    <button
                                        className="big-btn btn-green flex-col items-start h-full"
                                        onClick={() => setMode('listen')}
                                    >
                                        <span className="text-xl">üëÇ H√∂r zu</span>
                                        <span className="text-xs opacity-90">
                                            H√∂re Franz√∂sisch und w√§hle die richtige Bedeutung.
                                        </span>
                                    </button>
                                    <button
                                        className="big-btn btn-purple flex-col items-start h-full"
                                        onClick={() => setMode('write')}
                                    >
                                        <span className="text-xl">‚úèÔ∏è Schreiben</span>
                                        <span className="text-xs opacity-90">
                                            Schreib das deutsche Wort zum franz√∂sischen Wort.
                                        </span>
                                    </button>
                                    <button
                                        className="big-btn btn-yellow flex-col items-start h-full"
                                        onClick={() => setMode('shop')}
                                    >
                                        <span className="text-xl">üõí Shop</span>
                                        <span className="text-xs opacity-90">
                                            Kaufe Avatare mit M√ºnzen aus den √úbungen.
                                        </span>
                                    </button>
                                </div>
                            )}

                            {mode === 'memory' && (
                                <MemoryMode words={words} onCorrectGain={addReward} />
                            )}
                            {mode === 'listen' && (
                                <ListenMode words={words} onCorrectGain={addReward} />
                            )}
                            {mode === 'write' && (
                                <WriteMode words={words} onCorrectGain={addReward} />
                            )}
                            {mode === 'shop' && (
                                <ShopMode
                                    coins={coins}
                                    owned={ownedAvatars}
                                    activeId={activeAvatar}
                                    onBuy={handleBuyAvatar}
                                    onSelect={handleSelectAvatar}
                                />
                            )}
                        </div>
                    )}

                    <div className="mt-6 text-[0.7rem] text-slate-500 text-center">
                        Tipp f√ºr dich: Wenn du sp√§ter neue W√∂rter in <code>data/franz_words.json</code>{' '}
                        eintr√§gst, erscheinen sie automatisch in allen Modi (Memory, H√∂r zu, Schreiben).
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
