<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch ‚Äì LernCampus</title>

    <!-- ENGINE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #020617;
            --panel: rgba(15, 23, 42, 0.94);
            --accent: #6366f1;
            --accent2: #22c55e;
            --danger: #ef4444;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #020617 55%, #000 100%);
            color: #e5e7eb;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .font-game { font-family: 'Baloo 2', cursive; }

        /* Sterne-Hintergrund */
        .stars { position: fixed; inset: 0; overflow: hidden; z-index: -1; }
        .star {
            position: absolute; border-radius: 999px; background: white;
            opacity: 0.4; animation: twinkle 4s infinite;
        }
        @keyframes twinkle {
            0%,100% { opacity: 0.2; transform: scale(0.7);}
            50% { opacity: 1; transform: scale(1.2);}
        }

        /* Glas-Panel */
        .glass {
            background: var(--panel);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(18px);
        }

        .btn {
            border-radius: 999px;
            padding: 0.75rem 1.4rem;
            font-weight: 800;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-bottom-width: 4px;
            box-shadow: 0 6px 0 rgba(15,23,42,0.7);
            transition: transform 0.08s, box-shadow 0.08s, background 0.2s;
            cursor: pointer;
        }
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(15,23,42,0.9);
        }
        .btn-blue { background: #3b82f6; border-color: #1d4ed8; color: white; }
        .btn-green { background: #22c55e; border-color: #15803d; color: white; }
        .btn-red   { background: #ef4444; border-color: #b91c1c; color: white; }
        .btn-gray  { background: #0f172a; border-color: #020617; color: #cbd5f5; }

        /* Memory Karten */
        .memory-scene {
            perspective: 1000px;
            height: 120px;
            cursor: pointer;
        }
        .memory-card {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.45s;
        }
        .memory-card.flipped { transform: rotateY(180deg); }
        .memory-card.matched { animation: popOut 0.45s forwards; pointer-events: none; }
        .memory-face {
            position: absolute; inset: 0;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 18px;
            border: 2px solid rgba(148,163,184,0.4);
            box-shadow: 0 6px 18px rgba(15,23,42,0.6);
            display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 8px;
        }
        .memory-front {
            background: radial-gradient(circle at top left, #4f46e5, #0f172a);
            font-size: 2.2rem;
        }
        .memory-back {
            background: #020617;
            transform: rotateY(180deg);
            font-size: 1.35rem;
            font-weight: 800;
        }
        .memory-back.fr { border-color: #3b82f6; color: #bfdbfe; }
        .memory-back.de { border-color: #fb923c; color: #fed7aa; }

        @keyframes popOut {
            0% { transform: scale(1) rotateY(180deg); opacity: 1; }
            50% { transform: scale(1.15) rotateY(180deg); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* XP-Bar */
        .xp-track {
            height: 14px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(148,163,184,0.4);
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #3b82f6);
            transition: width 0.6s ease-out;
        }

        /* Rad (Gl√ºcksrad) */
        .wheel {
            position: relative;
            width: 240px;
            height: 240px;
            border-radius: 50%;
            border: 6px solid #0f172a;
            overflow: hidden;
            box-shadow: 0 18px 40px rgba(15,23,42,0.9);
        }
        .wheel-inner {
            width: 100%; height: 100%;
            border-radius: 50%;
            background-image:
                conic-gradient(
                    #1d4ed8 0deg 60deg,
                    #16a34a 60deg 120deg,
                    #f97316 120deg 180deg,
                    #eab308 180deg 240deg,
                    #a855f7 240deg 300deg,
                    #ef4444 300deg 360deg
                );
            position: relative;
            transition: transform 4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .wheel-label {
            position: absolute;
            width: 50%; height: 50%;
            top: 50%; left: 50%;
            transform-origin: 0% 0%;
            display: flex; align-items: center; justify-content: flex-end;
            padding-right: 12px;
            font-weight: 900;
            font-size: 0.85rem;
            color: #0f172a;
            text-shadow: 0 1px 2px rgba(255,255,255,0.7);
        }
        .wheel-pointer {
            position: absolute;
            top: -16px; left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #eab308;
            filter: drop-shadow(0 4px 8px rgba(234,179,8,0.7));
        }

        .pop-in {
            animation: popIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { transform: scale(0.7); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }
        .shake {
            animation: shake 0.35s both;
        }
        @keyframes shake {
            10%,90% { transform: translateX(-1px); }
            20%,80% { transform: translateX(2px); }
            30%,50%,70% { transform: translateX(-4px); }
            40%,60% { transform: translateX(4px); }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 40;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen">

<div class="stars" id="stars"></div>

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* Sterne erzeugen */
(() => {
    const c = document.getElementById('stars');
    for (let i = 0; i < 70; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        const size = Math.random() * 2.5 + 1;
        s.style.width = size + 'px';
        s.style.height = size + 'px';
        s.style.top = Math.random() * 100 + '%';
        s.style.left = Math.random() * 100 + '%';
        s.style.animationDelay = (Math.random() * 4) + 's';
        c.appendChild(s);
    }
})();

/* Daten ‚Äì Wortlisten (kannst du sp√§ter beliebig erweitern) */
const WORD_GROUPS = {
    basis: [
        { fr: "Bonjour",     de: "Guten Tag" },
        { fr: "Salut",       de: "Hallo" },
        { fr: "Au revoir",   de: "Auf Wiedersehen" },
        { fr: "Merci",       de: "Danke" },
        { fr: "S'il vous pla√Æt", de: "Bitte" },
        { fr: "Oui",         de: "Ja" },
        { fr: "Non",         de: "Nein" },
        { fr: "Je",          de: "Ich" },
        { fr: "Tu",          de: "Du" },
        { fr: "Il",          de: "Er" },
        { fr: "Elle",        de: "Sie" }
    ],
    struktur: [
        { fr: "D'abord",     de: "Zuerst" },
        { fr: "Puis",        de: "Dann" },
        { fr: "Apr√®s",       de: "Danach" },
        { fr: "Finalement",  de: "Schliesslich" },
        { fr: "Toujours",    de: "Immer" },
        { fr: "Jamais",      de: "Nie" },
        { fr: "Peut-√™tre",   de: "Vielleicht" }
    ],
    schule: [
        { fr:"L'√©cole",   de:"Die Schule" },
        { fr:"Le livre",  de:"Das Buch" },
        { fr:"Le cahier", de:"Das Heft" },
        { fr:"Le crayon", de:"Der Bleistift" },
        { fr:"La gomme",  de:"Der Gummi" },
        { fr:"La trousse",de:"Das Etui" },
        { fr:"La classe", de:"Die Klasse" },
        { fr:"Le devoir", de:"Die Hausaufgabe" }
    ],
    tiere: [
        { fr:"Le chien",  de:"Der Hund" },
        { fr:"Le chat",   de:"Die Katze" },
        { fr:"La souris", de:"Die Maus" },
        { fr:"L'oiseau",  de:"Der Vogel" },
        { fr:"Le cheval", de:"Das Pferd" },
        { fr:"La vache",  de:"Die Kuh" },
        { fr:"Le cochon", de:"Das Schwein" },
        { fr:"Le lion",   de:"Der L√∂we" }
    ]
};

/* Shop-Avatare mit Rarit√§t ‚Äì Bear & Fox am Schluss (legendary) */
const AVATARS = [
    { id:"chick", icon:"üê•", name:"K√ºken", rarity:"common",    cost:50 },
    { id:"fish",  icon:"üêü", name:"Fisch", rarity:"common",    cost:80 },
    { id:"bunny", icon:"üê∞", name:"Hase",  rarity:"rare",      cost:150 },
    { id:"owl",   icon:"ü¶â", name:"Eule",  rarity:"rare",      cost:200 },
    { id:"dragon",icon:"üê≤", name:"Drache",rarity:"epic",      cost:500 },
    { id:"unicorn",icon:"ü¶Ñ",name:"Einhorn",rarity:"epic",     cost:700 },
    { id:"fox",   icon:"ü¶ä", name:"Fuchs", rarity:"legendary", cost:1200 },
    { id:"bear",  icon:"üêª", name:"B√§r",   rarity:"legendary", cost:1500 }
];

/* Lern-Items im Shop */
const ITEMS = [
    { id:"hintPack", name:"Hinweis-Paket (+5 Hinweise)", type:"hints", cost:200 },
    { id:"doubleXP10", name:"Double XP (10 Runden)", type:"doubleXP", cost:350 },
    { id:"heartRefill", name:"Herzen auff√ºllen", type:"hearts", cost:120 }
];

/* Gl√ºcksrad Felder */
const WHEEL_SEGMENTS = [
    { id:"coins50",   label:"+50 üí∞",  effect:{ coins:50 } },
    { id:"coins150",  label:"+150 üí∞", effect:{ coins:150 } },
    { id:"xp100",     label:"+100 XP", effect:{ xp:100 } },
    { id:"doubleXP",  label:"Double XP (5)", effect:{ doubleXP:5 } },
    { id:"hint2",     label:"+2 Hinweise",   effect:{ hints:2 } },
    { id:"avatarFox", label:"ü¶ä Fuchs!",     effect:{ unlockAvatar:"fox" } }
];

/* Helper: Audio (FR & DE) */
const speak = (text, lang="fr") => {
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang === "fr" ? "fr-FR" : "de-DE";
    u.rate = lang === "fr" ? 0.9 : 0.95;
    window.speechSynthesis.speak(u);
};

/* Soundeffekte (Beep) */
const playSound = (type) => {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    const ctx = new AC();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    const now = ctx.currentTime;
    if (type === "correct") {
        osc.type = "triangle";
        osc.frequency.setValueAtTime(700, now);
        osc.frequency.linearRampToValueAtTime(1100, now+0.12);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.linearRampToValueAtTime(0, now+0.4);
    } else if (type === "wrong") {
        osc.type = "sawtooth";
        osc.frequency.setValueAtTime(200, now);
        gain.gain.setValueAtTime(0.18, now);
        gain.gain.linearRampToValueAtTime(0, now+0.35);
    } else if (type === "win") {
        [440,660,880].forEach((f,i) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = "square";
            o.frequency.value = f;
            g.gain.setValueAtTime(0.12, now + i*0.15);
            g.gain.linearRampToValueAtTime(0, now + i*0.15 + 0.4);
            o.start(now + i*0.15);
            o.stop(now + i*0.15 + 0.4);
        });
        osc.disconnect(); gain.disconnect();
        return;
    }
    osc.start(now);
    osc.stop(now+0.5);
};

const fireConfetti = () => {
    if (window.confetti) window.confetti({ particleCount: 90, spread: 70, origin: { y: 0.7 } });
};

/* XP / Level */
const XP_FOR_LEVEL = lvl => 200 * lvl;
const MAX_LEVEL = 20;

/* Header */
const Header = ({ user, onReset }) => {
    const nextXP = XP_FOR_LEVEL(user.level+1);
    const progress = Math.min(100, (user.xp / nextXP) * 100);
    const avatar = AVATARS.find(a => a.id === user.avatar) || AVATARS[0];

    return (
        <header className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
                <div className="text-4xl bg-slate-900/70 rounded-2xl p-2 border border-slate-700">
                    {avatar.icon}
                </div>
                <div>
                    <div className="font-game text-lg font-extrabold">
                        {user.name || "Pilot"} ‚Ä¢ Lvl {user.level}
                    </div>
                    <div className="text-xs text-slate-400 mb-1">
                        XP: {user.xp} / {nextXP}
                    </div>
                    <div className="xp-track w-40">
                        <div className="xp-fill" style={{ width: progress + "%" }}></div>
                    </div>
                </div>
            </div>

            <div className="flex flex-col items-end gap-1">
                <div className="flex items-center gap-3 bg-slate-900/70 px-3 py-2 rounded-2xl border border-slate-700">
                    <span className="font-bold text-amber-300">{user.coins} üí∞</span>
                    <span className="text-xs text-sky-300">
                        Hinweise: {user.hints} üîç
                    </span>
                </div>
                <div className="flex gap-2">
                    <a href="index.html" className="btn btn-gray text-xs no-underline">
                        üè† Startseite
                    </a>
                    <button className="btn btn-red text-xs" onClick={onReset}>
                        Reset alles
                    </button>
                </div>
            </div>
        </header>
    );
};

/* Modus-Auswahl + Themen-Auswahl */
const ModeMenu = ({ mode, setMode, group, setGroup }) => {
    const modes = [
        { id:"memory", label:"Memory", icon:"üß†" },
        { id:"listen", label:"H√∂r zu", icon:"üëÇ" },
        { id:"write",  label:"Schreiben", icon:"‚úçÔ∏è" },
        { id:"listenOnly", label:"Anh√∂ren", icon:"üéß" },
        { id:"shop",   label:"Shop", icon:"üõí" },
        { id:"wheel",  label:"Gl√ºcksrad", icon:"üé°" }
    ];
    const groups = [
        { id:"basis",   label:"Basis" },
        { id:"struktur",label:"Struktur" },
        { id:"schule",  label:"Schule" },
        { id:"tiere",   label:"Tiere" }
    ];

    return (
        <>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                {modes.map(m => (
                    <button
                        key={m.id}
                        onClick={() => setMode(m.id)}
                        className={
                            "glass px-3 py-3 flex flex-col items-center justify-center text-center cursor-pointer transition " +
                            (mode === m.id ? "ring-2 ring-indigo-400 bg-indigo-900/40" : "bg-slate-900/80 hover:bg-slate-800/80")
                        }
                    >
                        <div className="text-2xl mb-1">{m.icon}</div>
                        <div className="font-game font-extrabold text-sm">{m.label}</div>
                    </button>
                ))}
            </div>

            <div className="mb-4">
                <div className="text-xs uppercase tracking-wide text-slate-400 mb-2 font-bold">Wort-Thema</div>
                <div className="flex flex-wrap gap-2">
                    {groups.map(g => (
                        <button
                            key={g.id}
                            onClick={() => setGroup(g.id)}
                            className={
                                "px-3 py-1 rounded-2xl text-xs font-bold border " +
                                (group === g.id
                                    ? "bg-sky-500 text-slate-900 border-sky-300"
                                    : "bg-slate-900 text-slate-300 border-slate-700 hover:bg-slate-800")
                            }
                        >
                            {g.label}
                        </button>
                    ))}
                </div>
            </div>
        </>
    );
};

/* Memory-Spiel */
const MemoryGame = ({ words, onFinish }) => {
    const [cards, setCards] = useState([]);
    const [flipped, setFlipped] = useState([]);
    const [matched, setMatched] = useState([]);
    const [locked, setLocked] = useState(false);
    const [hearts, setHearts] = useState(3);

    useEffect(() => {
        const base = words.slice(0, 8); // max 8 Paare
        const deck = base.flatMap(w => ([
            { id: w.fr + "-fr", key: w.fr, txt: w.fr, type: "fr" },
            { id: w.fr + "-de", key: w.fr, txt: w.de, type: "de" }
        ]));
        deck.sort(() => Math.random() - 0.5);
        setCards(deck);
        setFlipped([]);
        setMatched([]);
        setHearts(3);
    }, [words]);

    const handleClick = (card) => {
        if (locked) return;
        if (matched.includes(card.id)) return;
        if (flipped.includes(card.id)) return;

        const newFlipped = [...flipped, card.id];
        setFlipped(newFlipped);

        // Audio beim Aufdecken
        if (card.type === "fr") speak(card.txt, "fr");
        else speak(card.txt, "de");

        if (newFlipped.length === 2) {
            setLocked(true);
            const c1 = cards.find(c => c.id === newFlipped[0]);
            const c2 = cards.find(c => c.id === newFlipped[1]);
            if (c1.key === c2.key && c1.type !== c2.type) {
                playSound("correct");
                setTimeout(() => {
                    setMatched(prev => [...prev, c1.id, c2.id]);
                    setFlipped([]);
                    setLocked(false);
                    if (matched.length + 2 === cards.length) {
                        onFinish({ xp: 80, coins: 40 }); // Bonus f√ºrs komplette Board
                    }
                }, 600);
            } else {
                playSound("wrong");
                setTimeout(() => {
                    setFlipped([]);
                    setLocked(false);
                    setHearts(h => {
                        const nh = h - 1;
                        return nh;
                    });
                }, 800);
            }
        }
    };

    useEffect(() => {
        if (hearts <= 0) {
            // Runde vorbei
            onFinish({ xp: 10, coins: 5 }); // kleiner Trost
        }
    }, [hearts]);

    return (
        <div className="glass p-4 pop-in">
            <div className="flex justify-between items-center mb-2">
                <div className="font-game text-lg font-extrabold flex items-center gap-2">
                    üß† Memory
                </div>
                <div className="flex items-center gap-1 text-rose-400 text-lg">
                    {Array.from({ length: 3 }, (_, i) => (
                        <span key={i}>{i < hearts ? "‚ù§Ô∏è" : "ü©∂"}</span>
                    ))}
                </div>
            </div>
            <p className="text-xs text-slate-400 mb-3">
                Tipp: Versuche dir die Position von Franz√∂sisch und Deutsch zu merken. Falsche Paare kosten ein Herz.
            </p>
            <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
                {cards.map(card => (
                    <div key={card.id} className="memory-scene" onClick={() => handleClick(card)}>
                        <div className={
                            "memory-card " +
                            (flipped.includes(card.id) || matched.includes(card.id) ? "flipped" : "") +
                            (matched.includes(card.id) ? " matched" : "")
                        }>
                            <div className="memory-face memory-front">?</div>
                            <div className={
                                "memory-face memory-back " + (card.type === "fr" ? "fr" : "de")
                            }>
                                <span>{card.txt}</span>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

/* H√∂r zu ‚Äì Multiple Choice, Anti-Cheat */
const ListenGame = ({ words, onFinish }) => {
    const [index, setIndex] = useState(0);
    const [current, setCurrent] = useState(null);
    const [options, setOptions] = useState([]);
    const [hearts, setHearts] = useState(3);
    const [round, setRound] = useState(1);
    const [feedback, setFeedback] = useState(null);

    useEffect(() => {
        setupQuestion();
    }, [round]);

    const setupQuestion = () => {
        const pool = [...words];
        const target = pool[Math.floor(Math.random()*pool.length)];
        const others = pool.filter(w => w !== target);
        const opt = [target, ...others.sort(() => Math.random() - 0.5).slice(0,3)];
        opt.sort(() => Math.random() - 0.5);
        setCurrent(target);
        setOptions(opt);
        setFeedback(null);
        setIndex(prev => prev + 1);
    };

    const handleAnswer = (w) => {
        if (!current) return;
        if (feedback === "correct") return;

        if (w.de === current.de) {
            playSound("correct");
            setFeedback("correct");
            const gained = { xp: 20, coins: 8 };
            onFinish(gained, false); // kein sofortiges Ende, XP wird gesammelt im App
            setTimeout(() => {
                if (index >= 10) {
                    onFinish({ xp: 40, coins: 20 }, true); // Bonus nach 10 Fragen
                } else {
                    setRound(r => r+1);
                }
            }, 600);
        } else {
            playSound("wrong");
            setHearts(h => h - 1);
            setFeedback("wrong");
            setTimeout(() => {
                setFeedback(null);
            }, 600);
        }
    };

    useEffect(() => {
        if (hearts <= 0) {
            onFinish({ xp: 10, coins: 5 }, true);
        }
    }, [hearts]);

    if (!current) return null;
    return (
        <div className="glass p-4 pop-in">
            <div className="flex justify-between items-center mb-2">
                <div className="font-game text-lg font-extrabold flex items-center gap-2">
                    üëÇ H√∂r zu ‚Äì Frage {index}/10
                </div>
                <div className="flex items-center gap-1 text-rose-400 text-lg">
                    {Array.from({ length: 3 }, (_, i) => (
                        <span key={i}>{i < hearts ? "‚ù§Ô∏è" : "ü©∂"}</span>
                    ))}
                </div>
            </div>
            <p className="text-xs text-slate-400 mb-3">
                H√∂re das franz√∂sische Wort und tippe auf die richtige deutsche Bedeutung. Falsche Antworten kosten ein Herz.
            </p>
            <div className="flex flex-col items-center mb-4">
                <button
                    className="btn btn-blue mb-2"
                    onClick={() => speak(current.fr, "fr")}
                >
                    üîä Franz√∂sisches Wort anh√∂ren
                </button>
                <button
                    className="btn btn-gray text-xs"
                    onClick={() => speak(current.de, "de")}
                >
                    üîä Deutsche √úbersetzung anh√∂ren
                </button>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {options.map(o => (
                    <button
                        key={o.fr + o.de}
                        className={
                            "glass px-3 py-3 text-sm font-bold text-center cursor-pointer transition " +
                            (feedback && o.de === current.de && feedback === "correct"
                                ? "bg-emerald-600/80 border border-emerald-300"
                                : "bg-slate-900/80 hover:bg-slate-800/80")
                        }
                        onClick={() => handleAnswer(o)}
                    >
                        {o.de}
                    </button>
                ))}
            </div>
        </div>
    );
};

/* Schreiben ‚Äì FR anzeigen, DE tippen, Hinweise kosten M√ºnzen */
const WriteGame = ({ words, user, onResult }) => {
    const [index, setIndex] = useState(0);
    const [current, setCurrent] = useState(words[0]);
    const [answer, setAnswer] = useState("");
    const [hearts, setHearts] = useState(3);
    const [streak, setStreak] = useState(0);
    const [usedHint, setUsedHint] = useState(false);
    const [shake, setShake] = useState(false);

    useEffect(() => {
        setCurrent(words[index % words.length]);
        setAnswer("");
        setUsedHint(false);
    }, [index, words]);

    const normalize = (str) =>
        (str || "").toLowerCase().trim()
        .replace(/\s+/g," ");

    const handleCheck = () => {
        if (!current) return;
        const sol = normalize(current.de);
        const usr = normalize(answer);
        if (!usr) return;

        if (usr === sol) {
            playSound("correct");
            const baseXP = 25;
            const baseCoins = usedHint ? 5 : 10;
            const gain = { xp: baseXP, coins: baseCoins };
            setStreak(s => s+1);
            onResult(gain);
            if ((index+1) >= 10) {
                onResult({ xp: 40, coins: 20 }); // kleiner Abschlussbonus
                setIndex(0);
            } else {
                setIndex(i => i+1);
            }
        } else {
            playSound("wrong");
            setShake(true);
            setTimeout(() => setShake(false), 250);
            setHearts(h => h-1);
            setStreak(0);
            if (hearts-1 <= 0) {
                onResult({ xp: 10, coins: 5 }); // Trost
                setIndex(0);
                setHearts(3);
            }
        }
    };

    const useHint = () => {
        if (user.coins < 20) {
            alert("Zu wenig M√ºnzen f√ºr einen Tipp (20 üí∞).");
            return;
        }
        if (usedHint) return;
        setUsedHint(true);
        onResult({ xp: 0, coins: -20 }); // M√ºnzen abziehen
        alert("Tipp: " + current.de);
    };

    if (!current) return null;

    return (
        <div className={"glass p-4 pop-in " + (shake ? "shake" : "")}>
            <div className="flex justify-between items-center mb-2">
                <div className="font-game text-lg font-extrabold flex items-center gap-2">
                    ‚úçÔ∏è Schreiben
                </div>
                <div className="flex items-center gap-2 text-sm">
                    <span className="text-rose-400">
                        {Array.from({ length: 3 }, (_, i) => (
                            <span key={i}>{i < hearts ? "‚ù§Ô∏è" : "ü©∂"}</span>
                        ))}
                    </span>
                    <span className="text-amber-300">
                        Streak: {streak}
                    </span>
                </div>
            </div>
            <p className="text-xs text-slate-400 mb-3">
                Schreibe die deutsche Bedeutung des franz√∂sischen Wortes. Tipp kostet M√ºnzen und gibt weniger Belohnung.
            </p>

            <div className="flex flex-col items-center mb-4">
                <div className="font-game text-3xl mb-2 text-sky-300 text-center">
                    {current.fr}
                </div>
                <div className="flex gap-2">
                    <button className="btn btn-blue" onClick={() => speak(current.fr,"fr")}>
                        üîä Franz√∂sisch
                    </button>
                    <button className="btn btn-gray text-xs" onClick={() => speak(current.de,"de")}>
                        üîä Deutsch
                    </button>
                </div>
            </div>

            <input
                className="w-full bg-slate-900 border border-slate-700 rounded-2xl px-3 py-2 text-center text-lg font-bold outline-none focus:ring-2 focus:ring-sky-500 mb-3"
                placeholder="Deutsches Wort..."
                value={answer}
                onChange={e => setAnswer(e.target.value)}
                onKeyDown={e => e.key === "Enter" && handleCheck()}
            />

            <div className="flex justify-between items-center">
                <button className="btn btn-green" onClick={handleCheck}>
                    Pr√ºfen
                </button>
                <button className="btn btn-red text-xs" onClick={useHint}>
                    Tipp (20 üí∞)
                </button>
            </div>
        </div>
    );
};

/* Reiner Anh√∂ren-Modus */
const ListenOnly = ({ words }) => {
    const [index, setIndex] = useState(0);
    const current = words[index % words.length];

    if (!current) return null;
    const next = () => setIndex(i => (i+1) % words.length);

    const playBoth = () => {
        speak(current.fr,"fr");
        setTimeout(() => speak(current.de,"de"), 900);
    };

    return (
        <div className="glass p-4 pop-in">
            <div className="flex justify-between items-center mb-2">
                <div className="font-game text-lg font-extrabold flex items-center gap-2">
                    üéß Anh√∂ren ({index+1}/{words.length})
                </div>
            </div>
            <p className="text-xs text-slate-400 mb-3">
                H√∂re zuerst das franz√∂sische Wort und danach die deutsche √úbersetzung.
            </p>
            <div className="flex flex-col items-center gap-3 mb-4">
                <div className="text-3xl font-game text-sky-300">{current.fr}</div>
                <div className="text-sm text-slate-400">{current.de}</div>
                <div className="flex gap-2">
                    <button className="btn btn-blue" onClick={() => speak(current.fr,"fr")}>
                        üîä Franz√∂sisch
                    </button>
                    <button className="btn btn-gray text-xs" onClick={() => speak(current.de,"de")}>
                        üîä Deutsch
                    </button>
                    <button className="btn btn-green text-xs" onClick={playBoth}>
                        üîä Beide
                    </button>
                </div>
            </div>
            <button className="btn btn-blue w-full" onClick={next}>
                N√§chstes Wort ‚Üí
            </button>
        </div>
    );
};

/* Shop */
const Shop = ({ user, onUpdateUser }) => {
    const buyAvatar = (av) => {
        if (user.avatars.includes(av.id)) {
            onUpdateUser({ avatar: av.id });
            playSound("correct");
            return;
        }
        if (user.coins < av.cost) {
            alert("Zu wenig M√ºnzen.");
            return;
        }
        onUpdateUser({
            coins: user.coins - av.cost,
            avatar: av.id,
            avatars: [...user.avatars, av.id]
        });
        playSound("win");
        fireConfetti();
    };

    const buyItem = (it) => {
        if (user.coins < it.cost) {
            alert("Zu wenig M√ºnzen.");
            return;
        }
        const changes = { coins: user.coins - it.cost };
        if (it.type === "hints") changes.hints = user.hints + 5;
        if (it.type === "doubleXP")
            changes.doubleXP = (user.doubleXP || 0) + 10;
        if (it.type === "hearts")
            changes.bonusHearts = (user.bonusHearts || 0) + 1;
        onUpdateUser(changes);
        playSound("correct");
    };

    const rarityClass = r => {
        if (r === "common") return "border-slate-500 bg-slate-900/80";
        if (r === "rare") return "border-sky-400 bg-sky-900/30";
        if (r === "epic") return "border-purple-400 bg-purple-900/30";
        return "border-amber-400 bg-amber-900/30";
    };

    return (
        <div className="grid sm:grid-cols-2 gap-3 pop-in">
            <div className="glass p-4">
                <h2 className="font-game text-xl font-extrabold mb-2 flex items-center gap-2">
                    üêæ Avatar-Shop
                </h2>
                <p className="text-xs text-slate-400 mb-3">
                    W√§hle deinen Lern-Begleiter. Seltene Avatare kosten mehr und sehen cooler aus.
                </p>
                <div className="grid grid-cols-2 gap-2">
                    {AVATARS.map(av => {
                        const owned = user.avatars.includes(av.id);
                        return (
                            <button
                                key={av.id}
                                onClick={() => buyAvatar(av)}
                                className={
                                    "flex flex-col items-center justify-center rounded-2xl px-2 py-3 border text-xs font-bold " +
                                    rarityClass(av.rarity) +
                                    (user.avatar === av.id ? " ring-2 ring-emerald-400" : "") +
                                    (!owned && user.coins < av.cost ? " opacity-40 cursor-not-allowed" : "")
                                }
                            >
                                <div className="text-3xl mb-1">{av.icon}</div>
                                <div className="mb-1">{av.name}</div>
                                {owned
                                    ? <span className="text-emerald-300 text-[10px]">Im Besitz</span>
                                    : <span className="text-amber-300 text-[10px]">{av.cost} üí∞</span>
                                }
                            </button>
                        );
                    })}
                </div>
            </div>

            <div className="glass p-4">
                <h2 className="font-game text-xl font-extrabold mb-2 flex items-center gap-2">
                    üéí Lern-Helfer
                </h2>
                <p className="text-xs text-slate-400 mb-3">
                    Kaufe dir kleine Vorteile: mehr Hinweise, Double XP oder ein zus√§tzliches Herz pro Runde.
                </p>
                <div className="space-y-2">
                    {ITEMS.map(it => (
                        <button
                            key={it.id}
                            className={
                                "w-full flex justify-between items-center px-3 py-3 rounded-2xl border bg-slate-900/80 hover:bg-slate-800/80 " +
                                (user.coins < it.cost ? "opacity-40 cursor-not-allowed" : "")
                            }
                            onClick={() => buyItem(it)}
                        >
                            <div className="text-left text-sm font-bold">
                                {it.name}
                                <div className="text-[10px] text-slate-400">
                                    {it.type === "hints" && "Mehr Tipps in Schreib-Aufgaben"}
                                    {it.type === "doubleXP" && "F√ºr die n√§chsten Runden gibt es doppelte XP"}
                                    {it.type === "hearts" && "Du startest Runden mit einem Extra-Herz"}
                                </div>
                            </div>
                            <div className="text-amber-300 text-xs font-bold">
                                {it.cost} üí∞
                            </div>
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

/* Gl√ºcksrad */
const Wheel = ({ user, onUpdateUser }) => {
    const [spinning, setSpinning] = useState(false);
    const [angle, setAngle] = useState(0);
    const [result, setResult] = useState(null);

    const canSpinToday = () => {
        const today = new Date().toISOString().slice(0,10);
        return user.lastSpin !== today;
    };

    const spin = () => {
        if (!canSpinToday()) {
            alert("Du hast heute schon gedreht. Morgen wieder!");
            return;
        }
        if (spinning) return;
        setSpinning(true);
        const segIndex = Math.floor(Math.random()*WHEEL_SEGMENTS.length);
        const segmentAngle = 360 / WHEEL_SEGMENTS.length;
        const targetAngle = 360*4 + (segmentAngle*segIndex + segmentAngle/2);
        setAngle(targetAngle);
        setTimeout(() => {
            const seg = WHEEL_SEGMENTS[segIndex];
            applyReward(seg);
            setResult(seg);
            setSpinning(false);
        }, 4200);
    };

    const applyReward = (seg) => {
        const eff = seg.effect;
        const today = new Date().toISOString().slice(0,10);
        const changes = { lastSpin: today };
        if (eff.coins) changes.coins = user.coins + eff.coins;
        if (eff.xp) changes.xp = user.xp + eff.xp;
        if (eff.doubleXP) changes.doubleXP = (user.doubleXP || 0) + eff.doubleXP;
        if (eff.hints) changes.hints = user.hints + eff.hints;
        if (eff.unlockAvatar) {
            const avatars = user.avatars.includes(eff.unlockAvatar)
                ? user.avatars
                : [...user.avatars, eff.unlockAvatar];
            changes.avatars = avatars;
            changes.avatar = eff.unlockAvatar;
        }
        onUpdateUser(changes);
        playSound("win");
        fireConfetti();
    };

    return (
        <div className="glass p-4 pop-in flex flex-col items-center gap-4">
            <h2 className="font-game text-xl font-extrabold flex items-center gap-2">
                üé° Gl√ºcksrad (1x pro Tag)
            </h2>
            <p className="text-xs text-slate-400 text-center">
                Gewinne M√ºnzen, XP oder sogar seltene Avatare. Nur einmal pro Tag drehbar.
            </p>
            <div className="relative">
                <div className="wheel">
                    <div
                        className="wheel-inner"
                        style={{ transform: `rotate(${angle}deg)` }}
                    >
                        {WHEEL_SEGMENTS.map((s, i) => (
                            <div
                                key={s.id}
                                className="wheel-label"
                                style={{ transform: `rotate(${i * (360/WHEEL_SEGMENTS.length)}deg)` }}
                            >
                                {s.label}
                            </div>
                        ))}
                    </div>
                    <div className="wheel-pointer"></div>
                </div>
            </div>
            <button
                className="btn btn-yellow"
                onClick={spin}
                disabled={!canSpinToday() || spinning}
            >
                {spinning ? "..." : (canSpinToday() ? "Jetzt drehen" : "Heute schon gedreht")}
            </button>
            {result && (
                <div className="text-xs text-emerald-300 text-center">
                    Gewinn: {result.label}
                </div>
            )}
        </div>
    );
};

/* Haupt-App */
const App = () => {
    const [user, setUser] = useState({
        name: "Pilot",
        coins: 150,
        xp: 0,
        level: 1,
        avatar: "chick",
        avatars: ["chick"],
        hints: 0,
        doubleXP: 0,
        bonusHearts: 0,
        lastSpin: null
    });
    const [mode, setMode] = useState("memory");
    const [group, setGroup] = useState("basis");

    useEffect(() => {
        const saved = localStorage.getItem("franz_lerncampus_v1");
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                setUser(prev => ({ ...prev, ...parsed }));
            } catch {}
        }
    }, []);

    const updateUser = (changes) => {
        setUser(prev => {
            const next = { ...prev, ...changes };
            if (next.level < MAX_LEVEL) {
                const needed = XP_FOR_LEVEL(next.level+1);
                if (next.xp >= needed) {
                    next.level += 1;
                    playSound("win");
                    fireConfetti();
                }
            } else {
                // Cap XP wenn max Level
                const cap = XP_FOR_LEVEL(MAX_LEVEL+1)-1;
                next.xp = Math.min(next.xp, cap);
            }
            localStorage.setItem("franz_lerncampus_v1", JSON.stringify(next));
            return next;
        });
    };

    const handleResult = (gain, endRound) => {
        let { xp, coins } = gain;
        if (user.doubleXP && xp > 0) xp *= 2;
        const changes = {
            xp: user.xp + (xp || 0),
            coins: user.coins + (coins || 0)
        };
        if (user.doubleXP && xp > 0) {
            changes.doubleXP = user.doubleXP - 1;
        }
        updateUser(changes);
    };

    const resetAll = () => {
        if (!confirm("Wirklich alles zur√ºcksetzen?")) return;
        localStorage.removeItem("franz_lerncampus_v1");
        setUser({
            name: "Pilot",
            coins: 150,
            xp: 0,
            level: 1,
            avatar: "chick",
            avatars: ["chick"],
            hints: 0,
            doubleXP: 0,
            bonusHearts: 0,
            lastSpin: null
        });
    };

    const words = WORD_GROUPS[group] || WORD_GROUPS.basis;

    return (
        <div className="max-w-4xl mx-auto px-3 py-4">
            <Header user={user} onReset={resetAll} />
            <div className="glass p-4 mb-4">
                <ModeMenu mode={mode} setMode={setMode} group={group} setGroup={setGroup} />
            </div>

            {mode === "memory" && (
                <MemoryGame
                    words={words}
                    onFinish={gain => handleResult(gain, true)}
                />
            )}

            {mode === "listen" && (
                <ListenGame
                    words={words}
                    onFinish={(gain, endRound) => handleResult(gain, endRound)}
                />
            )}

            {mode === "write" && (
                <WriteGame
                    words={words}
                    user={user}
                    onResult={changes => handleResult(changes, false)}
                />
            )}

            {mode === "listenOnly" && (
                <ListenOnly words={words} />
            )}

            {mode === "shop" && (
                <Shop user={user} onUpdateUser={updateUser} />
            )}

            {mode === "wheel" && (
                <Wheel user={user} onUpdateUser={updateUser} />
            )}
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
