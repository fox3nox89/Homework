<!DOCTYPE html>
<html lang="de-CH">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Franz√∂sisch Galaxy ‚Ä¢ 4. Klasse</title>

  <!-- ENGINE -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script
    src="https://unpkg.com/react@18/umd/react.production.min.js"
    crossorigin
  ></script>
  <script
    src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    crossorigin
  ></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary: #6366f1;
      --secondary: #a855f7;
      --bg-dark: #0f172a;
    }

    body {
      font-family: "Nunito", sans-serif;
      background-color: var(--bg-dark);
      color: #f8fafc;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    .font-game {
      font-family: "Baloo 2", cursive;
    }

    /* --- HINTERGRUND --- */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      background: radial-gradient(
        circle at bottom,
        #1e293b 0%,
        #020617 100%
      );
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0.5;
      animation: twinkle 4s infinite;
    }

    @keyframes twinkle {
      0%,
      100% {
        opacity: 0.2;
        transform: scale(0.8);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* --- UI COMPONENTS --- */
    .glass-panel {
      background: rgba(30, 41, 59, 0.75);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      border-radius: 24px;
    }

    .btn-action {
      transition: all 0.1s;
      border-radius: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 6px 0 rgba(0, 0, 0, 0.3);
      cursor: pointer;
      border-bottom-width: 6px;
      position: relative;
      overflow: hidden;
    }

    .btn-action:active {
      transform: translateY(4px);
      border-bottom-width: 2px;
      box-shadow: none;
    }

    .btn-blue {
      background: #3b82f6;
      border-color: #1d4ed8;
      color: white;
    }
    .btn-green {
      background: #22c55e;
      border-color: #15803d;
      color: white;
    }
    .btn-purple {
      background: #8b5cf6;
      border-color: #6d28d9;
      color: white;
    }
    .btn-yellow {
      background: #eab308;
      border-color: #a16207;
      color: white;
    }
    .btn-red {
      background: #ef4444;
      border-color: #b91c1c;
      color: white;
    }

    /* --- MEMORY KARTEN --- */
    .scene {
      perspective: 1000px;
      height: 130px; /* h√∂her */
      cursor: pointer;
    }

    .card {
      width: 100%;
      height: 100%;
      position: relative;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .card.flipped {
      transform: rotateY(180deg);
    }

    .card.matched {
      animation: popOut 0.5s forwards;
      pointer-events: none;
    }

    .face {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .front {
      background: linear-gradient(135deg, #6366f1, #a855f7);
      font-size: 3rem;
      z-index: 2;
      color: white;
    }

    .back {
      background: #1e293b;
      transform: rotateY(180deg);
      z-index: 1;
      padding: 6px;
      text-align: center;
      font-weight: 800;
      font-size: 1.1rem; /* gr√∂sser */
      line-height: 1.2;
    }

    .type-fr .back {
      border-color: #3b82f6;
      color: #60a5fa;
      background: #172554;
    }

    .type-de .back {
      border-color: #f97316;
      color: #fdba74;
      background: #431407;
    }

    /* --- VERBINDEN KARTEN --- */
    .match-card {
      background: #1e293b;
      border: 3px solid #334155;
      border-radius: 16px;
      padding: 12px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      box-shadow: 0 4px 0 #0f172a;
      font-size: 1.1rem;
    }

    .match-card:active {
      transform: translateY(4px);
      box-shadow: none;
    }

    .match-card.fr {
      border-left: 6px solid #3b82f6;
      color: #93c5fd;
    }

    .match-card.de {
      border-right: 6px solid #f97316;
      color: #fdba74;
    }

    .match-card.selected {
      background: #1e3a8a;
      border-color: #3b82f6;
      transform: scale(1.05);
      z-index: 10;
      color: white;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .match-card.matched {
      animation: popOut 0.4s forwards;
    }

    /* --- SHOP --- */
    .shop-card {
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      border-width: 3px;
    }

    .shop-card:active {
      transform: scale(0.95);
    }

    .rarity-common {
      border-color: #94a3b8;
      background: #f1f5f9;
      color: #334155;
    }

    .rarity-rare {
      border-color: #3b82f6;
      background: #eff6ff;
      color: #1e3a8a;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    .rarity-epic {
      border-color: #a855f7;
      background: #faf5ff;
      color: #581c87;
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
      animation: pulse 2s infinite;
    }

    .rarity-legendary {
      border-color: #eab308;
      background: linear-gradient(135deg, #422006, #713f12);
      box-shadow: 0 0 20px rgba(234, 179, 8, 0.6);
      animation: shine 2s infinite;
    }

    /* --- ANIMATIONS --- */
    @keyframes popOut {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }

    @keyframes shine {
      0% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.2);
      }
      100% {
        filter: brightness(1);
      }
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(168, 85, 247, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(168, 85, 247, 0);
      }
    }

    .pop-in {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .shake {
      animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    }

    @keyframes shake {
      10%,
      90% {
        transform: translate3d(-1px, 0, 0);
      }
      20%,
      80% {
        transform: translate3d(2px, 0, 0);
      }
      30%,
      50%,
      70% {
        transform: translate3d(-4px, 0, 0);
      }
      40%,
      60% {
        transform: translate3d(4px, 0, 0);
      }
    }

    /* LOADING */
    #loading {
      position: fixed;
      inset: 0;
      background: #0f172a;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* XP Bar */
    .xp-track {
      height: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      transition: width 1s ease-out;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(5px);
    }

    /* Herzen */
    .heart {
      font-size: 1.4rem;
    }
  </style>
</head>
<body class="min-h-screen pb-20">
  <div class="stars" id="stars"></div>

  <div id="loading">
    <div class="text-6xl mb-6 animate-bounce">üá´üá∑</div>
    <div
      class="text-2xl font-black text-blue-500 tracking-[0.3em] font-game"
    >
      LADE GALAXY...
    </div>
  </div>

  <div id="root"></div>

  <script type="text/babel">
    // --- INIT HINTERGRUND ---
    const starCont = document.getElementById("stars");
    for (let i = 0; i < 50; i++) {
      const s = document.createElement("div");
      s.className = "star";
      s.style.top = Math.random() * 100 + "%";
      s.style.left = Math.random() * 100 + "%";
      s.style.width = Math.random() * 3 + "px";
      s.style.height = s.style.width;
      s.style.animationDelay = Math.random() * 5 + "s";
      starCont.appendChild(s);
    }

    setTimeout(() => {
      document.getElementById("loading").style.opacity = "0";
      document.getElementById("loading").style.pointerEvents = "none";
    }, 800);

    const { useState, useEffect, useRef } = React;

    // --- DATEN (vereinfachte Wortliste, kann sp√§ter erweitert werden) ---
    const WORLDS = [
      {
        id: 1,
        name: "Basis Lager",
        icon: "üöÄ",
        reqLvl: 1,
        words: [
          { fr: "Bonjour", de: "Guten Tag" },
          { fr: "Salut", de: "Hallo" },
          { fr: "Au revoir", de: "Auf Wiedersehen" },
          { fr: "Merci", de: "Danke" },
          { fr: "S'il vous pla√Æt", de: "Bitte" },
          { fr: "Oui", de: "Ja" },
          { fr: "Non", de: "Nein" },
          { fr: "Je", de: "Ich" },
          { fr: "Tu", de: "Du" },
          { fr: "Il", de: "Er" },
          { fr: "Elle", de: "Sie" }
        ]
      },
      {
        id: 2,
        name: "Struktur W√∂rter",
        icon: "üß©",
        reqLvl: 1,
        words: [
          { fr: "D'abord", de: "Zuerst" },
          { fr: "Puis", de: "Dann" },
          { fr: "Apr√®s", de: "Danach" },
          { fr: "Finalement", de: "Schliesslich" },
          { fr: "Peut-√™tre", de: "Vielleicht" },
          { fr: "Toujours", de: "Immer" },
          { fr: "Jamais", de: "Nie" }
        ]
      },
      {
        id: 3,
        name: "Die Schule",
        icon: "üè´",
        reqLvl: 2,
        words: [
          { fr: "L'√©cole", de: "Die Schule" },
          { fr: "Le livre", de: "Das Buch" },
          { fr: "Le cahier", de: "Das Heft" },
          { fr: "Le crayon", de: "Der Bleistift" },
          { fr: "La gomme", de: "Der Gummi" },
          { fr: "La trousse", de: "Das Etui" },
          { fr: "La classe", de: "Die Klasse" },
          { fr: "Les devoirs", de: "Die Hausaufgaben" }
        ]
      },
      {
        id: 4,
        name: "Tier-Planet",
        icon: "ü¶Å",
        reqLvl: 3,
        words: [
          { fr: "Le chien", de: "Der Hund" },
          { fr: "Le chat", de: "Die Katze" },
          { fr: "La souris", de: "Die Maus" },
          { fr: "Le lapin", de: "Der Hase" },
          { fr: "La tortue", de: "Die Schildkr√∂te" },
          { fr: "Le lion", de: "Der L√∂we" },
          { fr: "Le cochon", de: "Das Schwein" }
        ]
      },
      {
        id: 5,
        name: "Zahlen & Geld",
        icon: "üí∞",
        reqLvl: 4,
        words: [
          { fr: "Onze", de: "Elf" },
          { fr: "Douze", de: "Zw√∂lf" },
          { fr: "Treize", de: "Dreizehn" },
          { fr: "Quatorze", de: "Vierzehn" },
          { fr: "Quinze", de: "F√ºnfzehn" },
          { fr: "Seize", de: "Sechzehn" },
          { fr: "Dix-huit", de: "Achtzehn" },
          { fr: "Vingt", de: "Zwanzig" }
        ]
      }
    ];

    // Dictionary f√ºr schnellen Zugriff
    const DICTIONARY = {};
    WORLDS.forEach((w) =>
      w.words.forEach((p) => {
        DICTIONARY[p.fr] = p.de;
      })
    );

    const RANKS = [
      "Kadett",
      "Entdecker",
      "Pilot",
      "Captain",
      "Commander",
      "Admiral",
      "Galactic Hero"
    ];
    const MAX_LEVEL = 20;

    // AVATARE & LERN-ITEMS
    const SHOP_ITEMS = [
      { id: "bear", icon: "üêª", name: "B√§r Bruno", cost: 0, rarity: "common" },
      { id: "fox", icon: "ü¶ä", name: "Fuchs Flix", cost: 150, rarity: "common" },
      { id: "cat", icon: "üê±", name: "Katze Mimi", cost: 200, rarity: "common" },
      { id: "dog", icon: "üê∂", name: "Hund Rex", cost: 250, rarity: "common" },
      { id: "owl", icon: "ü¶â", name: "Schlaue Eule", cost: 400, rarity: "rare" },
      { id: "panda", icon: "üêº", name: "Panda Prof", cost: 600, rarity: "rare" },
      { id: "robot", icon: "ü§ñ", name: "Lern-Roboter", cost: 900, rarity: "epic" },
      { id: "dragon", icon: "üê≤", name: "Vokabel-Drache", cost: 1500, rarity: "epic" },
      { id: "wizardbook", icon: "üìò", name: "Magisches W√∂rterbuch", cost: 500, rarity: "rare" },
      { id: "lamp", icon: "üí°", name: "Lern-Lampe", cost: 700, rarity: "rare" },
      { id: "crown", icon: "üëë", name: "Wort-K√∂nig", cost: 3000, rarity: "legendary" }
    ];

    // --- HILFSFUNKTIONEN ---
    const getXPForLevel = (lvl) => 200 * lvl;
    const getRankTitle = (lvl) =>
      RANKS[Math.min(Math.floor((lvl - 1) / 2), RANKS.length - 1)];

    const speak = (txt) => {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = "fr-FR";
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
      }
    };

    const playSound = (type) => {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.connect(g);
      g.connect(ctx.destination);
      const now = ctx.currentTime;

      if (type === "correct") {
        osc.type = "triangle";
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.linearRampToValueAtTime(1000, now + 0.15);
        g.gain.setValueAtTime(0.2, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
      } else if (type === "wrong") {
        osc.type = "sawtooth";
        osc.frequency.setValueAtTime(200, now);
        g.gain.setValueAtTime(0.25, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
      } else if (type === "win") {
        osc.type = "sine";
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.linearRampToValueAtTime(900, now + 0.6);
        g.gain.setValueAtTime(0.2, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 1);
      } else if (type === "cash") {
        osc.type = "square";
        osc.frequency.setValueAtTime(800, now);
        g.gain.setValueAtTime(0.2, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
      }
      osc.start(now);
      osc.stop(now + 1);
    };

    const safeConfetti = () => {
      if (window.confetti)
        window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    };

    // --- GAME COMPONENTS ---

    // 1. MEMORY GAME
    const MemoryGame = ({ words, onFinish }) => {
      const [cards, setCards] = useState([]);
      const [flipped, setFlipped] = useState([]);
      const [matched, setMatched] = useState([]);
      const [locked, setLocked] = useState(false);

      useEffect(() => {
        const selection = [...words].sort(() => Math.random() - 0.5).slice(0, 6);
        const deck = selection
          .flatMap((p) => [
            { id: p.fr + "-fr", txt: p.fr, type: "fr", pair: p.fr },
            { id: p.fr + "-de", txt: DICTIONARY[p.fr], type: "de", pair: p.fr }
          ])
          .sort(() => Math.random() - 0.5);
        setCards(deck);
      }, [words]);

      const click = (card) => {
        if (locked || flipped.includes(card.id) || matched.includes(card.id))
          return;
        if (card.type === "fr") speak(card.txt);

        const newFlipped = [...flipped, card.id];
        setFlipped(newFlipped);

        if (newFlipped.length === 2) {
          setLocked(true);
          const c1 = cards.find((x) => x.id === newFlipped[0]);
          const c2 = cards.find((x) => x.id === newFlipped[1]);
          if (c1.pair === c2.pair) {
            playSound("correct");
            setTimeout(() => {
              setMatched((m) => [...m, c1.id, c2.id]);
              setFlipped([]);
              setLocked(false);
            }, 400);
          } else {
            playSound("wrong");
            setTimeout(() => {
              setFlipped([]);
              setLocked(false);
            }, 800);
          }
        }
      };

      useEffect(() => {
        if (cards.length > 0 && matched.length === cards.length) {
          setTimeout(() => onFinish(true), 500);
        }
      }, [matched, cards.length, onFinish]);

      return (
        <div className="w-full max-w-md mx-auto">
          <div className="flex justify-between items-center mb-3 text-slate-300 text-xs">
            <span>üÉè Finde alle Paare.</span>
            <span>{matched.length / 2} / {cards.length / 2} Paare</span>
          </div>
          <div className="grid grid-cols-3 gap-3">
            {cards.map((c) => (
              <div
                key={c.id}
                className={`scene ${
                  matched.includes(c.id) ? "pointer-events-none" : ""
                }`}
                onClick={() => click(c)}
              >
                <div
                  className={`card ${
                    flipped.includes(c.id) ? "flipped" : ""
                  } ${matched.includes(c.id) ? "matched" : ""}`}
                >
                  <div className="face front">?</div>
                  <div className={`face back type-${c.type}`}>{c.txt}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // 2. MATCHING GAME (Verbindungen)
    const MatchGame = ({ words, onFinish }) => {
      const [left, setLeft] = useState([]);
      const [right, setRight] = useState([]);
      const [sel, setSel] = useState(null);
      const [solved, setSolved] = useState([]);

      useEffect(() => {
        const s = [...words].sort(() => Math.random() - 0.5).slice(0, 5);
        setLeft(s.map((w) => ({ id: w.fr, txt: w.fr, pair: w.fr, type: "fr" })));
        setRight(
          s
            .map((w) => ({
              id: w.fr + "d",
              txt: DICTIONARY[w.fr],
              pair: w.fr,
              type: "de"
            }))
            .sort(() => Math.random() - 0.5)
        );
      }, [words]);

      const click = (item) => {
        if (solved.includes(item.pair)) return;
        if (item.type === "fr") speak(item.txt);

        if (!sel) {
          setSel(item);
        } else {
          if (sel.id === item.id) {
            setSel(null);
            return;
          }
          if (sel.pair === item.pair) {
            playSound("correct");
            setSolved((s) => [...s, item.pair]);
            setSel(null);
          } else {
            playSound("wrong");
            setSel(null);
          }
        }
      };

      useEffect(() => {
        if (left.length && solved.length === left.length) {
          setTimeout(() => onFinish(true), 500);
        }
      }, [solved, left.length, onFinish]);

      return (
        <div className="flex gap-4 w-full max-w-2xl px-2 items-center">
          <div className="w-1/2 flex flex-col gap-3 justify-center">
            {left.map((l) => (
              <div
                key={l.id}
                onClick={() => click(l)}
                className={`match-card fr ${
                  sel?.id === l.id ? "selected" : ""
                } ${solved.includes(l.pair) ? "matched" : ""}`}
              >
                {l.txt}
              </div>
            ))}
          </div>
          <div className="w-1/2 flex flex-col gap-3 justify-center">
            {right.map((r) => (
              <div
                key={r.id}
                onClick={() => click(r)}
                className={`match-card de ${
                  sel?.id === r.id ? "selected" : ""
                } ${solved.includes(r.pair) ? "matched" : ""}`}
              >
                {r.txt}
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Hilfsfunktion: Antwort vergleichen (f√ºr Schreiben)
    const normalizeAnswer = (txt) =>
      txt
        .toLowerCase()
        .trim()
        .replace(/^l['‚Äô]\s*/i, "")
        .replace(/^(le|la|les|der|die|das)\s+/i, "");

    // 3. QUIZ (franz -> deutsch, 4 Antwortm√∂glichkeiten, Anti-Cheat)
    const QuizGame = ({ words, onFinish }) => {
      const [order, setOrder] = useState([]);
      const [index, setIndex] = useState(0);
      const [hearts, setHearts] = useState(3);
      const [correctCount, setCorrectCount] = useState(0);

      useEffect(() => {
        const shuffled = [...words].sort(() => Math.random() - 0.5);
        setOrder(shuffled);
      }, [words]);

      if (!order.length) return null;

      const current = order[index];

      const makeOptions = () => {
        const others = words
          .filter((w) => w.fr !== current.fr)
          .sort(() => Math.random() - 0.5)
          .slice(0, 3)
          .map((w) => DICTIONARY[w.fr]);
        const all = [...others, DICTIONARY[current.fr]];
        return all.sort(() => Math.random() - 0.5);
      };

      const [options, setOptions] = useState(makeOptions);

      useEffect(() => {
        setOptions(makeOptions());
      }, [index]);

      const handle = (opt) => {
        if (opt === DICTIONARY[current.fr]) {
          playSound("correct");
          setCorrectCount((c) => c + 1);
          if (index + 1 === order.length) {
            onFinish(true, { correct: correctCount + 1, total: order.length });
          } else {
            setIndex((i) => i + 1);
          }
        } else {
          playSound("wrong");
          setHearts((h) => {
            const nh = h - 1;
            if (nh <= 0) {
              onFinish(false, { correct: correctCount, total: order.length });
            }
            return nh;
          });
        }
      };

      return (
        <div className="w-full max-w-md mx-auto text-center pop-in">
          <div className="flex justify-between items-center mb-4 text-xs text-slate-300">
            <span>
              Frage {index + 1} / {order.length}
            </span>
            <span>
              {Array.from({ length: 3 }).map((_, i) => (
                <span key={i} className="heart">
                  {i < hearts ? "‚ù§Ô∏è" : "üñ§"}
                </span>
              ))}
            </span>
          </div>
          <div className="glass-panel p-8 mb-6">
            <h2 className="text-3xl font-black text-yellow-300 mb-2">
              {current.fr}
            </h2>
            <button
              onClick={() => speak(current.fr)}
              className="text-xs bg-yellow-500 text-black px-3 py-1 rounded-full font-bold"
            >
              üîä Anh√∂ren
            </button>
          </div>
          <div className="space-y-3">
            {options.map((o) => (
              <button
                key={o}
                onClick={() => handle(o)}
                className="btn-action btn-purple w-full py-3 text-sm"
              >
                {o}
              </button>
            ))}
          </div>
        </div>
      );
    };

    // 4. LISTEN GAME (nur h√∂ren + Auswahl, Anti-Cheat)
    const ListenGame = ({ words, onFinish }) => {
      const [order, setOrder] = useState([]);
      const [index, setIndex] = useState(0);
      const [hearts, setHearts] = useState(3);

      useEffect(() => {
        const shuffled = [...words].sort(() => Math.random() - 0.5);
        setOrder(shuffled);
      }, [words]);

      if (!order.length) return null;
      const current = order[index];

      const makeOptions = () => {
        const others = words
          .filter((w) => w.fr !== current.fr)
          .sort(() => Math.random() - 0.5)
          .slice(0, 3)
          .map((w) => DICTIONARY[w.fr]);
        const all = [...others, DICTIONARY[current.fr]];
        return all.sort(() => Math.random() - 0.5);
      };

      const [options, setOptions] = useState(makeOptions);

      useEffect(() => {
        setOptions(makeOptions());
        speak(current.fr);
      }, [index]);

      const handle = (opt) => {
        if (opt === DICTIONARY[current.fr]) {
          playSound("correct");
          if (index + 1 === order.length) {
            onFinish(true);
          } else {
            setIndex((i) => i + 1);
          }
        } else {
          playSound("wrong");
          setHearts((h) => {
            const nh = h - 1;
            if (nh <= 0) {
              onFinish(false);
            }
            return nh;
          });
        }
      };

      return (
        <div className="w-full max-w-md mx-auto text-center pop-in">
          <div className="flex justify-between items-center mb-4 text-xs text-slate-300">
            <span>
              Karte {index + 1} / {order.length}
            </span>
            <span>
              {Array.from({ length: 3 }).map((_, i) => (
                <span key={i} className="heart">
                  {i < hearts ? "‚ù§Ô∏è" : "üñ§"}
                </span>
              ))}
            </span>
          </div>
          <div className="glass-panel p-8 mb-6">
            <h2 className="text-2xl font-black text-green-300 mb-3">
              H√∂r gut zu!
            </h2>
            <button
              onClick={() => speak(current.fr)}
              className="btn-action btn-green w-full py-3"
            >
              üîä Wort abspielen
            </button>
          </div>
          <div className="space-y-3">
            {options.map((o) => (
              <button
                key={o}
                onClick={() => handle(o)}
                className="btn-action btn-yellow w-full py-3 text-sm text-black"
              >
                {o}
              </button>
            ))}
          </div>
        </div>
      );
    };

    // 5. WRITE GAME (√úbersetzung schreiben, tolerant)
    const WriteGame = ({ words, onFinish }) => {
      const [order, setOrder] = useState([]);
      const [index, setIndex] = useState(0);
      const [value, setValue] = useState("");
      const [result, setResult] = useState(null);
      const [stats, setStats] = useState({
        correct: 0,
        partial: 0,
        wrong: 0
      });
      const [hearts, setHearts] = useState(3);

      useEffect(() => {
        const shuffled = [...words].sort(() => Math.random() - 0.5);
        setOrder(shuffled);
      }, [words]);

      if (!order.length) return null;
      const current = order[index];
      const correct = DICTIONARY[current.fr];

      const check = () => {
        const user = value.trim();
        if (!user) return;

        const normalizedUser = normalizeAnswer(user);
        const normalizedCorrect = normalizeAnswer(correct);
        const sameBase = normalizedUser === normalizedCorrect;

        let type = "wrong";
        let message = `Leider falsch. Richtig w√§re: "${correct}".`;

        if (sameBase) {
          // unterscheiden: komplett gleich oder nur Artikel/Grossschreibung anders
          if (user.toLowerCase() === correct.toLowerCase()) {
            type = "correct";
            message = "Super, alles richtig!";
          } else {
            type = "partial";
            message =
              'Grundwort stimmt, aber Artikel oder Gross-/Kleinschreibung nicht ganz. Richtig w√§re: "' +
              correct +
              '".';
          }
        }

        if (type === "correct") {
          playSound("correct");
          setStats((s) => ({ ...s, correct: s.correct + 1 }));
        } else if (type === "partial") {
          playSound("correct");
          setStats((s) => ({ ...s, partial: s.partial + 1 }));
        } else {
          playSound("wrong");
          setStats((s) => ({ ...s, wrong: s.wrong + 1 }));
          setHearts((h) => {
            const nh = h - 1;
            return nh;
          });
        }

        setResult({ type, message });

        setTimeout(() => {
          if (index + 1 === order.length || hearts - (type === "wrong" ? 1 : 0) <= 0) {
            onFinish(
              hearts - (type === "wrong" ? 1 : 0) > 0,
              { ...stats, [type]: stats[type] + 1 }
            );
          } else {
            setIndex((i) => i + 1);
            setValue("");
            setResult(null);
          }
        }, 900);
      };

      return (
        <div className="w-full max-w-md mx-auto text-center pop-in">
          <div className="flex justify-between items-center mb-4 text-xs text-slate-300">
            <span>
              Wort {index + 1} / {order.length}
            </span>
            <span>
              {Array.from({ length: 3 }).map((_, i) => (
                <span key={i} className="heart">
                  {i < hearts ? "‚ù§Ô∏è" : "üñ§"}
                </span>
              ))}
            </span>
          </div>
          <div className="glass-panel p-8 mb-4">
            <h2 className="text-3xl font-black text-rose-300 mb-2">
              {current.fr}
            </h2>
            <button
              onClick={() => speak(current.fr)}
              className="text-xs bg-rose-500 text-black px-3 py-1 rounded-full font-bold"
            >
              üîä Anh√∂ren
            </button>
          </div>
          <input
            value={value}
            onChange={(e) => setValue(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && check()}
            className="w-full p-4 rounded-xl text-center text-xl bg-slate-800 text-white border-2 border-slate-600 mb-3 focus:border-rose-400 outline-none"
            placeholder="Deutsches Wort (z.B. Die Schule)"
            autoFocus
          />
          <button onClick={check} className="btn-action btn-red w-full py-3">
            Pr√ºfen
          </button>
          {result && (
            <div
              className={`mt-3 text-sm ${
                result.type === "correct"
                  ? "text-green-400"
                  : result.type === "partial"
                  ? "text-yellow-300"
                  : "text-red-400"
              }`}
            >
              {result.message}
            </div>
          )}
        </div>
      );
    };

    // --- SHOP ---
    const Shop = ({ user, onBuy, onEquip, onClose }) => {
      return (
        <div className="max-w-md mx-auto p-4 min-h-screen pb-20">
          <div className="flex justify-between items-center mb-4">
            <button
              onClick={onClose}
              className="glass-panel px-3 py-1 text-xs text-slate-300"
            >
              ‚óÄ Zur√ºck
            </button>
            <div className="flex items-center gap-3 text-sm">
              <span className="glass-panel px-3 py-1">Lvl {user.level}</span>
              <span className="glass-panel px-3 py-1">
                {user.coins} M√ºnzen üí∞
              </span>
            </div>
          </div>

          <h1 className="text-3xl font-black text-white mb-6 text-center">
            Avatar & Lern-Shop
          </h1>

          <div className="grid grid-cols-3 gap-4 mb-8">
            {SHOP_ITEMS.map((a) => {
              const owned = user.unlocked.includes(a.id);
              return (
                <div
                  key={a.id}
                  onClick={() => {
                    if (owned) {
                      onEquip(a.id);
                      playSound("correct");
                    } else if (user.coins >= a.cost) {
                      onBuy(a.cost, a.id);
                      playSound("cash");
                      safeConfetti();
                    } else {
                      alert("Zu wenig M√ºnzen!");
                    }
                  }}
                  className={`shop-card glass-panel p-3 flex flex-col items-center ${
                    user.avatar === a.id
                      ? "border-green-500 bg-green-900/30"
                      : "rarity-" + a.rarity
                  } ${!owned && user.coins < a.cost ? "opacity-40" : ""}`}
                >
                  <div className="text-4xl mb-1">{a.icon}</div>
                  <div className="font-bold text-xs text-center">{a.name}</div>
                  {!owned && (
                    <div className="bg-yellow-400 text-black px-2 py-0.5 rounded text-[0.65rem] font-bold mt-1">
                      {a.cost} üí∞
                    </div>
                  )}
                  {owned && (
                    <div className="text-green-300 text-[0.65rem] font-bold mt-1">
                      {user.avatar === a.id ? "AKTIV" : "GEKAUFT"}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <a
            href="index.html"
            className="glass-panel block text-center text-slate-300 text-xs py-3 font-bold"
          >
            üè† Zur Startseite
          </a>
        </div>
      );
    };

    // --- MODAL ---
    const Modal = ({ title, children, onClose, type = "info" }) => (
      <div className="modal-overlay" onClick={onClose}>
        <div
          className={`bg-slate-800 p-6 rounded-3xl border-4 w-full max-w-sm text-center relative shadow-2xl ${
            type === "win"
              ? "border-yellow-400"
              : type === "error"
              ? "border-red-500"
              : "border-blue-500"
          }`}
          onClick={(e) => e.stopPropagation()}
        >
          <h2
            className={`text-2xl font-black mb-4 font-game ${
              type === "win"
                ? "text-yellow-400"
                : type === "error"
                ? "text-red-400"
                : "text-white"
            }`}
          >
            {title}
          </h2>
          <div className="text-slate-300 mb-6 text-sm">{children}</div>
          <button
            onClick={onClose}
            className={`btn-action w-full py-3 ${
              type === "win"
                ? "btn-yellow"
                : type === "error"
                ? "btn-red"
                : "btn-blue"
            }`}
          >
            OK
          </button>
        </div>
      </div>
    );

    // --- APP ---
    const initialUser = () => ({
      name: "Agent",
      coins: 100,
      xp: 0,
      level: 1,
      avatar: "bear",
      unlocked: ["bear"],
      unlockedWorlds: [1]
    });

    const App = () => {
      const [user, setUser] = useState(initialUser);
      const [view, setView] = useState("map"); // map | game | shop
      const [activeWorld, setActiveWorld] = useState(null);
      const [gameMode, setGameMode] = useState(null);
      const [modal, setModal] = useState(null);

      useEffect(() => {
        const stored = localStorage.getItem("franz_galaxy_v2");
        if (stored) {
          try {
            setUser(JSON.parse(stored));
          } catch (e) {}
        }
      }, []);

      const save = (u) => {
        setUser(u);
        localStorage.setItem("franz_galaxy_v2", JSON.stringify(u));
      };

      const resetAll = () => {
        if (!confirm("Willst du wirklich alles zur√ºcksetzen?")) return;
        const fresh = initialUser();
        save(fresh);
        setView("map");
        setActiveWorld(null);
        setGameMode(null);
      };

      const addProgress = (xpGain, coinGain) => {
        let u = { ...user };
        if (u.level >= MAX_LEVEL) {
          // Level voll, nur M√ºnzen
          u.coins += coinGain;
          save(u);
          setModal({
            title: "Max Level!",
            type: "win",
            msg: `Du hast das Max-Level erreicht. Du kannst weiter M√ºnzen sammeln.`
          });
          return;
        }

        u.xp += xpGain;
        u.coins += coinGain;

        let leveledUp = false;
        while (u.level < MAX_LEVEL && u.xp >= getXPForLevel(u.level + 1)) {
          u.level++;
          leveledUp = true;
        }

        if (leveledUp) {
          playSound("win");
          safeConfetti();
          setModal({
            title: "LEVEL UP!",
            type: "win",
            msg: `Du bist jetzt ${getRankTitle(u.level)} (Level ${u.level}).`
          });
        } else {
          setModal({
            title: "Mission geschafft!",
            type: "win",
            msg: `+${xpGain} XP und +${coinGain} M√ºnzen.`
          });
        }

        save(u);
      };

      // ---- VIEW: MAP / MEN√ú ----
      if (view === "map") {
        const nextXP = getXPForLevel(
          Math.min(user.level + 1, MAX_LEVEL)
        );
        const progress = Math.min(100, (user.xp / nextXP) * 100);

        return (
          <div className="max-w-md mx-auto p-4 min-h-screen flex flex-col">
            <div className="flex justify-between items-center mb-4">
              <a
                href="index.html"
                className="glass-panel px-3 py-1 text-xs text-slate-300"
              >
                üè† Zur Startseite
              </a>
              <button
                onClick={resetAll}
                className="glass-panel px-3 py-1 text-xs text-red-300"
              >
                üîÅ Alles zur√ºcksetzen
              </button>
            </div>

            <div className="glass-panel p-4 mb-6 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-4xl bg-white/10 p-2 rounded-xl">
                  {SHOP_ITEMS.find((a) => a.id === user.avatar)?.icon || "üêª"}
                </div>
                <div>
                  <div className="font-bold text-white">{user.name}</div>
                  <div className="text-xs text-blue-400 font-bold uppercase">
                    {getRankTitle(user.level)} ‚Ä¢ Lvl {user.level}/{MAX_LEVEL}
                  </div>
                </div>
              </div>
              <button
                onClick={() => setView("shop")}
                className="font-bold text-yellow-400 text-sm hover:scale-110 transition"
              >
                {user.coins} üí∞ Shop
              </button>
            </div>

            <div className="xp-track mb-4">
              <div className="xp-fill" style={{ width: `${progress}%` }}></div>
            </div>

            <div className="space-y-6 pb-10">
              {WORLDS.map((w) => {
                const locked = user.level < w.reqLvl;
                const isActive = activeWorld?.id === w.id;
                return (
                  <div key={w.id} className="relative">
                    <div
                      onClick={() => !locked && setActiveWorld(isActive ? null : w)}
                      className={`glass-panel p-4 flex items-center gap-4 transition cursor-pointer border-l-4 ${
                        locked ? "border-slate-500 opacity-40" : "border-blue-500 hover:bg-white/10"
                      }`}
                    >
                      <div className="text-3xl">
                        {locked ? "üîí" : w.icon}
                      </div>
                      <div className="flex-1">
                        <div className="font-bold text-lg text-white">
                          {w.name}
                        </div>
                        <div className="text-xs text-slate-400">
                          {locked
                            ? `Ab Level ${w.reqLvl}`
                            : `${w.words.length} W√∂rter`}
                        </div>
                      </div>
                      <div className="text-white text-sm">
                        {isActive ? "‚ñº" : "‚ñ∂"}
                      </div>
                    </div>

                    {isActive && !locked && (
                      <div className="mt-3 grid grid-cols-2 gap-3 pop-in pl-4 border-l-2 border-blue-500">
                        <button
                          onClick={() => {
                            setGameMode("match");
                            setView("game");
                          }}
                          className="btn-action btn-blue py-2 text-xs"
                        >
                          üîó Verbinden
                        </button>
                        <button
                          onClick={() => {
                            setGameMode("memory");
                            setView("game");
                          }}
                          className="btn-action btn-green py-2 text-xs"
                        >
                          üÉè Memory
                        </button>
                        <button
                          onClick={() => {
                            setGameMode("quiz");
                            setView("game");
                          }}
                          className="btn-action btn-purple py-2 text-xs"
                        >
                          ‚ùì Quiz
                        </button>
                        <button
                          onClick={() => {
                            setGameMode("listen");
                            setView("game");
                          }}
                          className="btn-action btn-yellow py-2 text-xs text-black"
                        >
                          üëÇ H√∂ren
                        </button>
                        <button
                          onClick={() => {
                            setGameMode("write");
                            setView("game");
                          }}
                          className="btn-action btn-red py-2 text-xs col-span-2"
                        >
                          ‚úçÔ∏è Schreiben
                        </button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {modal && (
              <Modal
                title={modal.title}
                type={modal.type}
                onClose={() => setModal(null)}
              >
                {modal.msg}
              </Modal>
            )}
          </div>
        );
      }

      // ---- VIEW: GAME ----
      if (view === "game") {
        const world = activeWorld;
        if (!world) {
          setView("map");
          return null;
        }

        const handleFinish = (success) => {
          if (success) {
            // je nach Modus etwas andere Belohnung
            if (gameMode === "memory" || gameMode === "match") {
              addProgress(60, 25);
            } else if (gameMode === "quiz" || gameMode === "listen") {
              addProgress(40, 15);
            } else if (gameMode === "write") {
              addProgress(80, 30);
            }
          } else {
            setModal({
              title: "Versuch es noch einmal",
              type: "error",
              msg: "Zu viele Fehler. √úbe die W√∂rter und starte die Mission neu."
            });
          }
          setView("map");
        };

        return (
          <div className="min-h-screen p-4 flex flex-col relative">
            <div className="flex justify-between items-center mb-4 z-20">
              <button
                onClick={() => setView("map")}
                className="glass-panel w-10 h-10 flex items-center justify-center text-white font-bold text-xl"
              >
                ‚úï
              </button>
              <div className="glass-panel px-3 py-1 text-xs text-blue-300 font-bold uppercase">
                {world.name} ‚Ä¢ {gameMode}
              </div>
              <a
                href="index.html"
                className="glass-panel px-3 py-1 text-xs text-slate-300"
              >
                üè† Start
              </a>
            </div>

            <div className="flex-1 flex flex-col justify-center items-center w-full max-w-2xl mx-auto">
              {gameMode === "memory" && (
                <MemoryGame words={world.words} onFinish={handleFinish} />
              )}
              {gameMode === "match" && (
                <MatchGame words={world.words} onFinish={handleFinish} />
              )}
              {gameMode === "quiz" && (
                <QuizGame words={world.words} onFinish={handleFinish} />
              )}
              {gameMode === "listen" && (
                <ListenGame words={world.words} onFinish={handleFinish} />
              )}
              {gameMode === "write" && (
                <WriteGame words={world.words} onFinish={handleFinish} />
              )}
            </div>

            {modal && (
              <Modal
                title={modal.title}
                type={modal.type}
                onClose={() => setModal(null)}
              >
                {modal.msg}
              </Modal>
            )}
          </div>
        );
      }

      // ---- VIEW: SHOP ----
      if (view === "shop") {
        return (
          <Shop
            user={user}
            onClose={() => setView("map")}
            onBuy={(cost, id) => {
              const u = { ...user };
              u.coins -= cost;
              if (!u.unlocked.includes(id)) u.unlocked.push(id);
              save(u);
            }}
            onEquip={(id) => {
              const u = { ...user, avatar: id };
              if (!u.unlocked.includes(id)) u.unlocked.push(id);
              save(u);
            }}
          />
        );
      }

      return null;
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
