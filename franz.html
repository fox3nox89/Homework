<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Galaxy</title>

    <!-- ENGINE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg-dark: #0f172a;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .font-game { font-family: 'Baloo 2', cursive; }

        /* Hintergrund */
        .stars {
            position: fixed;
            inset: 0;
            z-index: -1;
            pointer-events: none;
            background: radial-gradient(circle at bottom, #1e293b 0%, #020617 100%);
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle 4s infinite;
        }
        @keyframes twinkle {
            0%,100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* UI */
        .glass-panel {
            background: rgba(30,41,59,0.75);
            backdrop-filter: blur(16px);
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .btn-action {
            transition: all 0.1s;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3);
            border-bottom-width: 6px;
            cursor: pointer;
        }
        .btn-action:active {
            transform: translateY(3px);
            box-shadow: none;
            border-bottom-width: 2px;
        }
        .btn-blue   { background:#3b82f6; border-color:#1d4ed8; color:white; }
        .btn-green  { background:#22c55e; border-color:#15803d; color:white; }
        .btn-purple { background:#a855f7; border-color:#6d28d9; color:white; }
        .btn-yellow { background:#eab308; border-color:#a16207; color:black; }
        .btn-red    { background:#ef4444; border-color:#b91c1c; color:white; }

        /* Memory */
        .scene { perspective: 1000px; height: 110px; cursor: pointer; }
        .card {
            width: 100%; height: 100%;
            position: relative;
            transition: transform 0.5s;
            transform-style: preserve-3d;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { animation: popOut 0.5s forwards; }

        .face {
            position:absolute; inset:0;
            display:flex; align-items:center; justify-content:center;
            border-radius:18px;
            -webkit-backface-visibility:hidden;
            backface-visibility:hidden;
            box-shadow:0 4px 6px rgba(0,0,0,0.3);
            border:3px solid rgba(255,255,255,0.2);
            text-align:center;
            padding:6px;
        }
        .front {
            background:linear-gradient(135deg,#6366f1,#a855f7);
            color:white;
            font-size:2.8rem;
        }
        .back {
            transform:rotateY(180deg);
            font-weight:800;
            font-size:1.1rem;
        }
        .type-fr .back { background:#172554; color:#bfdbfe; border-color:#3b82f6; }
        .type-de .back { background:#431407; color:#fed7aa; border-color:#f97316; }

        /* Match / Quiz */
        .match-card {
            background:#0f172a;
            border-radius:18px;
            border:3px solid #1e293b;
            padding:12px;
            font-weight:800;
            cursor:pointer;
            box-shadow:0 4px 0 #020617;
            text-align:center;
        }
        .match-card.selected {
            border-color:#3b82f6;
            background:#1d4ed8;
            color:white;
            transform:scale(1.05);
        }
        .match-card.matched {
            animation: popOut 0.4s forwards;
        }

        /* Shop */
        .shop-card {
            border-radius:18px;
            padding:12px;
            border-width:3px;
            cursor:pointer;
            transition:all 0.2s;
            text-align:center;
        }
        .shop-card:active { transform:scale(0.95); }

        .rarity-common    { border-color:#94a3b8; background:#f1f5f9; color:#0f172a; }
        .rarity-rare      { border-color:#3b82f6; background:#eff6ff; color:#1e3a8a; box-shadow:0 0 10px rgba(59,130,246,0.4); }
        .rarity-epic      { border-color:#a855f7; background:#faf5ff; color:#581c87; box-shadow:0 0 14px rgba(168,85,247,0.6); }
        .rarity-legendary { border-color:#eab308; background:linear-gradient(135deg,#422006,#713f12); color:#facc15; box-shadow:0 0 18px rgba(234,179,8,0.7); }

        /* Animations */
        @keyframes popOut {
            0% { transform:scale(1); opacity:1; }
            50% { transform:scale(1.2); opacity:1; }
            100% { transform:scale(0); opacity:0; }
        }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        @keyframes popIn {
            from { transform:scale(0.6); opacity:0; }
            to   { transform:scale(1); opacity:1; }
        }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%,90% { transform:translate3d(-1px,0,0); }
            20%,80% { transform:translate3d(2px,0,0); }
            30%,50%,70% { transform:translate3d(-4px,0,0); }
            40%,60% { transform:translate3d(4px,0,0); }
        }

        /* XP-Bar */
        .xp-track {
            height:16px;
            background:rgba(15,23,42,0.8);
            border-radius:999px;
            overflow:hidden;
            border:1px solid rgba(148,163,184,0.6);
        }
        .xp-fill {
            height:100%;
            background:linear-gradient(90deg,#22c55e,#4ade80);
            transition:width 0.8s ease-out;
        }

        /* Loading */
        #loading {
            position:fixed;
            inset:0;
            background:#020617;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            z-index:9999;
        }

        /* Modal */
        .modal-overlay {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.8);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:100;
            backdrop-filter:blur(5px);
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <div class="stars" id="stars"></div>

    <div id="loading">
        <div class="text-6xl mb-4 animate-bounce">üá´üá∑</div>
        <div class="text-2xl font-black text-blue-400 tracking-[0.3em] font-game">LADE...</div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Sterne
        const starCont = document.getElementById('stars');
        for (let i = 0; i < 60; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.top = Math.random()*100 + '%';
            s.style.left = Math.random()*100 + '%';
            const size = 1 + Math.random()*2;
            s.style.width = size + 'px';
            s.style.height = size + 'px';
            s.style.animationDelay = Math.random()*5 + 's';
            starCont.appendChild(s);
        }
        setTimeout(() => {
            const l = document.getElementById('loading');
            if (l) l.style.display = 'none';
        }, 900);

        // --- DATEN ---
        const MAX_LEVEL = 20;
        const RANKS = ["Kadett", "Entdecker", "Pilot", "Captain", "Commander", "Admiral", "Galactic Hero"];

        const WORLDS = [
            {
                id: 1, name: "Basislager ‚Äì Begr√ºssung", icon: "üëã", reqLvl: 1,
                words: [
                    { fr: "Bonjour", de: "Guten Tag" },
                    { fr: "Salut", de: "Hallo" },
                    { fr: "Au revoir", de: "Auf Wiedersehen" },
                    { fr: "Merci", de: "Danke" },
                    { fr: "S'il vous pla√Æt", de: "Bitte" },
                    { fr: "Oui", de: "Ja" },
                    { fr: "Non", de: "Nein" },
                    { fr: "Je", de: "Ich" },
                    { fr: "Tu", de: "Du" },
                    { fr: "Il", de: "Er" },
                    { fr: "Elle", de: "Sie" },
                    { fr: "Nous", de: "Wir" },
                    { fr: "Vous", de: "Ihr / Sie" },
                    { fr: "Ils", de: "Sie (m.)" },
                    { fr: "Elles", de: "Sie (w.)" }
                ]
            },
            {
                id: 2, name: "Geschichten-W√∂rter", icon: "üìö", reqLvl: 1,
                words: [
                    { fr: "L'histoire", de: "Die Geschichte" },
                    { fr: "La bande dessin√©e", de: "Der Comic" },
                    { fr: "Organiser", de: "Organisieren" },
                    { fr: "Raconter", de: "Erz√§hlen" },
                    { fr: "Inviter", de: "Einladen" },
                    { fr: "Le secret", de: "Das Geheimnis" },
                    { fr: "Cacher", de: "Verstecken" },
                    { fr: "D'abord", de: "Zuerst" },
                    { fr: "Puis", de: "Dann" },
                    { fr: "Apr√®s", de: "Danach" },
                    { fr: "Finalement", de: "Schliesslich" },
                    { fr: "Peut-√™tre", de: "Vielleicht" }
                ]
            },
            {
                id: 3, name: "Tiere & Freunde", icon: "ü¶ä", reqLvl: 2,
                words: [
                    { fr: "La souris", de: "Die Maus" },
                    { fr: "Le lapin", de: "Der Hase" },
                    { fr: "La tortue", de: "Die Schildkr√∂te" },
                    { fr: "Le chien", de: "Der Hund" },
                    { fr: "Le chat", de: "Die Katze" },
                    { fr: "Le lion", de: "Der L√∂we" },
                    { fr: "Le cochon", de: "Das Schwein" },
                    { fr: "La vache", de: "Die Kuh" },
                    { fr: "Le cheval", de: "Das Pferd" }
                ]
            },
            {
                id: 4, name: "Unterwegs ‚Äì slowUp", icon: "üö¥", reqLvl: 3,
                words: [
                    { fr: "Le parcours", de: "Die Strecke / Runde" },
                    { fr: "√Ä pied", de: "Zu Fuss" },
                    { fr: "La voiture", de: "Das Auto" },
                    { fr: "Le train", de: "Der Zug" },
                    { fr: "Jusqu'√†", de: "Bis" },
                    { fr: "La maison", de: "Das Haus" },
                    { fr: "La for√™t", de: "Der Wald" },
                    { fr: "La gare", de: "Der Bahnhof" }
                ]
            },
            {
                id: 5, name: "Farben & Zahlen", icon: "üé®", reqLvl: 4,
                words: [
                    { fr: "Rouge", de: "Rot" },
                    { fr: "Bleu", de: "Blau" },
                    { fr: "Vert", de: "Gr√ºn" },
                    { fr: "Jaune", de: "Gelb" },
                    { fr: "Noir", de: "Schwarz" },
                    { fr: "Blanc", de: "Weiss" },
                    { fr: "Gris", de: "Grau" },
                    { fr: "Orange", de: "Orange" },
                    { fr: "Onze", de: "Elf" },
                    { fr: "Dix-huit", de: "Achtzehn" },
                    { fr: "Dix-sept", de: "Siebzehn" },
                    { fr: "Treize", de: "Dreizehn" },
                    { fr: "Seize", de: "Sechzehn" }
                ]
            }
        ];

        const DICTIONARY = {};
        WORLDS.forEach(w => w.words.forEach(p => { DICTIONARY[p.fr] = p.de; }));

        const AVATARS = [
            { id: 'kid',   icon: 'üßë', name: 'Sch√ºler',  cost: 0,    rarity: 'common' },
            { id: 'mouse', icon: 'üê≠', name: 'Mausi',    cost: 80,   rarity: 'common' },
            { id: 'turtle',icon: 'üê¢', name: 'Torti',    cost: 120,  rarity: 'common' },
            { id: 'rabbit',icon: 'üê∞', name: 'Hoppel',   cost: 150,  rarity: 'common' },
            { id: 'cat',   icon: 'üê±', name: 'Mimi',     cost: 200,  rarity: 'rare' },
            { id: 'dog',   icon: 'üê∂', name: 'Rex',      cost: 220,  rarity: 'rare' },
            { id: 'cow',   icon: 'üêÆ', name: 'Moo',      cost: 260,  rarity: 'rare' },
            { id: 'lion',  icon: 'ü¶Å', name: 'Leo',      cost: 320,  rarity: 'epic' },
            { id: 'dragon',icon: 'üê≤', name: 'Drago',    cost: 420,  rarity: 'epic' },
            { id: 'unicorn',icon:'ü¶Ñ',name:'Sparkle',   cost: 550,  rarity: 'epic' },
            { id: 'alien', icon: 'üëΩ', name: 'Zorg',     cost: 700,  rarity: 'legendary' },
            { id: 'robot', icon: 'ü§ñ', name: 'Robo',     cost: 900,  rarity: 'legendary' },
            // SPECIAL EDITION am Schluss:
            { id: 'bear',  icon: 'üêª', name: 'Bruno (SE)', cost: 1200, rarity: 'legendary' },
            { id: 'fox',   icon: 'ü¶ä', name: 'Foxy (SE)',  cost: 1500, rarity: 'legendary' }
        ];

        const ARTICLES = ["der","die","das","den","dem","des","ein","eine","einen","einem"];

        // --- HELFER ---
        const speak = (txt) => {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'fr-FR';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        };

        const playSound = (type) => {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            const ctx = new Ctx();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g);
            g.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'correct') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                g.gain.setValueAtTime(0.2, now);
                g.gain.linearRampToValueAtTime(0, now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                g.gain.setValueAtTime(0.25, now);
                g.gain.linearRampToValueAtTime(0, now + 0.3);
            } else if (type === 'win') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.5);
                g.gain.setValueAtTime(0.3, now);
                g.gain.linearRampToValueAtTime(0, now + 1);
            }
            osc.start(now);
            osc.stop(now + 1);
        };

        const safeConfetti = () => {
            if (window.confetti) {
                window.confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
            }
        };

        const getRankTitle = lvl =>
            RANKS[Math.min(Math.floor((lvl - 1) / 3), RANKS.length - 1)];

        const getXPForLevel = lvl => 200 * lvl;

        const stripArticle = (txt) => {
            const parts = txt.trim().toLowerCase().split(/\s+/);
            if (parts.length > 1 && ARTICLES.includes(parts[0])) {
                return parts.slice(1).join(" ");
            }
            return txt.trim().toLowerCase();
        };

        // --- COMPONENTS ---

        // 1. MEMORY
        const MemoryGame = ({ words, onFinish }) => {
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);
            const [lock, setLock] = useState(false);

            useEffect(() => {
                const selection = [...words].sort(() => Math.random()-0.5).slice(0, 8);
                const deck = selection.flatMap(p => ([
                    { id: p.fr + "-fr", txt: p.fr, type: "fr", pair: p.fr },
                    { id: p.fr + "-de", txt: DICTIONARY[p.fr], type: "de", pair: p.fr }
                ])).sort(() => Math.random()-0.5);
                setCards(deck);
            }, [words]);

            const click = (card) => {
                if (lock || flipped.includes(card.id) || matched.includes(card.id)) return;
                if (card.type === "fr") speak(card.txt);

                const nf = [...flipped, card.id];
                setFlipped(nf);

                if (nf.length === 2) {
                    setLock(true);
                    const c1 = cards.find(c => c.id === nf[0]);
                    const c2 = cards.find(c => c.id === nf[1]);
                    if (c1.pair === c2.pair) {
                        playSound('correct');
                        setTimeout(() => {
                            setMatched(prev => [...prev, c1.id, c2.id]);
                            setFlipped([]);
                            setLock(false);
                            if (matched.length + 2 === cards.length) {
                                setTimeout(onFinish, 600);
                            }
                        }, 400);
                    } else {
                        playSound('wrong');
                        setTimeout(() => {
                            setFlipped([]);
                            setLock(false);
                        }, 700);
                    }
                }
            };

            return (
                <div className="grid grid-cols-3 gap-3 w-full max-w-md mx-auto pop-in">
                    {cards.map(c => (
                        <div key={c.id} className="scene" onClick={() => click(c)}>
                            <div className={
                                "card " +
                                (flipped.includes(c.id) ? "flipped " : "") +
                                (matched.includes(c.id) ? "matched" : "")
                            }>
                                <div className="face front">?</div>
                                <div className={`face back ${c.type === 'fr' ? 'type-fr' : 'type-de'}`}>
                                    {c.txt}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // 2. LISTEN (fr h√∂ren, DE ausw√§hlen, Anti-Cheat: nach Fehlversuch -5 M√ºnzen)
        const ListenGame = ({ words, onFinish, onMistake }) => {
            const [q, setQ] = useState(null);
            const [count, setCount] = useState(0);

            const next = () => {
                if (count >= 6) { onFinish(); return; }
                const t = words[Math.floor(Math.random()*words.length)];
                const options = new Set([t.fr]);
                while (options.size < 4 && options.size < words.length) {
                    const r = words[Math.floor(Math.random()*words.length)].fr;
                    options.add(r);
                }
                const opt = [...options].sort(() => Math.random()-0.5);
                setQ({ target: t.fr, options: opt });
                speak(t.fr);
                setCount(c => c+1);
            };
            useEffect(next, []);

            if (!q) return null;

            const handleClick = (frChoice) => {
                if (frChoice === q.target) {
                    playSound('correct');
                    next();
                } else {
                    playSound('wrong');
                    if (onMistake) onMistake();
                }
            };

            return (
                <div className="w-full max-w-md mx-auto pop-in">
                    <div className="glass-panel p-10 mb-6 flex flex-col items-center gap-3">
                        <button
                            onClick={() => speak(q.target)}
                            className="w-24 h-24 rounded-full bg-pink-500 text-5xl flex items-center justify-center shadow-lg hover:scale-110 transition"
                        >
                            üîä
                        </button>
                        <div className="text-xs text-slate-300 font-bold uppercase tracking-wide">
                            H√∂re das Wort und w√§hle die richtige deutsche √úbersetzung.
                        </div>
                    </div>
                    <div className="grid gap-3">
                        {q.options.map(frOpt => (
                            <button
                                key={frOpt}
                                onClick={() => handleClick(frOpt)}
                                className="btn-action btn-blue w-full px-4 py-3 justify-start text-left"
                            >
                                {DICTIONARY[frOpt]}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // 3. QUIZ (FR ‚Üí 4√ó DE, aber alles sichtbar)
        const QuizGame = ({ words, onFinish }) => {
            const [q, setQ] = useState(null);
            const [count, setCount] = useState(0);

            const next = () => {
                if (count >= 6) { onFinish(); return; }
                const t = words[Math.floor(Math.random()*words.length)];
                const options = new Set([t.fr]);
                while (options.size < 4 && options.size < words.length) {
                    const r = words[Math.floor(Math.random()*words.length)].fr;
                    options.add(r);
                }
                const opt = [...options].sort(() => Math.random()-0.5);
                setQ({ target: t.fr, options: opt });
                setCount(c => c+1);
            };
            useEffect(next, []);

            if (!q) return null;

            const click = (frChoice) => {
                if (frChoice === q.target) {
                    playSound('correct');
                    next();
                } else {
                    playSound('wrong');
                }
            };

            return (
                <div className="w-full max-w-md mx-auto pop-in">
                    <div className="glass-panel p-6 mb-6 text-center">
                        <h2 className="text-3xl font-black text-yellow-300 mb-2 font-game">
                            {q.target}
                        </h2>
                        <button
                            onClick={() => speak(q.target)}
                            className="text-xs bg-yellow-500 text-black px-3 py-1 rounded-full font-bold"
                        >
                            üîä H√∂ren
                        </button>
                    </div>
                    <div className="grid gap-3">
                        {q.options.map(frOpt => (
                            <button
                                key={frOpt}
                                onClick={() => click(frOpt)}
                                className="btn-action btn-purple w-full px-4 py-3 justify-start text-left"
                            >
                                {DICTIONARY[frOpt]}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. WRITE ‚Äì nur FR angezeigt, DE schreiben, tolerant bei Artikeln
        const WriteGame = ({ words, onFinish, helpers, onUseHelper }) => {
            const [q, setQ] = useState(null);
            const [inp, setInp] = useState("");
            const [count, setCount] = useState(0);
            const [tip, setTip] = useState(null);

            const next = () => {
                if (count >= 6) { onFinish(); return; }
                const t = words[Math.floor(Math.random()*words.length)];
                setQ(t);
                setInp("");
                setTip(null);
                speak(t.fr);
                setCount(c => c+1);
            };
            useEffect(next, []);

            if (!q) return null;

            const solution = DICTIONARY[q.fr];

            const check = () => {
                const user = inp.trim().toLowerCase();
                const sol = solution.trim().toLowerCase();

                if (!user) return;

                // komplett korrekt
                if (user === sol) {
                    playSound('correct');
                    next();
                    return;
                }

                // Artikel ignorieren
                if (stripArticle(user) === stripArticle(sol)) {
                    playSound('correct');
                    alert("Inhalt richtig üëç\nAchte noch auf den richtigen Artikel (der/die/das) und Grossschreibung.");
                    next();
                } else {
                    playSound('wrong');
                    alert("Falsch.\nL√∂sung: " + solution);
                }
            };

            const useHelp = () => {
                if (!onUseHelper || helpers <= 0) return;
                onUseHelper();
                const sol = stripArticle(solution);
                if (sol.length > 0) {
                    setTip("Tipp: Das Wort beginnt mit ‚Äû" + sol[0].toUpperCase() + "‚Ä¶‚Äú");
                }
            };

            return (
                <div className="w-full max-w-md mx-auto pop-in">
                    <div className="glass-panel p-8 mb-4 text-center">
                        <h2 className="text-3xl font-black text-green-400 mb-2 font-game">
                            {q.fr}
                        </h2>
                        <button
                            onClick={() => speak(q.fr)}
                            className="text-xs bg-green-600 px-3 py-1 rounded-full font-bold"
                        >
                            üîä Nochmal h√∂ren
                        </button>
                    </div>

                    <input
                        value={inp}
                        onChange={e => setInp(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && check()}
                        className="w-full p-4 rounded-2xl bg-slate-900 text-xl text-center border-2 border-slate-600 focus:border-green-400 outline-none mb-3"
                        placeholder="Deutsch eingeben (z.B. Die Maus)"
                        autoFocus
                    />

                    <div className="flex gap-2 justify-center mb-3">
                        {['√§','√∂','√º','√ü'].map(c => (
                            <button
                                key={c}
                                onClick={() => setInp(i => i + c)}
                                className="w-9 h-9 rounded bg-slate-700 text-white font-bold"
                            >
                                {c}
                            </button>
                        ))}
                    </div>

                    {tip && <div className="text-xs text-yellow-300 text-center mb-2">{tip}</div>}

                    <div className="flex gap-3">
                        <button
                            onClick={check}
                            className="btn-action btn-green flex-1 py-3"
                        >
                            Pr√ºfen
                        </button>
                        {helpers > 0 && (
                            <button
                                onClick={useHelp}
                                className="btn-action btn-blue flex-1 py-3 text-xs leading-tight"
                            >
                                üí° Hilfe ({helpers})
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // SHOP mit Gl√ºcksrad + Items
        const Shop = ({ user, onBuyAvatar, onEquip, onClose, canSpin, onSpin, onBuyItem }) => {
            return (
                <div className="max-w-md mx-auto p-4 min-h-screen pb-20 flex flex-col gap-4">
                    <div className="flex items-center justify-between mb-2">
                        <button onClick={onClose} className="text-slate-300 text-sm font-bold">
                            ‚óÄ Zur√ºck
                        </button>
                        <a href="index.html" className="text-xs text-slate-400 underline">
                            üè† Startseite
                        </a>
                    </div>

                    <div className="glass-panel p-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="text-3xl bg-white/10 px-3 py-2 rounded-xl">
                                {AVATARS.find(a => a.id === user.avatar)?.icon}
                            </div>
                            <div>
                                <div className="font-bold text-white">{user.name}</div>
                                <div className="text-xs text-blue-400 font-bold uppercase">
                                    {getRankTitle(user.level)}
                                </div>
                            </div>
                        </div>
                        <div className="text-right text-xs">
                            <div className="text-yellow-400 font-bold text-sm">{user.coins} M√ºnzen</div>
                            <div className="text-green-400 font-bold text-xs">Lvl {user.level}</div>
                        </div>
                    </div>

                    {/* Gl√ºcksrad */}
                    <div className="glass-panel p-4">
                        <h2 className="font-game text-lg font-black mb-2 text-yellow-300">
                            üé° Tages-Gl√ºcksrad
                        </h2>
                        <p className="text-xs text-slate-300 mb-3">
                            Einmal pro Tag drehen und zuf√§llige Belohnungen gewinnen:
                            M√ºnzen, XP oder seltene Avatare.
                        </p>
                        <button
                            onClick={onSpin}
                            disabled={!canSpin}
                            className={
                                "btn-action w-full py-3 " +
                                (canSpin ? "btn-yellow" : "btn-blue opacity-60 cursor-not-allowed")
                            }
                        >
                            {canSpin ? "Jetzt drehen!" : "Heute schon gedreht"}
                        </button>
                    </div>

                    {/* Avatare */}
                    <div className="glass-panel p-4">
                        <h2 className="font-game text-lg font-black mb-3">üêæ Avatar-Shop</h2>
                        <div className="grid grid-cols-3 gap-3">
                            {AVATARS.map(a => {
                                const owned = user.unlocked.includes(a.id);
                                const active = user.avatar === a.id;
                                return (
                                    <div
                                        key={a.id}
                                        className={
                                            "shop-card rarity-" + a.rarity +
                                            (active ? " ring-4 ring-green-400" : "") +
                                            (!owned && user.coins < a.cost ? " opacity-40" : "")
                                        }
                                        onClick={() => {
                                            if (owned) {
                                                onEquip(a.id);
                                                playSound('correct');
                                            } else if (user.coins >= a.cost) {
                                                onBuyAvatar(a);
                                                playSound('win');
                                                safeConfetti();
                                            } else {
                                                alert("Zu wenig M√ºnzen.");
                                            }
                                        }}
                                    >
                                        <div className="text-3xl mb-1">{a.icon}</div>
                                        <div className="text-xs font-bold">{a.name}</div>
                                        {!owned && (
                                            <div className="text-[10px] mt-1 font-bold">
                                                {a.cost} üí∞
                                            </div>
                                        )}
                                        {owned && !active && (
                                            <div className="text-[10px] text-green-500 mt-1 font-bold">
                                                Besitz
                                            </div>
                                        )}
                                        {active && (
                                            <div className="text-[10px] text-green-300 mt-1 font-bold">
                                                Aktiv
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        <div className="text-[10px] text-slate-400 mt-2">
                            Legende: grau = h√§ufig, blau = selten, lila = episch, gold = legend√§r.
                        </div>
                    </div>

                    {/* Lern-Hilfen */}
                    <div className="glass-panel p-4">
                        <h2 className="font-game text-lg font-black mb-2">üß† Lern-Helfer</h2>
                        <div className="space-y-2 text-xs">
                            <div className="flex items-center justify-between">
                                <div>
                                    <div className="font-bold">Tipp-Jeton</div>
                                    <div className="text-slate-300">
                                        Zeigt im Schreib-Spiel einen Buchstaben-Hinweis.
                                    </div>
                                </div>
                                <button
                                    onClick={() => onBuyItem('hints', 80)}
                                    className="btn-action btn-blue px-3 py-2 text-[11px]"
                                >
                                    80 üí∞ kaufen
                                </button>
                            </div>
                        </div>
                        <div className="mt-2 text-[11px] text-slate-400">
                            Du besitzt: {user.items?.hints || 0} Tipp-Jetons.
                        </div>
                    </div>
                </div>
            );
        };

        // Modal
        const Modal = ({ title, children, type = "info", onClose }) => (
            <div className="modal-overlay" onClick={onClose}>
                <div
                    className={
                        "glass-panel p-6 max-w-sm w-full mx-4 pop-in border-4 " +
                        (type === 'win' ? "border-yellow-400" :
                         type === 'error' ? "border-red-500" : "border-blue-500")
                    }
                    onClick={e => e.stopPropagation()}
                >
                    <h2 className={
                        "text-2xl font-black font-game mb-3 " +
                        (type === 'win' ? "text-yellow-300" :
                         type === 'error' ? "text-red-400" : "text-white")
                    }>
                        {title}
                    </h2>
                    <div className="text-sm text-slate-200 mb-4">{children}</div>
                    <button onClick={onClose} className="btn-action btn-blue w-full py-3">
                        OK
                    </button>
                </div>
            </div>
        );

        // --- APP ---
        const App = () => {
            const [user, setUser] = useState({
                name: 'Agent',
                coins: 0,
                xp: 0,
                level: 1,
                avatar: 'kid',
                unlocked: ['kid'],
                items: { hints: 0 },
                lastSpin: null
            });
            const [view, setView] = useState('menu');   // menu, map, game, shop
            const [mode, setMode] = useState(null);     // memory, listen, write, quiz
            const [activeWorld, setActiveWorld] = useState(null);
            const [modal, setModal] = useState(null);

            // Load
            useEffect(() => {
                const s = localStorage.getItem('franz_galaxy_v3');
                if (s) {
                    try {
                        const parsed = JSON.parse(s);
                        setUser(prev => ({ ...prev, ...parsed }));
                    } catch(e) {
                        console.error(e);
                    }
                }
            }, []);

            const save = (u) => {
                setUser(u);
                localStorage.setItem('franz_galaxy_v3', JSON.stringify(u));
            };

            const todayStr = new Date().toISOString().slice(0,10);
            const canSpin = user.lastSpin !== todayStr;

            const addProgress = (xpGain, coinGain) => {
                let u = { ...user };
                u.coins += coinGain;
                if (u.level < MAX_LEVEL) {
                    u.xp += xpGain;
                    const next = getXPForLevel(u.level + 1);
                    if (u.xp >= next) {
                        u.level += 1;
                        safeConfetti();
                        playSound('win');
                        setModal({
                            title: "LEVEL UP!",
                            text: `Du bist jetzt ${getRankTitle(u.level)} (Lvl ${u.level}).`
                        });
                    } else {
                        playSound('win');
                        setModal({
                            title: "Mission erledigt!",
                            text: `+${xpGain} XP | +${coinGain} M√ºnzen`
                        });
                    }
                } else {
                    // Max-Level erreicht ‚Äì nur M√ºnzen
                    u.xp = getXPForLevel(MAX_LEVEL);
                    u.coins += 0;
                    playSound('win');
                    setModal({
                        title: "Max-Level erreicht!",
                        text: `Du bist schon bei Level ${MAX_LEVEL}.`
                    });
                }
                save(u);
                setView('menu');
            };

            const handleSpin = () => {
                if (!canSpin) {
                    alert("Heute schon gedreht.");
                    return;
                }
                let u = { ...user };
                const roll = Math.random();
                let msg = "";
                if (roll < 0.4) {
                    u.coins += 100;
                    msg = "+100 M√ºnzen!";
                } else if (roll < 0.7) {
                    u.coins += 200;
                    msg = "+200 M√ºnzen!";
                } else if (roll < 0.9) {
                    u.xp += 200;
                    msg = "+200 XP!";
                } else {
                    // rare Avatar (random legendary)
                    const legendary = AVATARS.filter(a => a.rarity === 'legendary');
                    const pick = legendary[Math.floor(Math.random()*legendary.length)];
                    if (!u.unlocked.includes(pick.id)) {
                        u.unlocked.push(pick.id);
                        msg = "Legend√§rer Avatar freigeschaltet: " + pick.name;
                    } else {
                        u.coins += 300;
                        msg = "Legend√§rer Avatar war schon frei ‚Äì stattdessen +300 M√ºnzen.";
                    }
                }
                u.lastSpin = todayStr;
                safeConfetti();
                playSound('win');
                save(u);
                setModal({ title: "Gl√ºcksrad", text: msg });
            };

            const goMode = (m) => {
                setMode(m);
                setActiveWorld(null);
                setView('map');
            };

            const resetAll = () => {
                if (!confirm("Alles wirklich zur√ºcksetzen? Level, M√ºnzen, Avatare?")) return;
                const fresh = {
                    name: 'Agent',
                    coins: 0,
                    xp: 0,
                    level: 1,
                    avatar: 'kid',
                    unlocked: ['kid'],
                    items: { hints: 0 },
                    lastSpin: null
                };
                save(fresh);
                setMode(null);
                setActiveWorld(null);
                setView('menu');
            };

            // --- Views ---

            // MENU ‚Äì zuerst Spieltyp w√§hlen
            if (view === 'menu') {
                const nextXP = getXPForLevel(user.level + 1);
                const progress = Math.min(100, (user.xp / nextXP) * 100);
                return (
                    <div className="max-w-md mx-auto p-4 min-h-screen flex flex-col gap-4">
                        <div className="flex justify-between items-center">
                            <a href="index.html" className="text-xs text-slate-400 underline">
                                üè† Startseite
                            </a>
                            <button
                                onClick={resetAll}
                                className="text-[10px] text-red-400 underline"
                            >
                                Alles zur√ºcksetzen
                            </button>
                        </div>

                        <div className="glass-panel p-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="text-4xl bg-white/10 px-3 py-2 rounded-2xl">
                                    {AVATARS.find(a => a.id === user.avatar)?.icon}
                                </div>
                                <div>
                                    <div className="font-bold text-white">{user.name}</div>
                                    <div className="text-[11px] text-blue-400 font-bold uppercase">
                                        {getRankTitle(user.level)} ‚Ä¢ Lvl {user.level}
                                    </div>
                                </div>
                            </div>
                            <div className="text-right text-xs">
                                <div className="text-yellow-400 font-bold text-sm">
                                    {user.coins} M√ºnzen
                                </div>
                                <div className="mt-1 xp-track w-28 mx-auto">
                                    <div className="xp-fill" style={{ width: progress + '%' }}></div>
                                </div>
                            </div>
                        </div>

                        <h1 className="text-center font-game text-2xl text-white font-black mt-2">
                            W√§hle dein Training
                        </h1>

                        <div className="grid grid-cols-2 gap-3">
                            <button
                                onClick={() => goMode('memory')}
                                className="btn-action btn-green py-4 flex flex-col"
                            >
                                <span className="text-2xl mb-1">üÉè</span>
                                <span>Memory</span>
                            </button>
                            <button
                                onClick={() => goMode('listen')}
                                className="btn-action btn-yellow py-4 flex flex-col"
                            >
                                <span className="text-2xl mb-1">üëÇ</span>
                                <span>H√∂r zu</span>
                            </button>
                            <button
                                onClick={() => goMode('write')}
                                className="btn-action btn-red py-4 flex flex-col"
                            >
                                <span className="text-2xl mb-1">‚úçÔ∏è</span>
                                <span>Schreiben</span>
                            </button>
                            <button
                                onClick={() => goMode('quiz')}
                                className="btn-action btn-purple py-4 flex flex-col"
                            >
                                <span className="text-2xl mb-1">‚ùì</span>
                                <span>Quiz</span>
                            </button>
                        </div>

                        <button
                            onClick={() => setView('shop')}
                            className="btn-action btn-blue py-4 mt-2 flex flex-col"
                        >
                            <span className="text-2xl mb-1">üõí</span>
                            <span>Shop & Gl√ºcksrad</span>
                        </button>
                    </div>
                );
            }

            // MAP ‚Äì Welt w√§hlen, Modus steht schon fest
            if (view === 'map') {
                const nextXP = getXPForLevel(user.level + 1);
                const progress = Math.min(100, (user.xp / nextXP) * 100);
                const modeLabel = {
                    memory: "Memory",
                    listen: "H√∂r zu",
                    write: "Schreiben",
                    quiz: "Quiz"
                }[mode] || "";

                return (
                    <div className="max-w-md mx-auto p-4 min-h-screen flex flex-col gap-4">
                        <div className="flex justify-between items-center">
                            <button
                                onClick={() => setView('menu')}
                                className="text-slate-300 text-sm font-bold"
                            >
                                ‚óÄ Zur√ºck
                            </button>
                            <a href="index.html" className="text-xs text-slate-400 underline">
                                üè† Startseite
                            </a>
                        </div>

                        <div className="glass-panel p-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="text-3xl bg-white/10 px-3 py-2 rounded-xl">
                                    {AVATARS.find(a => a.id === user.avatar)?.icon}
                                </div>
                                <div>
                                    <div className="font-bold text-white">{user.name}</div>
                                    <div className="text-[11px] text-blue-400 font-bold uppercase">
                                        {getRankTitle(user.level)} ‚Ä¢ Lvl {user.level}
                                    </div>
                                </div>
                            </div>
                            <div className="text-right text-xs">
                                <div className="text-yellow-400 font-bold text-sm">
                                    {user.coins} üí∞
                                </div>
                                <div className="mt-1 xp-track w-24 mx-auto">
                                    <div className="xp-fill" style={{ width: progress + '%' }}></div>
                                </div>
                            </div>
                        </div>

                        <h2 className="font-game text-xl text-white text-center">
                            Modus: {modeLabel}
                        </h2>

                        <div className="space-y-3">
                            {WORLDS.map(world => {
                                const locked = user.level < world.reqLvl;
                                return (
                                    <div key={world.id} className="glass-panel p-3 flex items-center gap-3">
                                        <div className="text-3xl">{locked ? 'üîí' : world.icon}</div>
                                        <div className="flex-1">
                                            <div className="font-bold text-white text-sm">
                                                {world.name}
                                            </div>
                                            <div className="text-[11px] text-slate-400">
                                                {world.words.length} W√∂rter ‚Ä¢ ab Level {world.reqLvl}
                                            </div>
                                        </div>
                                        <button
                                            disabled={locked}
                                            onClick={() => {
                                                setActiveWorld(world);
                                                setView('game');
                                            }}
                                            className={
                                                "btn-action py-2 px-4 text-xs " +
                                                (locked ? "btn-blue opacity-40 cursor-not-allowed" : "btn-green")
                                            }
                                        >
                                            Start
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            // GAME
            if (view === 'game' && activeWorld) {
                const finish = () => {
                    // je nach Modus unterschiedliche Belohnung
                    if (mode === 'memory')      addProgress(60, 30);
                    else if (mode === 'listen') addProgress(50, 25);
                    else if (mode === 'write')  addProgress(70, 35);
                    else if (mode === 'quiz')   addProgress(50, 25);
                    else addProgress(40, 20);
                };

                const handleMistake = () => {
                    let u = { ...user };
                    u.coins = Math.max(0, u.coins - 5);
                    save(u);
                };

                const useHint = () => {
                    let u = { ...user };
                    if ((u.items?.hints || 0) <= 0) return;
                    u.items = { ...(u.items || {}), hints: (u.items.hints || 0) - 1 };
                    save(u);
                };

                return (
                    <div className="min-h-screen p-4 flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <button
                                onClick={() => setView('map')}
                                className="glass-panel w-10 h-10 flex items-center justify-center text-xl"
                            >
                                ‚úï
                            </button>
                            <div className="text-xs text-slate-300">
                                {activeWorld.name}
                            </div>
                            <a
                                href="index.html"
                                className="glass-panel w-10 h-10 flex items-center justify-center text-lg"
                            >
                                üè†
                            </a>
                        </div>

                        <div className="flex-1 flex items-center justify-center">
                            {mode === 'memory' && (
                                <MemoryGame
                                    words={activeWorld.words}
                                    onFinish={finish}
                                />
                            )}
                            {mode === 'listen' && (
                                <ListenGame
                                    words={activeWorld.words}
                                    onFinish={finish}
                                    onMistake={handleMistake}
                                />
                            )}
                            {mode === 'quiz' && (
                                <QuizGame
                                    words={activeWorld.words}
                                    onFinish={finish}
                                />
                            )}
                            {mode === 'write' && (
                                <WriteGame
                                    words={activeWorld.words}
                                    onFinish={finish}
                                    helpers={user.items?.hints || 0}
                                    onUseHelper={useHint}
                                />
                            )}
                        </div>
                    </div>
                );
            }

            // SHOP
            if (view === 'shop') {
                return (
                    <>
                        <Shop
                            user={user}
                            onClose={() => setView('menu')}
                            canSpin={canSpin}
                            onSpin={handleSpin}
                            onBuyAvatar={(avatar) => {
                                const u = { ...user };
                                u.coins -= avatar.cost;
                                if (!u.unlocked.includes(avatar.id)) {
                                    u.unlocked = [...u.unlocked, avatar.id];
                                }
                                u.avatar = avatar.id;
                                save(u);
                            }}
                            onEquip={(id) => {
                                const u = { ...user, avatar: id };
                                save(u);
                            }}
                            onBuyItem={(type, cost) => {
                                if (user.coins < cost) {
                                    alert("Zu wenig M√ºnzen.");
                                    return;
                                }
                                const u = { ...user };
                                u.coins -= cost;
                                const items = { ...(u.items || {}) };
                                items[type] = (items[type] || 0) + 1;
                                u.items = items;
                                save(u);
                            }}
                        />
                        {modal && (
                            <Modal
                                title={modal.title}
                                type="info"
                                onClose={() => setModal(null)}
                            >
                                {modal.text}
                            </Modal>
                        )}
                    </>
                );
            }

            return null;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
