<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Galaxy Final</title>
    
    <!-- ENGINE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <style>
        :root { --primary: #6366f1; --secondary: #a855f7; --bg-dark: #0f172a; }
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        .font-game { font-family: 'Baloo 2', cursive; }

        /* --- HINTERGRUND --- */
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at bottom, #1e293b 0%, #020617 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle 4s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border-radius: 24px;
        }

        .btn-action {
            transition: all 0.1s; border-radius: 16px; 
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3); cursor: pointer;
            border-bottom-width: 6px; position: relative; overflow: hidden;
        }
        .btn-action:active { transform: translateY(4px); border-bottom-width: 2px; box-shadow: none; }
        
        .btn-blue { background: #3b82f6; border-color: #1d4ed8; color: white; }
        .btn-green { background: #22c55e; border-color: #15803d; color: white; }
        .btn-purple { background: #8b5cf6; border-color: #6d28d9; color: white; }
        .btn-yellow { background: #eab308; border-color: #a16207; color: white; }
        .btn-red { background: #ef4444; border-color: #b91c1c; color: white; }

        /* --- MEMORY KARTEN --- */
        .scene { perspective: 1000px; height: 100px; cursor: pointer; }
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { animation: popOut 0.5s forwards; pointer-events: none; }
        
        .face {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 16px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 3px solid rgba(255,255,255,0.2);
        }
        .front { background: linear-gradient(135deg, #6366f1, #a855f7); font-size: 2.5rem; z-index: 2; color: white; }
        .back { background: #1e293b; transform: rotateY(180deg); z-index: 1; padding: 5px; text-align: center; font-weight: 800; font-size: 0.95rem; }
        
        .type-fr .back { border-color: #3b82f6; color: #60a5fa; background: #172554; }
        .type-de .back { border-color: #f97316; color: #fdba74; background: #431407; }

        /* --- VERBINDEN KARTEN --- */
        .match-card {
            background: #1e293b; border: 3px solid #334155; border-radius: 16px; padding: 12px;
            font-weight: 800; cursor: pointer; transition: all 0.2s; min-height: 60px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            box-shadow: 0 4px 0 #0f172a; font-size: 1.1rem;
        }
        .match-card:active { transform: translateY(4px); box-shadow: none; }
        .match-card.fr { border-left: 6px solid #3b82f6; color: #93c5fd; }
        .match-card.de { border-right: 6px solid #f97316; color: #fdba74; }
        .match-card.selected { background: #1e3a8a; border-color: #3b82f6; transform: scale(1.05); z-index: 10; color: white; box-shadow: 0 0 20px rgba(59,130,246,0.5); }
        .match-card.matched { animation: popOut 0.4s forwards; }

        /* --- AVATAR SHOP CARDS --- */
        .shop-card { transition: all 0.2s; position: relative; overflow: hidden; cursor: pointer; border-width: 3px; }
        .shop-card:active { transform: scale(0.95); }
        .rarity-common { border-color: #94a3b8; background: #f1f5f9; color: #334155; }
        .rarity-rare { border-color: #3b82f6; background: #eff6ff; color: #1e3a8a; box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        .rarity-epic { border-color: #a855f7; background: #faf5ff; color: #581c87; box-shadow: 0 0 15px rgba(168,85,247,0.5); animation: pulse 2s infinite; }
        .rarity-legendary { border-color: #eab308; background: linear-gradient(135deg, #422006, #713f12); box-shadow: 0 0 20px rgba(234,179,8,0.6); animation: shine 2s infinite; }

        /* --- ANIMATIONS --- */
        @keyframes popOut { 0% { transform: scale(1); } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
        @keyframes shine { 0% { filter: brightness(1); } 50% { filter: brightness(1.2); } 100% { filter: brightness(1); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(168,85,247,0.4); } 70% { box-shadow: 0 0 0 10px rgba(168,85,247,0); } }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* LOADING */
        #loading { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* XP Bar */
        .xp-track { height: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.2); }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #22c55e); transition: width 1s ease-out; }

        /* Input Field */
        .input-galaxy { background: #0f172a; border: 3px solid #334155; color: white; text-align: center; font-size: 1.5rem; padding: 1rem; border-radius: 16px; outline: none; width: 100%; }
        .input-galaxy:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div class="stars" id="stars"></div>
    
    <div id="loading">
        <div class="text-6xl mb-6 animate-bounce">üá´üá∑</div>
        <div class="text-2xl font-black text-blue-500 tracking-[0.3em] font-game">LADE GALAXY...</div>
    </div>
    
    <div id="root"></div>

    <script type="text/babel">
        // --- INIT ---
        const starCont = document.getElementById('stars');
        for(let i=0; i<50; i++) {
            const s = document.createElement('div'); s.className = 'star';
            s.style.top = Math.random()*100+'%'; s.style.left = Math.random()*100+'%';
            s.style.width = Math.random()*3+'px'; s.style.height = s.style.width;
            s.style.animationDelay = Math.random()*5+'s'; starCont.appendChild(s);
        }

        setTimeout(() => document.getElementById('loading').style.display='none', 1000);
        window.onerror = function(msg) { console.error("Error:", msg); return false; };

        const { useState, useEffect, useRef } = React;

        // --- DATEN ---
        const LEVELS = [0, 200, 500, 1000, 2000, 3500, 5500, 8000, 11000, 15000, 20000];
        const RANKS = ["Kadett", "Entdecker", "Pilot", "Captain", "Commander", "Admiral", "Galactic Hero"];

        // Welten (Levels) - INHALT AUS "√áA ROULE"
        const WORLDS = [
            { 
                id: 1, name: "Basis Lager", icon: "üöÄ", reqLvl: 1, 
                words: [
                    {fr:"Bonjour", de:"Guten Tag"}, {fr:"Salut", de:"Hallo"}, {fr:"Au revoir", de:"Auf Wiedersehen"}, 
                    {fr:"Merci", de:"Danke"}, {fr:"S'il vous pla√Æt", de:"Bitte"}, {fr:"Oui", de:"Ja"}, {fr:"Non", de:"Nein"},
                    {fr:"Je", de:"Ich"}, {fr:"Tu", de:"Du"}, {fr:"Il", de:"Er"}, {fr:"Elle", de:"Sie"}
                ] 
            },
            { 
                id: 2, name: "Struktur", icon: "üß©", reqLvl: 1, 
                words: [
                    {fr:"D'abord", de:"Zuerst"}, {fr:"Puis", de:"Dann"}, {fr:"Apr√®s", de:"Danach"}, 
                    {fr:"Finalement", de:"Schliesslich"}, {fr:"De", de:"Von"}, {fr:"Garder", de:"Behalten"},
                    {fr:"Peut-√™tre", de:"Vielleicht"}, {fr:"Toujours", de:"Immer"}, {fr:"Jamais", de:"Nie"}
                ] 
            },
            { 
                id: 3, name: "Die Schule", icon: "üè´", reqLvl: 2, 
                words: [
                    {fr:"L'√©cole", de:"Die Schule"}, {fr:"Le livre", de:"Das Buch"}, {fr:"Le cahier", de:"Das Heft"}, 
                    {fr:"Le crayon", de:"Der Bleistift"}, {fr:"La gomme", de:"Der Gummi"}, {fr:"La trousse", de:"Das Etui"},
                    {fr:"La classe", de:"Die Klasse"}, {fr:"Le devoir", de:"Die Hausaufgabe"}
                ] 
            },
            { 
                id: 4, name: "Tier-Planet", icon: "ü¶Å", reqLvl: 3, 
                words: [
                    {fr:"Le chien", de:"Der Hund"}, {fr:"Le chat", de:"Die Katze"}, {fr:"La souris", de:"Die Maus"},
                    {fr:"L'oiseau", de:"Der Vogel"}, {fr:"Le cheval", de:"Das Pferd"}, {fr:"La vache", de:"Die Kuh"},
                    {fr:"Le cochon", de:"Das Schwein"}, {fr:"Le lion", de:"Der L√∂we"}
                ] 
            },
            { 
                id: 5, name: "Farben-Nebel", icon: "üé®", reqLvl: 5, 
                words: [
                    {fr:"Rouge", de:"Rot"}, {fr:"Bleu", de:"Blau"}, {fr:"Vert", de:"Gr√ºn"}, {fr:"Jaune", de:"Gelb"},
                    {fr:"Noir", de:"Schwarz"}, {fr:"Blanc", de:"Weiss"}, {fr:"Gris", de:"Grau"}, {fr:"Orange", de:"Orange"}
                ] 
            },
            { 
                id: 6, name: "Aktion", icon: "‚ö°", reqLvl: 7, 
                words: [
                    {fr:"Jouer", de:"Spielen"}, {fr:"Chanter", de:"Singen"}, {fr:"Parler", de:"Sprechen"}, 
                    {fr:"√âcouter", de:"Zuh√∂ren"}, {fr:"Regarder", de:"Schauen"}, {fr:"Manger", de:"Essen"},
                    {fr:"Boire", de:"Trinken"}, {fr:"Dormir", de:"Schlafen"}, {fr:"Chercher", de:"Suchen"}
                ] 
            }
        ];

        // Hilfs-Dictionary f√ºr schnellen Zugriff
        const DICTIONARY = {};
        WORLDS.forEach(w => w.words.forEach(pair => DICTIONARY[pair.fr] = pair.de));

        const AVATARS = [
            { id: 'bear', icon: 'üêª', name: 'Bruno', cost: 0, rarity: 'common' },
            { id: 'cat', icon: 'üê±', name: 'Mimi', cost: 100, rarity: 'common' },
            { id: 'fox', icon: 'ü¶ä', name: 'Foxy', cost: 300, rarity: 'rare' },
            { id: 'robot', icon: 'ü§ñ', name: 'Robo', cost: 1000, rarity: 'epic' },
            { id: 'alien', icon: 'üëΩ', name: 'Zorg', cost: 1500, rarity: 'epic' },
            { id: 'dragon', icon: 'üê≤', name: 'Drago', cost: 5000, rarity: 'legendary' },
            { id: 'king', icon: 'üëë', name: 'King', cost: 10000, rarity: 'legendary' }
        ];

        const PACKS = [
            { id: 'basic', name: 'Starter Pack', cost: 100, emoji: 'üì¶', prob: { common: 70, rare: 29, epic: 1, legendary: 0 } },
            { id: 'gold', name: 'Gold Box', cost: 500, emoji: 'üéÅ', prob: { common: 20, rare: 50, epic: 25, legendary: 5 } },
            { id: 'legend', name: 'Legenden Box', cost: 2000, emoji: 'üíé', prob: { common: 0, rare: 10, epic: 50, legendary: 40 } }
        ];

        // --- HELPER ---
        const getXPForLevel = (lvl) => 200 * lvl;
        const getRankTitle = (lvl) => RANKS[Math.min(Math.floor((lvl-1)/2), RANKS.length-1)];
        
        const speak = (txt) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'fr-FR'; u.rate = 0.85;
                window.speechSynthesis.speak(u);
            }
        };

        const playSound = (type) => {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            const now = ctx.currentTime;
            
            if(type==='correct') {
                osc.type='triangle'; osc.frequency.setValueAtTime(600,now); osc.frequency.linearRampToValueAtTime(1000,now+0.1); g.gain.linearRampToValueAtTime(0,now+0.4);
            } else if(type==='wrong') {
                osc.type='sawtooth'; osc.frequency.setValueAtTime(150,now); g.gain.linearRampToValueAtTime(0,now+0.3);
            } else if(type==='win') {
                osc.type='sine'; osc.frequency.setValueAtTime(400,now); osc.frequency.linearRampToValueAtTime(800,now+0.6); g.gain.linearRampToValueAtTime(0,now+1);
            } else if(type==='cash') {
                osc.type='square'; osc.frequency.setValueAtTime(800,now); g.gain.linearRampToValueAtTime(0,now+0.4);
            }
            osc.start(now); osc.stop(now+1);
        };

        const safeConfetti = () => { if (window.confetti) window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); };

        // --- GAME COMPONENTS ---

        // 1. MEMORY GAME
        const MemoryGame = ({ words, onFinish }) => {
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);
            const [locked, setLocked] = useState(false);

            useEffect(() => {
                const selection = [...words].sort(()=>Math.random()-0.5).slice(0,6);
                const deck = selection.flatMap(p => [
                    { id: p.fr+'-fr', txt: p.fr, type: 'fr', pair: p.fr },
                    { id: p.fr+'-de', txt: DICTIONARY[p.fr], type: 'de', pair: p.fr }
                ]).sort(() => Math.random() - 0.5);
                setCards(deck);
            }, [words]);

            const click = (card) => {
                if(locked || flipped.includes(card.id) || matched.includes(card.id)) return;
                if(card.type === 'fr') speak(card.txt);
                
                const newFlipped = [...flipped, card.id];
                setFlipped(newFlipped);

                if(newFlipped.length === 2) {
                    setLocked(true);
                    const c1 = cards.find(x=>x.id===newFlipped[0]);
                    const c2 = cards.find(x=>x.id===newFlipped[1]);
                    if(c1.pair === c2.pair) {
                        playSound('correct');
                        setTimeout(() => {
                            setMatched([...matched, c1.id, c2.id]); setFlipped([]); setLocked(false);
                            if(matched.length+2 === cards.length) setTimeout(onFinish, 800);
                        }, 600);
                    } else {
                        playSound('wrong');
                        setTimeout(() => { setFlipped([]); setLocked(false); }, 1000);
                    }
                }
            };

            return (
                <div className="grid grid-cols-3 gap-3 w-full max-w-md">
                    {cards.map(c => (
                        <div key={c.id} className={`scene ${matched.includes(c.id)?'pointer-events-none':''}`} onClick={()=>click(c)}>
                            <div className={`card ${flipped.includes(c.id)?'flipped':''} ${matched.includes(c.id)?'matched':''}`}>
                                <div className="face front">?</div>
                                <div className={`face back type-${c.type}`}>{c.txt}</div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // 2. MATCHING GAME
        const MatchGame = ({ words, onFinish }) => {
            const [left, setLeft] = useState([]);
            const [right, setRight] = useState([]);
            const [sel, setSel] = useState(null);
            const [solved, setSolved] = useState([]);

            useEffect(() => {
                const s = [...words].sort(()=>Math.random()-0.5).slice(0,5);
                setLeft(s.map(w => ({id: w.fr, txt: w.fr, pair: w.fr, type: 'fr'})));
                setRight(s.map(w => ({id: w.fr+'d', txt: DICTIONARY[w.fr], pair: w.fr, type: 'de'})).sort(() => Math.random() - 0.5));
            }, [words]);

            const click = (item) => {
                if(solved.includes(item.pair)) return;
                if(item.type === 'fr') speak(item.txt);

                if(!sel) {
                    setSel(item);
                } else {
                    if(sel.id === item.id) { setSel(null); return; }
                    if(sel.pair === item.pair) {
                        setSolved([...solved, item.pair]); setSel(null); playSound('correct');
                        if(solved.length + 1 === 5) setTimeout(onFinish, 800);
                    } else {
                        playSound('wrong'); setSel(null);
                    }
                }
            };

            return (
                <div className="flex gap-4 w-full max-w-2xl px-2 h-full items-center">
                    <div className="w-1/2 flex flex-col gap-3 justify-center">
                        {left.map(l => (
                            <div key={l.id} onClick={()=>click(l)} className={`match-card fr ${sel?.id===l.id?'selected':''} ${solved.includes(l.pair)?'matched':''}`}>{l.txt}</div>
                        ))}
                    </div>
                    <div className="w-1/2 flex flex-col gap-3 justify-center">
                        {right.map(r => (
                            <div key={r.id} onClick={()=>click(r)} className={`match-card de ${sel?.id===r.id?'selected':''} ${solved.includes(r.pair)?'matched':''}`}>{r.txt}</div>
                        ))}
                    </div>
                </div>
            );
        };

        // 3. QUIZ GAME
        const QuizGame = ({ words, onFinish }) => {
            const [q, setQ] = useState(null);
            const [count, setCount] = useState(0);
            
            const next = () => {
                if(count >= 5) { onFinish(); return; }
                const t = words[Math.floor(Math.random()*words.length)];
                const o = [...words.filter(w=>w.fr!==t.fr).sort(()=>Math.random()-0.5).slice(0,3), t].sort(()=>Math.random()-0.5);
                setQ({t, o}); speak(t.fr); setCount(c=>c+1);
            };
            useEffect(next, []);

            const check = (val) => {
                if(val===q.t.fr){ playSound('correct'); next(); }
                else { playSound('wrong'); alert("Falsch! " + DICTIONARY[q.t.fr]); }
            };

            if(!q) return null;
            return (
                <div className="w-full max-w-md text-center pop-in p-4">
                    <div className="glass-panel p-8 mb-6">
                        <h1 className="text-3xl font-black text-blue-300 mb-2">{q.t.fr}</h1>
                        <button onClick={()=>speak(q.t.fr)} className="text-sm bg-blue-600 px-3 py-1 rounded-full">üîä H√∂ren</button>
                    </div>
                    <div className="grid gap-3">{q.o.map(w=><button key={w.de} onClick={()=>check(w.fr)} className="btn-action btn-purple w-full p-4 justify-start pl-6 text-sm">{DICTIONARY[w.fr]}</button>)}</div>
                </div>
            );
        };

        // 4. LISTEN GAME
        const ListenGame = ({ words, onFinish }) => {
            const [q, setQ] = useState(null);
            const [count, setCount] = useState(0);
            const next = () => {
                if(count >= 5) { onFinish(); return; }
                const t = words[Math.floor(Math.random()*words.length)];
                const o = [...words.filter(w=>w.fr!==t.fr).sort(()=>Math.random()-0.5).slice(0,3), t].sort(()=>Math.random()-0.5);
                setQ({t, o}); speak(t.fr); setCount(c=>c+1);
            };
            useEffect(next, []);
            const check = (val) => { if(val===q.t.fr){ playSound('correct'); next(); } else playSound('wrong'); };
            if(!q) return null;
            return (
                <div className="w-full max-w-md text-center pop-in">
                    <div className="glass-panel p-12 mb-6 flex justify-center">
                        <button onClick={()=>speak(q.t.fr)} className="w-24 h-24 bg-pink-500 rounded-full text-5xl shadow-lg hover:scale-110 transition animate-bounce">üîä</button>
                    </div>
                    <div className="grid gap-3">{q.o.map(w=><button key={w.de} onClick={()=>check(w.fr)} className="btn-action btn-blue w-full p-4 justify-start pl-6">{DICTIONARY[w.fr]}</button>)}</div>
                </div>
            );
        };

        // 5. WRITE GAME
        const WriteGame = ({ words, onFinish }) => {
            const [q, setQ] = useState(null);
            const [inp, setInp] = useState('');
            const [count, setCount] = useState(0);
            const next = () => {
                if(count >= 5) { onFinish(); return; }
                const t = words[Math.floor(Math.random()*words.length)];
                setQ(t); setInp(''); speak(t.fr); setCount(c=>c+1);
            };
            useEffect(next, []);
            const check = () => {
                if(inp.toLowerCase().trim() === DICTIONARY[q.fr].toLowerCase()) { playSound('correct'); next(); }
                else { playSound('wrong'); alert("Falsch! L√∂sung: " + DICTIONARY[q.fr]); }
            };
            if(!q) return null;
            return (
                <div className="w-full max-w-md text-center pop-in p-4">
                    <div className="glass-panel p-8 mb-6">
                        <h2 className="text-3xl font-black text-green-400 mb-2">{q.fr}</h2>
                        <button onClick={()=>speak(q.fr)} className="text-sm bg-green-600 px-3 py-1 rounded-full">üîä H√∂ren</button>
                    </div>
                    <input value={inp} onChange={e=>setInp(e.target.value)} onKeyDown={e=>e.key==='Enter'&&check()} className="w-full p-4 rounded-xl text-center text-xl bg-slate-800 text-white border-2 border-slate-600 mb-4 focus:border-green-500 outline-none" placeholder="Auf Deutsch..." autoFocus />
                    <div className="flex justify-center gap-2 mb-4">
                        {['√§','√∂','√º','√ü'].map(c=><button key={c} onClick={()=>setInp(i=>i+c)} className="bg-slate-700 text-white w-10 h-10 rounded font-bold hover:bg-slate-600">{c}</button>)}
                    </div>
                    <button onClick={check} className="btn-action btn-green w-full p-4">Pr√ºfen</button>
                </div>
            );
        };

        // --- SHOP ---
        const Shop = ({ user, onBuy, onClose, onEquip }) => {
            return (
                <div className="max-w-md mx-auto p-4 min-h-screen pb-20">
                    <div className="flex justify-between items-center mb-6"><button onClick={onClose} className="font-bold text-slate-500">‚óÄ Zur√ºck</button><div className="font-bold text-xl text-yellow-400">{user.coins} üí∞</div></div>
                    <h1 className="text-3xl font-black text-white mb-6 text-center">Avatar Shop</h1>
                    <div className="grid grid-cols-3 gap-4 mb-8">
                        {AVATARS.map(a => {
                            const owned = user.unlocked.includes(a.id);
                            return (
                                <div key={a.id} 
                                    onClick={() => {
                                        if (owned) { onEquip(a.id); playSound('click'); }
                                        else if (user.coins >= a.cost) { onBuy(a.cost); onEquip(a.id); playSound('cash'); safeConfetti(); }
                                        else alert("Zu wenig M√ºnzen!");
                                    }}
                                    className={`glass-panel p-4 flex flex-col items-center cursor-pointer hover:scale-105 transition ${user.avatar===a.id ? 'border-green-500 bg-green-900/20' : 'rarity-'+a.rarity} ${!owned && user.coins < a.cost ? 'opacity-50' : ''}`}>
                                    <div className="text-5xl mb-2">{a.icon}</div>
                                    <div className="font-bold text-sm text-slate-300">{a.name}</div>
                                    {!owned && <div className="bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold mt-2">{a.cost} üí∞</div>}
                                    {owned && <div className="text-green-400 text-xs font-bold mt-2">{user.avatar===a.id ? 'AKTIV' : 'BESITZ'}</div>}
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        // --- MODAL (POPUP) ---
        const Modal = ({ title, children, onClose, type='info' }) => (
            <div className="modal-overlay pop-in fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                <div className={`bg-slate-800 p-6 rounded-3xl border-4 w-full max-w-sm text-center relative shadow-2xl ${type==='win'?'border-yellow-400':type==='error'?'border-red-500':'border-blue-500'}`} onClick={e=>e.stopPropagation()}>
                    <h2 className={`text-2xl font-black mb-4 font-game ${type==='win'?'text-yellow-400':type==='error'?'text-red-400':'text-white'}`}>{title}</h2>
                    <div className="text-slate-300 mb-6">{children}</div>
                    <button onClick={onClose} className={`btn-action w-full py-3 ${type==='win'?'btn-yellow':type==='error'?'btn-red':'btn-blue'}`}>OK</button>
                </div>
            </div>
        );

        // --- APP SHELL ---
        const App = () => {
            const [user, setUser] = useState({ name: 'Agent', coins: 100, xp: 0, level: 1, avatar: 'bear', unlocked: ['bear'], unlockedWorlds: [1] });
            const [view, setView] = useState('map');
            const [activeWorld, setActiveWorld] = useState(null);
            const [gameMode, setGameMode] = useState(null);
            const [modal, setModal] = useState(null);

            useEffect(() => { const s = localStorage.getItem('franz_final_v16'); if(s) setUser(JSON.parse(s)); }, []);
            const save = (u) => { setUser(u); localStorage.setItem('franz_final_v16', JSON.stringify(u)); };

            const addProgress = (xp, coins) => {
                const u = { ...user }; u.xp += xp; u.coins += coins;
                const nextXP = getXPForLevel(u.level + 1);
                if(u.xp >= nextXP) { 
                    u.level++; 
                    setModal({title: "LEVEL UP!", msg: `Du bist jetzt ${RANKS[Math.min(Math.floor((u.level-1)/2), RANKS.length-1)]}!`, type: 'win'});
                    playSound('win'); window.confetti(); 
                } else {
                    setModal({title: "MISSION ERF√úLLT", msg: `+${xp} XP | +${coins} M√ºnzen`, type: 'win'});
                    playSound('win'); window.confetti();
                }
                save(u);
                setView('map');
            };
            
            const getXPForLevel = (l) => 200 * l;
            const getRankTitle = (lvl) => RANKS[Math.min(Math.floor((lvl-1)/2), RANKS.length-1)];

            if (view === 'map') {
                const nextXP = getXPForLevel(user.level + 1);
                const progress = Math.min(100, (user.xp / nextXP) * 100);
                return (
                    <div className="max-w-md mx-auto p-4 min-h-screen flex flex-col">
                        <div className="glass-panel p-4 mb-6 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="text-4xl bg-white/10 p-2 rounded-xl">{AVATARS.find(a=>a.id===user.avatar)?.icon}</div>
                                <div><div className="font-bold text-white">{user.name}</div><div className="text-xs text-blue-400 font-bold uppercase">{getRankTitle(user.level)}</div></div>
                            </div>
                            <button onClick={()=>setView('shop')} className="font-bold text-yellow-400 text-xl hover:scale-110 transition">{user.coins} üí∞</button>
                        </div>
                        <div className="bg-slate-800 rounded-full h-3 overflow-hidden mb-8 border border-slate-700"><div className="bg-blue-500 h-full transition-all" style={{width: `${progress}%`}}></div></div>
                        <div className="space-y-6 pb-20">
                            {WORLDS.map((w,i) => {
                                const locked = user.level < w.reqLvl;
                                return (
                                    <div key={w.id} className="relative">
                                        <div onClick={() => !locked && setActiveWorld(activeWorld===w.id ? null : w)} 
                                             className={`glass-panel p-4 flex items-center gap-4 transition cursor-pointer border-l-4 border-${locked?'slate-500':'blue-500'} ${locked ? 'opacity-50' : 'hover:bg-white/10'}`}>
                                            <div className="text-4xl">{locked ? 'üîí' : w.icon}</div>
                                            <div className="flex-1">
                                                <div className="font-bold text-lg text-white">{w.name}</div>
                                                <div className="text-xs text-slate-400">{locked ? `Ab Lvl ${w.reqLvl}` : `${w.words.length} W√∂rter`}</div>
                                            </div>
                                            <div className="text-white">{activeWorld?.id===w.id ? '‚ñº' : '‚ñ∂'}</div>
                                        </div>

                                        {activeWorld?.id === w.id && !locked && (
                                            <div className="mt-4 grid grid-cols-2 gap-3 pop-in pl-4 border-l-2 border-blue-500">
                                                <button onClick={()=>{setGameMode('match'); setView('game');}} className="btn-action btn-blue py-3 text-sm">üîó Verbinden</button>
                                                <button onClick={()=>{setGameMode('memory'); setView('game');}} className="btn-action btn-green py-3 text-sm">üÉè Memory</button>
                                                <button onClick={()=>{setGameMode('quiz'); setView('game');}} className="btn-action btn-purple py-3 text-sm">‚ùì Quiz</button>
                                                <button onClick={()=>{setGameMode('listen'); setView('game');}} className="btn-action btn-yellow py-3 text-sm text-black">üëÇ H√ñREN</button>
                                                <button onClick={()=>{setGameMode('write'); setView('game');}} className="btn-action btn-red py-3 text-sm col-span-2">‚úçÔ∏è SCHREIBEN</button>
                                            </div>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                        <a href="index.html" className="glass-panel text-center text-slate-400 font-bold text-xs p-3 mt-auto mb-4 block">üè† ZENTRALE</a>
                        
                        {modal && <Modal title={modal.title} type={modal.type} onClose={()=>setModal(null)}>{modal.msg}</Modal>}
                    </div>
                );
            }

            if (view === 'game') {
                return (
                    <div className="min-h-screen p-4 flex flex-col relative">
                        <div className="flex justify-between items-center mb-6 z-20">
                            <button onClick={()=>setView('map')} className="glass-panel w-12 h-12 flex items-center justify-center text-white font-bold text-xl">‚úï</button>
                            <div className="glass-panel px-4 py-1 text-blue-400 font-bold text-sm uppercase">{gameMode}</div>
                        </div>

                        <div className="flex-1 flex flex-col justify-center items-center w-full max-w-2xl mx-auto">
                            {gameMode === 'memory' && <MemoryGame words={activeWorld.words} onFinish={() => addProgress(50, 20)} />}
                            {gameMode === 'match' && <MatchGame words={activeWorld.words} onFinish={() => addProgress(50, 20)} />}
                            {gameMode === 'quiz' && <QuizGame words={activeWorld.words} onFinish={() => addProgress(30, 10)} />}
                            {gameMode === 'listen' && <ListenGame words={activeWorld.words} onFinish={() => addProgress(30, 15)} />}
                            {gameMode === 'write' && <WriteGame words={activeWorld.words} onFinish={() => addProgress(40, 20)} />}
                        </div>
                        {modal && <Modal title={modal.title} type={modal.type} onClose={()=>{setModal(null); setView('map');}}>{modal.msg}</Modal>}
                    </div>
                );
            }
            
            if (view === 'shop') return <Shop user={user} onBuy={(c)=>{save({...user, coins:user.coins-c})}} onClose={()=>setView('menu')} onEquip={(id)=>{if(!user.unlocked.includes(id))save({...user, unlocked:[...user.unlocked, id], avatar:id}); else save({...user, avatar:id});}} />;

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>