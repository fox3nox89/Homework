<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Galaxy ‚Äì 4. Klasse</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Konfetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Gemeinsames CSS, falls vorhanden -->
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #020617 55%, #000 100%);
            color: #e5e7eb;
            overflow-x: hidden;
        }

        .font-game {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-stretch: expanded;
        }

        /* Sterne-Hintergrund */
        .stars {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
        }
        .star-dot {
            position: absolute;
            background: white;
            border-radius: 999px;
            opacity: 0.7;
            animation: twinkle 4s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Glas-Panel */
        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(18px);
        }

        /* Grosse Buttons */
        .big-btn {
            border-radius: 18px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 0.9rem 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 6px 0 rgba(0,0,0,0.4);
            transition: all 0.1s;
            border-bottom-width: 6px;
            font-size: 0.78rem;
        }
        .big-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.4);
            border-bottom-width: 2px;
        }

        .btn-blue   { background: #3b82f6; border-color: #1d4ed8; color: white; }
        .btn-green  { background: #22c55e; border-color: #15803d; color: white; }
        .btn-purple { background: #8b5cf6; border-color: #6d28d9; color: white; }
        .btn-yellow { background: #eab308; border-color: #a16207; color: #111827; }
        .btn-red    { background: #ef4444; border-color: #b91c1c; color: white; }
        .btn-gray   { background: #1f2937; border-color: #111827; color: #e5e7eb; }

        /* Memory-Karten */
        .memory-scene {
            perspective: 1100px;
            height: 110px;
            cursor: pointer;
        }
        .memory-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.35s;
        }
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        .memory-face {
            position: absolute;
            inset: 0;
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            border: 3px solid rgba(148, 163, 184, 0.5);
            backface-visibility: hidden;
            padding: 0.5rem;
        }
        .memory-front {
            background: linear-gradient(135deg, #4f46e5, #a855f7);
            color: white;
            font-size: 2.4rem;
        }
        .memory-back {
            background: #0f172a;
            transform: rotateY(180deg);
            font-size: 1.05rem;
            text-align: center;
        }
        .memory-back.fr {
            border-color: #3b82f6;
            color: #93c5fd;
        }
        .memory-back.de {
            border-color: #f97316;
            color: #fed7aa;
        }

        /* Shop-Karten */
        .shop-card {
            border-radius: 18px;
            padding: 0.9rem;
            border-width: 3px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .shop-card:active {
            transform: translateY(3px) scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        .shop-common {
            border-color: #9ca3af;
            background: #111827;
        }
        .shop-rare {
            border-color: #3b82f6;
            background: radial-gradient(circle at top, #1e3a8a, #020617);
        }
        .shop-epic {
            border-color: #a855f7;
            background: radial-gradient(circle at top, #581c87, #020617);
        }
        .shop-legendary {
            border-color: #eab308;
            background: radial-gradient(circle at top, #facc15, #92400e);
        }
        .owned-badge {
            font-size: 0.65rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(22, 163, 74, 0.2);
            border: 1px solid #22c55e;
            color: #bbf7d0;
        }

        /* Input */
        .input-field {
            background: #020617;
            border-radius: 16px;
            border: 2px solid #1f2937;
            color: #e5e7eb;
            padding: 0.8rem 1rem;
            font-size: 1.1rem;
            outline: none;
            width: 100%;
            text-align: center;
        }
        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }

        /* XP-Bar */
        .xp-track {
            height: 16px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            transition: width 0.4s ease-out;
        }

        /* Kleinzeug */
        .pill {
            border-radius: 999px;
            padding: 0.15rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .mode-tab {
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            font-size: 0.78rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        .mode-tab.active {
            background: #2563eb;
            border-color: #1d4ed8;
            color: white;
        }
        .mode-tab.inactive {
            background: #020617;
            border-color: #1f2937;
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Sterne -->
    <div class="stars" id="stars"></div>

    <!-- Navigation -->
    <nav class="w-full bg-slate-900/90 text-slate-50 border-b border-slate-800">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-7 h-7 rounded-xl bg-indigo-500 text-xs font-bold">
                    L
                </span>
            <div>
                    <div class="text-sm font-semibold">Lern-App Schweiz</div>
                    <div class="text-[11px] text-slate-300">Lehrplan 21 ‚Äì 4. Klasse</div>
                </div>
            </div>
            <div class="flex items-center gap-2 text-xs sm:text-sm">
                <a href="index.html"
                   class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                    Startseite
                </a>
                <a href="franz.html"
                   class="px-3 py-1.5 rounded-xl bg-indigo-500 hover:bg-indigo-400 transition font-semibold">
                    Franz√∂sisch
                </a>
                <a href="math.html"
                   class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                    Mathematik
                </a>
            </div>
        </div>
    </nav>

    <!-- Hauptcontainer -->
    <div class="min-h-[calc(100vh-56px)] flex items-center justify-center py-8 px-4">
        <div class="w-full max-w-5xl glass-panel p-4 sm:p-6 md:p-8">
            <!-- Header / Top-Bar -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div class="flex items-center gap-3">
                    <button
                        id="btnBackHome"
                        class="big-btn btn-gray text-xs px-3 py-2"
                    >
                        ‚¨Ö Zur Startseite
                    </button>
                    <div>
                        <div class="flex items-center gap-2">
                            <span id="avatarEmoji" class="text-2xl">üê±</span>
                            <h1 class="font-game text-2xl sm:text-3xl font-black">
                                Franz√∂sisch-Galaxy
                            </h1>
                        </div>
                        <p class="text-xs text-slate-400">
                            4. Klasse ‚Äì H√∂rverstehen, Vokabeln, Schreiben & Shop
                        </p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-3 text-xs">
                        <div class="flex items-center gap-1 pill bg-slate-900 text-slate-100">
                            <span>Level</span>
                            <span id="levelDisplay" class="font-bold text-emerald-300">1</span>
                        </div>
                        <div class="flex items-center gap-1 pill bg-slate-900 text-amber-300">
                            <span id="coinsDisplay">0</span>
                            <span>ü™ô</span>
                        </div>
                    </div>
                    <div class="w-40">
                        <div class="xp-track">
                            <div id="xpFill" class="xp-fill" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between text-[0.65rem] text-slate-400 mt-1">
                            <span id="relXpLabel">0 XP</span>
                            <span id="nextXpLabel">bis 0 XP</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode Auswahl -->
            <div class="mb-4 flex flex-wrap gap-2 justify-center">
                <button class="mode-tab active" data-mode="menu">Men√º</button>
                <button class="mode-tab inactive" data-mode="memory">Memory</button>
                <button class="mode-tab inactive" data-mode="listen">H√∂r zu</button>
                <button class="mode-tab inactive" data-mode="write">Schreiben</button>
                <button class="mode-tab inactive" data-mode="shop">Shop</button>
                <button id="btnResetAll" class="mode-tab inactive">Alles zur√ºcksetzen</button>
            </div>

            <!-- Panels -->

            <!-- Men√º -->
            <div id="panel-menu" class="mt-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button
                        class="big-btn btn-blue flex-col items-start h-full"
                        data-goto="memory"
                    >
                        <span class="text-xl">üß† Memory</span>
                        <span class="text-xs opacity-90">
                            Finde zusammengeh√∂rende Paare (FR‚ÄìDE).
                        </span>
                    </button>
                    <button
                        class="big-btn btn-green flex-col items-start h-full"
                        data-goto="listen"
                    >
                        <span class="text-xl">üëÇ H√∂r zu</span>
                        <span class="text-xs opacity-90">
                            H√∂re Franz√∂sisch und w√§hle die richtige Bedeutung.
                        </span>
                    </button>
                    <button
                        class="big-btn btn-purple flex-col items-start h-full"
                        data-goto="write"
                    >
                        <span class="text-xl">‚úèÔ∏è Schreiben</span>
                        <span class="text-xs opacity-90">
                            Schreib das deutsche Wort zum franz√∂sischen Wort.
                        </span>
                    </button>
                    <button
                        class="big-btn btn-yellow flex-col items-start h-full"
                        data-goto="shop"
                    >
                        <span class="text-xl">üõí Shop</span>
                        <span class="text-xs opacity-90">
                            Kaufe Avatare mit M√ºnzen aus den √úbungen.
                        </span>
                    </button>
                </div>
            </div>

            <!-- Memory -->
            <div id="panel-memory" class="mt-2 hidden">
                <div class="space-y-4">
                    <h2 class="font-game text-2xl md:text-3xl font-black text-indigo-300 text-center">
                        üß† Memory ‚Äì Paare finden
                    </h2>
                    <p class="text-sm text-slate-300 text-center">
                        Tipp: Klick zuerst auf Franz√∂sisch (üá´üá∑), h√∂re zu, merk dir das Wort ‚Äì dann suche die deutsche Karte (üá©üá™).
                    </p>
                    <div class="grid grid-cols-3 sm:grid-cols-4 gap-3 mt-3" id="memoryGrid">
                        <!-- Karten per JS -->
                    </div>
                    <div class="flex justify-center mt-2">
                        <button
                            id="btnMemoryShuffle"
                            class="big-btn btn-gray text-xs px-4 py-2"
                        >
                            Neu mischen
                        </button>
                    </div>
                </div>
            </div>

            <!-- H√∂r zu -->
            <div id="panel-listen" class="mt-2 hidden">
                <div class="space-y-4">
                    <h2 class="font-game text-2xl md:text-3xl font-black text-sky-300 text-center">
                        üëÇ H√∂r zu & w√§hle die Bedeutung
                    </h2>
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div class="text-sm text-slate-300">
                            <p>H√∂re das franz√∂sische Wort (üá´üá∑) und w√§hle die richtige deutsche Bedeutung.</p>
                            <p class="mt-1 text-xs text-slate-400">
                                Punkte gibt es nur, wenn du beim <strong>ersten Versuch</strong> richtig liegst.
                            </p>
                        </div>
                        <button
                            id="btnListenReplay"
                            class="big-btn btn-blue text-xs"
                        >
                            Nochmal anh√∂ren üîä
                        </button>
                    </div>

                    <div class="glass-panel p-4 flex flex-col items-center gap-2">
                        <span class="uppercase text-xs tracking-[0.2em] text-slate-400">
                            Franz√∂sisches Wort
                        </span>
                        <div class="flex items-center gap-2">
                            <div
                                id="listenWordFr"
                                class="px-4 py-2 rounded-full bg-indigo-600/30 border border-indigo-400/60 text-indigo-100 font-bold text-sm sm:text-base"
                            >
                                ‚Äì
                            </div>
                            <button
                                id="btnListenPlayFr"
                                class="w-9 h-9 rounded-full bg-indigo-700 flex items-center justify-center text-white text-lg"
                            >
                                üîä
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="listenOptions">
                        <!-- Optionen per JS -->
                    </div>

                    <div id="listenFeedback"
                         class="mt-2 text-sm text-center font-semibold text-slate-300 min-h-[1.5rem]">
                    </div>
                </div>
            </div>

            <!-- Schreiben -->
            <div id="panel-write" class="mt-2 hidden">
                <div class="space-y-4">
                    <h2 class="font-game text-2xl md:text-3xl font-black text-rose-300 text-center">
                        ‚úèÔ∏è Schreiben ‚Äì Deutsch zum franz√∂sischen Wort
                    </h2>
                    <p class="text-sm text-slate-300 text-center max-w-xl mx-auto">
                        Du siehst das <span class="font-semibold text-indigo-200">franz√∂sische Wort</span> und schreibst das deutsche Wort.
                        Gross-/Kleinschreibung ist egal, aber versuch sie richtig zu schreiben.
                    </p>

                    <div class="glass-panel p-4 flex flex-col items-center gap-3">
                        <span class="uppercase text-xs tracking-[0.2em] text-slate-400">
                            Franz√∂sisches Wort
                        </span>
                        <div class="flex items-center gap-2 flex-wrap justify-center">
                            <div
                                id="writeWordFr"
                                class="px-4 py-2 rounded-full bg-rose-600/30 border border-rose-400/60 text-rose-100 font-bold text-sm sm:text-base"
                            >
                                ‚Äì
                            </div>
                            <button
                                id="btnWritePlayFr"
                                class="w-9 h-9 rounded-full bg-rose-700 flex items-center justify-center text-white text-lg"
                            >
                                üîä
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <input
                            id="writeInput"
                            class="input-field"
                            placeholder="Schreibe hier das deutsche Wort..."
                        />
                        <div class="flex flex-wrap gap-3 justify-center">
                            <button
                                id="btnWriteCheck"
                                class="big-btn btn-purple text-xs px-6"
                            >
                                Pr√ºfen
                            </button>
                            <button
                                id="btnWriteShowSolution"
                                class="big-btn btn-gray text-[0.68rem] px-4"
                            >
                                L√∂sung anzeigen (nur zur Kontrolle)
                            </button>
                        </div>
                    </div>

                    <div
                        id="writeFeedback"
                        class="mt-1 text-sm text-center font-semibold text-slate-300 min-h-[1.5rem]">
                    </div>
                </div>
            </div>

            <!-- Shop -->
            <div id="panel-shop" class="mt-2 hidden">
                <div class="space-y-4">
                    <h2 class="font-game text-2xl md:text-3xl font-black text-amber-300 text-center">
                        üõí Tier-Shop & Avatar
                    </h2>
                    <p class="text-sm text-slate-300 text-center max-w-xl mx-auto">
                        Gib deine M√ºnzen f√ºr Avatare aus. Legend√§re Tiere sind teuer und damit
                        etwas Besonderes. Kinder k√∂nnen den aktiven Avatar selbst ausw√§hlen.
                    </p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-3" id="shopGrid">
                        <!-- Shopkarten per JS -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-6 text-[0.7rem] text-slate-500 text-center">
                Tipp f√ºr dich: Wenn du sp√§ter neue W√∂rter in deinen JSON-Dateien eintr√§gst,
                erscheinen sie automatisch in allen Modi (Memory, H√∂r zu, Schreiben).
            </div>

            <!-- Fehleranzeige f√ºr W√∂rter -->
            <div id="wordsError" class="mt-2 text-center text-xs text-rose-300 hidden">
                Keine W√∂rter geladen. Pr√ºfe, ob deine JSON-Dateien existieren und g√ºltiges JSON enthalten.
            </div>
        </div>
    </div>

    <script>
        // ---------- Hilfsfunktionen ----------

        function createStars() {
            const container = document.getElementById('stars');
            if (!container) return;
            for (let i = 0; i < 70; i++) {
                const d = document.createElement('div');
                d.className = 'star-dot';
                const size = Math.random() * 3 + 1;
                d.style.width = size + 'px';
                d.style.height = size + 'px';
                d.style.top = Math.random() * 100 + '%';
                d.style.left = Math.random() * 100 + '%';
                d.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(d);
            }
        }

        function speak(text, lang) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang || 'fr-FR';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        function playBeep(type) {
            const AC = window.AudioContext || window.webkitAudioContext;
            if (!AC) return;
            const ctx = new AC();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g);
            g.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'good') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1100, now + 0.2);
                g.gain.setValueAtTime(0.15, now);
                g.gain.linearRampToValueAtTime(0.0, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'bad') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                g.gain.setValueAtTime(0.18, now);
                g.gain.linearRampToValueAtTime(0.0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.35);
            }
        }

        function fireConfetti() {
            if (!window.confetti) return;
            window.confetti({
                particleCount: 80,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        const levelThresholds = [0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200];

        function getLevelFromXP(xp) {
            let lvl = 1;
            for (let i = 0; i < levelThresholds.length; i++) {
                if (xp >= levelThresholds[i]) lvl = i + 1;
            }
            return lvl;
        }

        function getNextLevelXP(lvl) {
            if (lvl - 1 < levelThresholds.length) return levelThresholds[lvl - 1];
            return levelThresholds[levelThresholds.length - 1];
        }

        function stripArticle(s) {
            if (!s) return '';
            const lower = s.toLowerCase().trim();
            const articles = ["der", "die", "das", "ein", "eine", "le", "la", "les", "un", "une", "des", "l'"];
            const parts = lower.split(/\s+/);
            if (articles.includes(parts[0])) {
                return parts.slice(1).join(' ');
            }
            return lower;
        }

        function randInt(min, maxInclusive) {
            return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const tmp = array[i];
                array[i] = array[j];
                array[j] = tmp;
            }
            return array;
        }

        // ---------- Globaler State ----------

        const state = {
            mode: 'menu',
            xp: 0,
            coins: 0,
            ownedAvatars: ['cat'],
            activeAvatar: 'cat',
            words: [],
            memory: {
                deck: [],
                flipped: [],
                matched: []
            },
            listen: {
                current: null,
                options: [],
                attempts: 0
            },
            write: {
                current: null,
                attempts: 0
            }
        };

        const avatarMap = {
            cat: 'üê±',
            turtle: 'üê¢',
            panda: 'üêº',
            owl: 'ü¶â',
            dragon: 'üê≤',
            alien: 'üëΩ',
            fox: 'ü¶ä',
            bear: 'üêª'
        };

        // Shop-Items (hart im Code, shop.json wird nicht benutzt)
        const shopItems = [
            { id: 'cat',    name: 'Katze',       emoji: 'üê±', cost: 20,  rarity: 'common' },
            { id: 'turtle', name: 'Schildkr√∂te', emoji: 'üê¢', cost: 25,  rarity: 'common' },
            { id: 'panda',  name: 'Panda',       emoji: 'üêº', cost: 40,  rarity: 'rare'   },
            { id: 'owl',    name: 'Eule',        emoji: 'ü¶â', cost: 50,  rarity: 'rare'   },
            { id: 'dragon', name: 'Drache',      emoji: 'üê≤', cost: 80,  rarity: 'epic'   },
            { id: 'alien',  name: 'Alien',       emoji: 'üëΩ', cost: 120, rarity: 'epic'   },
            { id: 'fox',    name: 'Fuchs',       emoji: 'ü¶ä', cost: 160, rarity: 'legendary' },
            { id: 'bear',   name: 'B√§r',         emoji: 'üêª', cost: 200, rarity: 'legendary' }
        ];

        function rarityClass(r) {
            if (r === 'rare') return 'shop-rare';
            if (r === 'epic') return 'shop-epic';
            if (r === 'legendary') return 'shop-legendary';
            return 'shop-common';
        }

        function rarityLabel(r) {
            if (r === 'rare') return 'Selten';
            if (r === 'epic') return 'Episch';
            if (r === 'legendary') return 'Legend√§r';
            return 'Normal';
        }

        // ---------- UI Updates ----------

        function applyProgressUI() {
            const level = getLevelFromXP(state.xp);
            const nextXP = getNextLevelXP(level);
            const prevXP = level > 1 ? getNextLevelXP(level - 1) : 0;
            const relXP = Math.max(state.xp - prevXP, 0);
            const spanXP = Math.max(nextXP - prevXP, 1);
            const xpPercent = Math.min(100, (relXP / spanXP) * 100);

            const levelDisplay = document.getElementById('levelDisplay');
            const coinsDisplay = document.getElementById('coinsDisplay');
            const xpFill = document.getElementById('xpFill');
            const relXpLabel = document.getElementById('relXpLabel');
            const nextXpLabel = document.getElementById('nextXpLabel');
            const avatarEmojiEl = document.getElementById('avatarEmoji');

            if (levelDisplay) levelDisplay.textContent = level;
            if (coinsDisplay) coinsDisplay.textContent = state.coins;
            if (xpFill) xpFill.style.width = xpPercent + '%';
            if (relXpLabel) relXpLabel.textContent = relXP + ' XP';
            if (nextXpLabel) nextXpLabel.textContent = 'bis ' + nextXP + ' XP';
            if (avatarEmojiEl) avatarEmojiEl.textContent = avatarMap[state.activeAvatar] || 'üê±';
        }

        function setMode(newMode) {
            state.mode = newMode;
            const panels = ['menu', 'memory', 'listen', 'write', 'shop'];
            panels.forEach(m => {
                const panel = document.getElementById('panel-' + m);
                if (!panel) return;
                if (m === newMode) panel.classList.remove('hidden');
                else panel.classList.add('hidden');
            });

            const tabEls = document.querySelectorAll('.mode-tab');
            tabEls.forEach(btn => {
                const dataMode = btn.getAttribute('data-mode');
                if (!dataMode) return;
                if (dataMode === newMode) {
                    btn.classList.add('active');
                    btn.classList.remove('inactive');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                }
            });

            if (newMode === 'memory') {
                buildMemoryDeck();
            } else if (newMode === 'listen') {
                buildListenQuestion();
            } else if (newMode === 'write') {
                buildWriteQuestion();
            } else if (newMode === 'shop') {
                renderShop();
            }
        }

        function addReward(xpGain, coinGain) {
            if (xpGain > 0) {
                const oldLvl = getLevelFromXP(state.xp);
                state.xp += xpGain;
                const newLvl = getLevelFromXP(state.xp);
                if (newLvl > oldLvl) fireConfetti();
            }
            if (coinGain > 0) {
                state.coins += coinGain;
            }
            applyProgressUI();
            persistProgress();
        }

        function persistProgress() {
            const obj = {
                xp: state.xp,
                coins: state.coins,
                ownedAvatars: state.ownedAvatars,
                activeAvatar: state.activeAvatar
            };
            try {
                localStorage.setItem('franzProgressV1', JSON.stringify(obj));
            } catch (e) {}
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('franzProgressV1');
                if (!saved) return;
                const obj = JSON.parse(saved);
                if (typeof obj.xp === 'number') state.xp = obj.xp;
                if (typeof obj.coins === 'number') state.coins = obj.coins;
                if (Array.isArray(obj.ownedAvatars) && obj.ownedAvatars.length > 0) {
                    state.ownedAvatars = obj.ownedAvatars;
                }
                if (obj.activeAvatar && avatarMap[obj.activeAvatar]) {
                    state.activeAvatar = obj.activeAvatar;
                }
            } catch (e) {}
        }

        function resetAll() {
            if (!window.confirm('Wirklich alles zur√ºcksetzen? Level, M√ºnzen, Shop?')) return;
            state.xp = 0;
            state.coins = 0;
            state.ownedAvatars = ['cat'];
            state.activeAvatar = 'cat';
            try {
                localStorage.removeItem('franzProgressV1');
            } catch (e) {}
            applyProgressUI();
        }

        // ---------- Memory ----------

        function buildMemoryDeck() {
            const grid = document.getElementById('memoryGrid');
            if (!grid) return;
            grid.innerHTML = '';

            if (!state.words || state.words.length < 4) {
                grid.innerHTML = '<p class="col-span-full text-center text-sm text-slate-300">Zu wenige W√∂rter geladen.</p>';
                return;
            }

            const pool = shuffle(state.words.slice()).slice(0, 6);
            const deck = [];

            pool.forEach((w, idx) => {
                deck.push({
                    id: 'fr-' + idx,
                    key: w.fr,
                    label: w.fr,
                    lang: 'fr'
                });
                deck.push({
                    id: 'de-' + idx,
                    key: w.fr,
                    label: w.de,
                    lang: 'de'
                });
            });

            state.memory.deck = shuffle(deck);
            state.memory.flipped = [];
            state.memory.matched = [];

            state.memory.deck.forEach(card => {
                const scene = document.createElement('div');
                scene.className = 'memory-scene';

                const wrapper = document.createElement('div');
                wrapper.className = 'memory-card';
                wrapper.dataset.cardId = card.id;

                const front = document.createElement('div');
                front.className = 'memory-face memory-front';
                front.textContent = '?';

                const back = document.createElement('div');
                back.className = 'memory-face memory-back ' + (card.lang === 'fr' ? 'fr' : 'de');

                const langSpan = document.createElement('span');
                langSpan.className = 'text-xs opacity-70 mb-1 block';
                langSpan.textContent = card.lang === 'fr' ? 'FR' : 'DE';

                const labelSpan = document.createElement('span');
                labelSpan.className = 'text-base sm:text-lg leading-tight';
                labelSpan.textContent = card.label;

                back.appendChild(langSpan);
                back.appendChild(labelSpan);

                wrapper.appendChild(front);
                wrapper.appendChild(back);
                scene.appendChild(wrapper);
                grid.appendChild(scene);

                scene.addEventListener('click', function () {
                    handleMemoryClick(card.id);
                });
            });
        }

        function handleMemoryClick(cardId) {
            const deck = state.memory.deck;
            const flipped = state.memory.flipped;
            const matched = state.memory.matched;

            if (matched.includes(cardId)) return;
            if (flipped.includes(cardId)) return;
            if (flipped.length === 2) return;

            state.memory.flipped.push(cardId);
            updateMemoryFlips();

            const card = deck.find(c => c.id === cardId);
            if (card) {
                speak(card.label, card.lang === 'fr' ? 'fr-FR' : 'de-DE');
            }

            if (state.memory.flipped.length === 2) {
                const [aId, bId] = state.memory.flipped;
                const a = deck.find(c => c.id === aId);
                const b = deck.find(c => c.id === bId);
                if (!a || !b) return;

                if (a.key === b.key && a.lang !== b.lang) {
                    setTimeout(function () {
                        state.memory.matched.push(aId, bId);
                        state.memory.flipped = [];
                        updateMemoryFlips();
                        playBeep('good');
                        addReward(10, 5);
                        if (state.memory.matched.length === deck.length) {
                            fireConfetti();
                            setTimeout(buildMemoryDeck, 800);
                        }
                    }, 500);
                } else {
                    setTimeout(function () {
                        playBeep('bad');
                        state.memory.flipped = [];
                        updateMemoryFlips();
                    }, 800);
                }
            }
        }

        function updateMemoryFlips() {
            const cards = document.querySelectorAll('.memory-card');
            cards.forEach(cardEl => {
                const id = cardEl.dataset.cardId;
                const isFlipped = state.memory.flipped.includes(id) || state.memory.matched.includes(id);
                if (isFlipped) cardEl.classList.add('flipped');
                else cardEl.classList.remove('flipped');
            });
        }

        // ---------- H√∂r zu ----------

        function buildListenQuestion() {
            const feedback = document.getElementById('listenFeedback');
            if (feedback) feedback.textContent = '';

            if (!state.words || state.words.length < 4) {
                const optionsContainer = document.getElementById('listenOptions');
                if (optionsContainer) {
                    optionsContainer.innerHTML = '<p class="col-span-full text-center text-sm text-slate-300">Zu wenige W√∂rter geladen.</p>';
                }
                return;
            }

            const all = state.words.slice();
            const correct = all[Math.floor(Math.random() * all.length)];
            const others = shuffle(all.filter(w => w !== correct)).slice(0, 3);
            const opts = shuffle(others.concat([correct]));

            state.listen.current = correct;
            state.listen.options = opts;
            state.listen.attempts = 0;

            const frLabel = document.getElementById('listenWordFr');
            if (frLabel) frLabel.textContent = correct.fr;

            const optionsContainer = document.getElementById('listenOptions');
            if (!optionsContainer) return;
            optionsContainer.innerHTML = '';

            opts.forEach((w, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left shop-card shop-common flex items-center justify-between';
                btn.innerHTML =
                    '<div class="text-sm sm:text-base font-semibold">' +
                    w.de +
                    '</div>' +
                    '<button type="button" class="ml-3 w-9 h-9 rounded-full bg-slate-800 flex items-center justify-center text-xs">üîä</button>';

                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    handleListenChoose(w);
                });

                const innerBtn = btn.querySelector('button');
                innerBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    speak(w.de, 'de-DE');
                });

                optionsContainer.appendChild(btn);
            });

            speak(correct.fr, 'fr-FR');
        }

        function handleListenChoose(opt) {
            const feedback = document.getElementById('listenFeedback');
            if (!state.listen.current || !feedback) return;

            state.listen.attempts += 1;

            const correct = state.listen.current;
            if (opt.de === correct.de) {
                playBeep('good');
                if (state.listen.attempts === 1) {
                    addReward(8, 4);
                    feedback.className = 'mt-2 text-sm text-center font-semibold text-emerald-300';
                    feedback.textContent = 'Richtig! Volle Punkte. üëå';
                } else {
                    feedback.className = 'mt-2 text-sm text-center font-semibold text-emerald-300';
                    feedback.textContent = 'Richtig ‚Äì aber ohne Punkte, weil du geraten hast.';
                }
                setTimeout(buildListenQuestion, 900);
            } else {
                playBeep('bad');
                feedback.className = 'mt-2 text-sm text-center font-semibold text-rose-300';
                feedback.textContent = 'Falsch. H√∂r nochmals gut hin und versuch es erneut.';
            }
        }

        // ---------- Schreiben ----------

        function buildWriteQuestion() {
            const feedback = document.getElementById('writeFeedback');
            if (feedback) feedback.textContent = '';

            if (!state.words || state.words.length === 0) {
                const wordEl = document.getElementById('writeWordFr');
                if (wordEl) wordEl.textContent = '‚Äì';
                return;
            }

            const w = state.words[Math.floor(Math.random() * state.words.length)];
            state.write.current = w;
            state.write.attempts = 0;

            const wordEl = document.getElementById('writeWordFr');
            const input = document.getElementById('writeInput');
            if (wordEl) wordEl.textContent = w.fr;
            if (input) input.value = '';
        }

        function handleWriteCheck() {
            const feedback = document.getElementById('writeFeedback');
            const input = document.getElementById('writeInput');
            if (!state.write.current || !feedback || !input) return;

            const user = input.value.trim();
            if (!user) return;

            const correct = state.write.current.de;
            const normUser = user.toLowerCase();
            const normCorrect = correct.toLowerCase();
            const strippedUser = stripArticle(user);
            const strippedCorrect = stripArticle(correct);
            const sameMainWord = strippedUser === strippedCorrect;

            let ok = false;
            let msg = '';

            if (normUser === normCorrect) {
                ok = true;
                msg = 'Perfekt geschrieben! ‚úÖ';
            } else if (sameMainWord) {
                ok = true;
                msg = 'Hauptwort richtig, Artikel nicht ganz. Z√§hlt als richtig ‚Äì achte auf der/die/das.';
            } else {
                ok = false;
                msg = 'Nicht ganz. Pr√ºfe nochmal Rechtschreibung und Bedeutung.';
            }

            state.write.attempts += 1;

            if (ok) {
                playBeep('good');
                if (state.write.attempts === 1) {
                    addReward(10, 5);
                    msg += ' (Volle Punkte, 1. Versuch üëè)';
                } else {
                    msg += ' (Richtig, aber ohne Punkte ‚Äì du hast probiert.)';
                }
                feedback.className = 'mt-1 text-sm text-center font-semibold text-emerald-300';
                feedback.textContent = msg;
                setTimeout(buildWriteQuestion, 1200);
            } else {
                playBeep('bad');
                feedback.className = 'mt-1 text-sm text-center font-semibold text-amber-200';
                feedback.textContent = msg;
            }
        }

        function handleWriteShowSolution() {
            const feedback = document.getElementById('writeFeedback');
            if (!state.write.current || !feedback) return;
            feedback.className = 'mt-1 text-sm text-center font-semibold text-slate-200';
            feedback.textContent = 'L√∂sung: "' + state.write.current.de + '". Versuche beim n√§chsten Mal wieder ohne Hilfe.';
        }

        // ---------- Shop ----------

        function renderShop() {
            const grid = document.getElementById('shopGrid');
            if (!grid) return;
            grid.innerHTML = '';

            shopItems.forEach(it => {
                const isOwned = state.ownedAvatars.includes(it.id);
                const isActive = state.activeAvatar === it.id;

                const card = document.createElement('div');
                card.className = 'shop-card flex flex-col items-center text-center ' + rarityClass(it.rarity);

                card.innerHTML =
                    '<div class="flex items-center gap-2 mb-1">' +
                    '<span class="text-3xl">' + it.emoji + '</span>' +
                    (isActive ? '<span class="pill bg-emerald-500 text-xs text-slate-900">Aktiv</span>' : '') +
                    '</div>' +
                    '<div class="font-bold text-sm">' + it.name + '</div>' +
                    '<div class="text-[0.7rem] text-slate-200 mt-1">' + rarityLabel(it.rarity) + '</div>' +
                    '<div class="mt-2 flex items-center gap-1 text-xs">' +
                    '<span class="text-amber-300 font-semibold">' + it.cost + '</span>' +
                    '<span>ü™ô</span>' +
                    '</div>' +
                    '<div class="mt-1">' +
                    (isOwned ? '<span class="owned-badge">Gekauft</span>' : '') +
                    '</div>' +
                    '<div class="mt-2 text-[0.68rem] text-slate-300">' +
                    'Klick zum ' + (isOwned ? 'Ausw√§hlen' : 'Kaufen') + '.' +
                    '</div>';

                card.addEventListener('click', function () {
                    if (isOwned) {
                        state.activeAvatar = it.id;
                        playBeep('good');
                        applyProgressUI();
                        renderShop();
                        persistProgress();
                    } else {
                        if (state.coins < it.cost) {
                            alert('Zu wenig M√ºnzen f√ºr dieses Tier.');
                            return;
                        }
                        if (!window.confirm('"' + it.name + '" f√ºr ' + it.cost + ' M√ºnzen kaufen?')) return;
                        state.coins -= it.cost;
                        state.ownedAvatars.push(it.id);
                        state.activeAvatar = it.id;
                        playBeep('good');
                        applyProgressUI();
                        renderShop();
                        persistProgress();
                    }
                });

                grid.appendChild(card);
            });
        }

        // ---------- W√∂rter aus mehreren Dateien laden ----------

        function loadAllWordFiles() {
            const files = [
                'data/franzwords.json',
                'data/franzverbs.json',
                'data/franzvocab.json',
                'data/franzplaces.json',
                'data/franz_words.json' // optional Sammel-Datei
            ];

            const requests = files.map(function (path) {
                return fetch(path)
                    .then(function (res) {
                        if (!res.ok) return null; // Datei existiert evtl. nicht -> ignorieren
                        return res.json();
                    })
                    .catch(function () {
                        return null;
                    });
            });

            Promise.all(requests)
                .then(function (results) {
                    const all = [];

                    results.forEach(function (data) {
                        if (Array.isArray(data)) {
                            data.forEach(function (entry) {
                                if (entry && entry.fr && entry.de) {
                                    all.push({
                                        fr: entry.fr,
                                        de: entry.de
                                    });
                                }
                            });
                        }
                    });

                    if (all.length === 0) {
                        const errEl = document.getElementById('wordsError');
                        if (errEl) errEl.classList.remove('hidden');
                        console.error('Keine g√ºltigen W√∂rter aus den JSON-Dateien geladen.');
                        return;
                    }

                    state.words = all;
                    const errEl = document.getElementById('wordsError');
                    if (errEl) errEl.classList.add('hidden');

                    // Start im Men√º, alles bereit
                    setMode('menu');
                })
                .catch(function (err) {
                    console.error(err);
                    const errEl = document.getElementById('wordsError');
                    if (errEl) errEl.classList.remove('hidden');
                });
        }

        // ---------- Init ----------

        document.addEventListener('DOMContentLoaded', function () {
            createStars();
            loadProgress();
            applyProgressUI();

            const btnBackHome = document.getElementById('btnBackHome');
            if (btnBackHome) {
                btnBackHome.addEventListener('click', function () {
                    window.location.href = 'index.html';
                });
            }

            const modeButtons = document.querySelectorAll('.mode-tab');
            modeButtons.forEach(btn => {
                const m = btn.getAttribute('data-mode');
                if (!m) return;
                btn.addEventListener('click', function () {
                    setMode(m);
                });
            });

            const gotoButtons = document.querySelectorAll('[data-goto]');
            gotoButtons.forEach(btn => {
                const target = btn.getAttribute('data-goto');
                btn.addEventListener('click', function () {
                    setMode(target);
                });
            });

            const btnResetAll = document.getElementById('btnResetAll');
            if (btnResetAll) {
                btnResetAll.addEventListener('click', resetAll);
            }

            const btnMemoryShuffle = document.getElementById('btnMemoryShuffle');
            if (btnMemoryShuffle) {
                btnMemoryShuffle.addEventListener('click', buildMemoryDeck);
            }

            const btnListenReplay = document.getElementById('btnListenReplay');
            if (btnListenReplay) {
                btnListenReplay.addEventListener('click', function () {
                    if (state.listen.current) speak(state.listen.current.fr, 'fr-FR');
                });
            }
            const btnListenPlayFr = document.getElementById('btnListenPlayFr');
            if (btnListenPlayFr) {
                btnListenPlayFr.addEventListener('click', function () {
                    if (state.listen.current) speak(state.listen.current.fr, 'fr-FR');
                });
            }

            const btnWritePlayFr = document.getElementById('btnWritePlayFr');
            if (btnWritePlayFr) {
                btnWritePlayFr.addEventListener('click', function () {
                    if (state.write.current) speak(state.write.current.fr, 'fr-FR');
                });
            }
            const btnWriteCheck = document.getElementById('btnWriteCheck');
            if (btnWriteCheck) {
                btnWriteCheck.addEventListener('click', handleWriteCheck);
            }
            const btnWriteShowSolution = document.getElementById('btnWriteShowSolution');
            if (btnWriteShowSolution) {
                btnWriteShowSolution.addEventListener('click', handleWriteShowSolution);
            }
            const writeInput = document.getElementById('writeInput');
            if (writeInput) {
                writeInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') handleWriteCheck();
                });
            }

            // Hier ALLE Word-Dateien laden
            loadAllWordFiles();
        });
    </script>
</body>
</html>
