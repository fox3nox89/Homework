<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Franz√∂sisch Galaxy ‚Äì 4. Klasse</title>

    <!-- ENGINE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg-dark: #020617;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-dark);
            color: #e5e7eb;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .font-game { font-family: 'Baloo 2', cursive; }

        /* Hintergrund Sterne */
        .stars {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at bottom, #1e293b 0%, #020617 60%, #000 100%);
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 999px;
            opacity: 0.5;
            animation: twinkle 4s infinite;
        }

        @keyframes twinkle {
            0%,100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 12px 40px rgba(15, 23, 42, 0.8);
        }

        .btn-main {
            border-radius: 16px;
            padding: 0.75rem 1.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-bottom-width: 6px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.35);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .btn-main:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.35);
            border-bottom-width: 2px;
        }

        .btn-blue   { background: #3b82f6; border-color:#1d4ed8; color:white; }
        .btn-green  { background: #22c55e; border-color:#15803d; color:white; }
        .btn-purple { background: #8b5cf6; border-color:#6d28d9; color:white; }
        .btn-red    { background: #ef4444; border-color:#b91c1c; color:white; }
        .btn-yellow { background: #facc15; border-color:#ca8a04; color:#1f2937; }

        .mode-card {
            border-radius: 24px;
            padding: 1.6rem;
            cursor: pointer;
            transition: transform 0.18s, box-shadow 0.18s;
            box-shadow: 0 10px 25px rgba(15,23,42,0.9);
            border: 1px solid rgba(148,163,184,0.4);
            background: radial-gradient(circle at top, rgba(148,163,184,0.25), rgba(15,23,42,0.95));
        }

        .mode-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 16px 35px rgba(15,23,42,1);
        }

        .xp-track {
            height: 14px;
            border-radius: 999px;
            background: rgba(15,23,42,0.9);
            overflow: hidden;
            border: 1px solid rgba(148,163,184,0.5);
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg,#22c55e,#4ade80,#22c55e);
            transition: width 0.6s ease-out;
        }

        /* Memory Karten */
        .scene {
            perspective: 1000px;
            height: 130px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s;
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.matched {
            animation: popOut 0.4s forwards;
        }

        .face {
            position: absolute;
            inset: 0;
            border-radius: 18px;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            text-align: center;
            box-shadow: 0 6px 16px rgba(15,23,42,0.8);
            border: 2px solid rgba(148,163,184,0.4);
        }

        .front {
            background: linear-gradient(135deg,#6366f1,#a855f7);
            color: white;
            font-size: 2.5rem;
        }

        .back {
            background: #020617;
            transform: rotateY(180deg);
            font-weight: 800;
            font-size: 1.2rem;
        }

        .type-fr .back { color:#60a5fa; border-color:#3b82f6; }
        .type-de .back { color:#fb923c; border-color:#f97316; }

        @keyframes popOut {
            0% { transform: scale(1); opacity:1; }
            50% { transform: scale(1.2); opacity:1; }
            100% { transform: scale(0); opacity:0; }
        }

        /* Antwort-Karten */
        .answer-btn {
            border-radius: 16px;
            padding: 0.75rem 1rem;
            font-weight: 800;
            text-align: center;
            cursor: pointer;
            border: 2px solid #334155;
            background: #020617;
            box-shadow: 0 4px 0 #020617;
            transition: transform 0.08s, box-shadow 0.08s, border-color 0.08s, background 0.08s;
        }

        .answer-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #020617;
        }

        .answer-selected {
            border-color:#38bdf8;
            background:#0f172a;
        }

        .answer-correct   { border-color:#22c55e; }
        .answer-wrong     { border-color:#ef4444; }

        /* Shop Karten */
        .shop-card {
            border-radius: 18px;
            padding: 0.9rem;
            cursor: pointer;
            border-width: 2px;
            border-style: solid;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 6px 18px rgba(15,23,42,0.9);
            transition: transform 0.13s, box-shadow 0.13s;
            background: #020617;
        }

        .shop-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 26px rgba(15,23,42,1);
        }

        .rarity-common     { border-color:#94a3b8; }
        .rarity-rare       { border-color:#3b82f6; box-shadow:0 0 12px rgba(59,130,246,0.55); }
        .rarity-epic       { border-color:#a855f7; box-shadow:0 0 16px rgba(168,85,247,0.7); }
        .rarity-legendary  { border-color:#facc15; box-shadow:0 0 22px rgba(250,204,21,0.8); }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%,90%{transform:translate3d(-1px,0,0);}
            20%,80%{transform:translate3d(2px,0,0);}
            30%,50%,70%{transform:translate3d(-4px,0,0);}
            40%,60%{transform:translate3d(4px,0,0);}
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            backdrop-filter: blur(6px);
        }

        /* Input */
        .input-de {
            width: 100%;
            border-radius: 16px;
            padding: 0.9rem 1rem;
            font-size: 1.1rem;
            background:#020617;
            border:2px solid #334155;
            outline:none;
        }

        .input-de:focus {
            border-color:#6366f1;
            box-shadow:0 0 0 3px rgba(99,102,241,0.4);
        }
    </style>
</head>
<body class="min-h-screen pb-10">
<div class="stars" id="stars"></div>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* Sterne im Hintergrund */
const starRoot = document.getElementById('stars');
for (let i = 0; i < 60; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 2 + 1;
    s.style.width = size + 'px';
    s.style.height = size + 'px';
    s.style.top = Math.random() * 100 + '%';
    s.style.left = Math.random() * 100 + '%';
    s.style.animationDelay = (Math.random() * 4) + 's';
    starRoot.appendChild(s);
}

/* Hilfsfunktionen */
const XP_LEVELS = [0, 200, 500, 900, 1500, 2300, 3300, 4500, 6000, 8000, 11000];

const WORDS = [
    // Pronomen / Basis
    { fr:"Je", de:"Ich" }, { fr:"Tu", de:"Du" }, { fr:"Il", de:"Er" }, { fr:"Elle", de:"Sie" },
    { fr:"Nous", de:"Wir" }, { fr:"Vous", de:"Ihr / Sie" }, { fr:"Ils", de:"Sie (m)" }, { fr:"Elles", de:"Sie (w)" },
    // Aller & Transport
    { fr:"Aller", de:"Gehen" }, { fr:"Je vais", de:"Ich gehe" }, { fr:"Tu vas", de:"Du gehst" },
    { fr:"Il va", de:"Er geht" }, { fr:"Nous allons", de:"Wir gehen" }, { fr:"Vous allez", de:"Ihr geht" },
    { fr:"Ils vont", de:"Sie gehen" }, { fr:"√Ä pied", de:"Zu Fuss" },
    { fr:"Le train", de:"Der Zug" }, { fr:"La voiture", de:"Das Auto" },
    { fr:"Le parcours", de:"Die Strecke / Der Rundweg" },
    // Geld / Zahlen ‚Äì nur ein Teil, reicht f√ºrs Spiel
    { fr:"Dix-huit", de:"Achtzehn" }, { fr:"Onze", de:"Elf" }, { fr:"Vingt", de:"Zwanzig" },
    { fr:"Dix-sept", de:"Siebzehn" }, { fr:"Treize", de:"Dreizehn" }, { fr:"Cinq", de:"F√ºnf" },
    { fr:"Seize", de:"Sechzehn" },
    // Tiere + Story-W√∂rter
    { fr:"La souris", de:"Die Maus" }, { fr:"Le lapin", de:"Der Hase" }, { fr:"La tortue", de:"Die Schildkr√∂te" },
    { fr:"L'√©cureuil", de:"Das Eichh√∂rnchen" }, { fr:"Le secret", de:"Das Geheimnis" },
    { fr:"La pomme", de:"Der Apfel" },
    { fr:"Organiser", de:"Organisieren" }, { fr:"Raconter", de:"Erz√§hlen" },
    { fr:"Inviter", de:"Einladen" }, { fr:"Pour", de:"F√ºr" },
    // Strukturw√∂rter
    { fr:"D'abord", de:"Zuerst" }, { fr:"Puis", de:"Dann" },
    { fr:"Apr√®s", de:"Danach" }, { fr:"Finalement", de:"Schliesslich" },
];

const speakFR = (text) => {
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    u.rate = 0.9;
    window.speechSynthesis.speak(u);
};

const safeConfetti = () => {
    if (window.confetti) {
        window.confetti({ particleCount: 120, spread: 70, origin: { y: 0.7 } });
    }
};

const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

const shuffle = (arr) => {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
};

/* Normalisierung f√ºr deutsche Antworten */
const articleSet = new Set([
    "der","die","das","ein","eine","einen","dem","den","le","la","les","un","une","des","l'"
]);

const normalize = (str) =>
    str.toLowerCase().trim()
        .replace(/\s+/g," ")
        .replace(/[.!?;,]/g,"");

const stripArticle = (str) => {
    const parts = str.split(" ");
    if (parts.length === 0) return "";
    if (articleSet.has(parts[0])) {
        parts.shift();
    }
    return parts.join(" ");
};

const compareGerman = (correctRaw, userRaw) => {
    const cNorm = normalize(correctRaw);
    const uNorm = normalize(userRaw);

    if (!uNorm) return {status:"empty"};

    if (uNorm === cNorm) {
        return {status:"full", note:null};
    }

    const cNoArt = stripArticle(cNorm);
    const uNoArt = stripArticle(uNorm);

    if (uNoArt && uNoArt === cNoArt) {
        return {
            status:"partial",
            note:"Die Bedeutung stimmt, aber der Artikel war nicht korrekt."
        };
    }

    return {status:"wrong"};
};

/* Shop Items */
const SHOP_ITEMS = [
    // Common
    { id:"cat",   name:"Katze",  emoji:"üê±", price:80,  rarity:"common",    type:"avatar", desc:"Schnurrende Lern-Partnerin." },
    { id:"dog",   name:"Hund",   emoji:"üê∂", price:80,  rarity:"common",    type:"avatar", desc:"Treuer Lern-Buddy." },
    { id:"owl",   name:"Eule",   emoji:"ü¶â", price:110, rarity:"rare",      type:"avatar", desc:"Bringt Nachhilfe in der Nacht." },
    { id:"panda", name:"Panda",  emoji:"üêº", price:130, rarity:"rare",      type:"avatar", desc:"Entspannt, aber schlau." },
    { id:"lion",  name:"L√∂we",   emoji:"ü¶Å", price:160, rarity:"rare",      type:"avatar", desc:"Br√ºllt, wenn du Fehler machst." },
    { id:"unicorn", name:"Einhorn", emoji:"ü¶Ñ", price:260, rarity:"epic",  type:"avatar", desc:"Magische XP-Funken." },
    { id:"dragon", name:"Drache", emoji:"üê≤", price:320, rarity:"epic",    type:"avatar", desc:"Bewacht deine Highscores." },

    // Lern-Booster
    { id:"double_xp_5", name:"Doppel-XP (5 Runden)", emoji:"‚ö°", price:200, rarity:"rare", type:"boost", desc:"5 Aufgaben lang doppelte XP." },
    { id:"extra_hint",  name:"Tipp-Helfer", emoji:"üí°", price:150, rarity:"rare", type:"boost", desc:"Schaltet einen Hinweis-Button frei." },

    // ganz hinten: B√§r & Fuchs ‚Äì teuer / legend√§r
    { id:"fox",   name:"Fuchs",  emoji:"ü¶ä", price:600, rarity:"legendary", type:"avatar", desc:"Super-seltener Fuchs. Nur f√ºr Profis." },
    { id:"bear",  name:"B√§r",    emoji:"üêª", price:650, rarity:"legendary", type:"avatar", desc:"Galaktischer B√§r, der √ºber alles wacht." },
];

/* Gl√ºcksrad */
const SPIN_REWARDS = [
    { type:"coins", amount:50,  label:"+50 M√ºnzen",  weight:30 },
    { type:"coins", amount:120, label:"+120 M√ºnzen", weight:20 },
    { type:"xp",    amount:200, label:"+200 XP",      weight:20 },
    { type:"xp",    amount:400, label:"+400 XP",      weight:10 },
    { type:"item",  rarity:"rare",      label:"Zuf√§lliger seltener Avatar",  weight:10 },
    { type:"item",  rarity:"legendary", label:"Ultra seltener Avatar!",      weight:5 },
    { type:"nothing", label:"Leider nix‚Ä¶",           weight:5 }
];

const chooseWeighted = (arr) => {
    const total = arr.reduce((s, r) => s + r.weight, 0);
    let r = Math.random() * total;
    for (const item of arr) {
        if (r < item.weight) return item;
        r -= item.weight;
    }
    return arr[arr.length - 1];
};

/* Haupt-App */
const App = () => {
    const [mode, setMode] = useState("menu"); // menu | memory | listen | write | shop

    const [xp, setXp] = useState(() => parseInt(localStorage.getItem("fr_xp") || "0", 10));
    const [coins, setCoins] = useState(() => parseInt(localStorage.getItem("fr_coins") || "0", 10));

    const [owned, setOwned] = useState(() => {
        const raw = localStorage.getItem("fr_owned");
        if (!raw) return ["starter"];
        try { return JSON.parse(raw); } catch { return ["starter"]; }
    });

    const [avatar, setAvatar] = useState(() => localStorage.getItem("fr_avatar") || "starter");
    const [doubleXpRounds, setDoubleXpRounds] = useState(0);

    const [spinState, setSpinState] = useState(() => {
        const raw = localStorage.getItem("fr_spin");
        if (!raw) return { lastDate:null };
        try { return JSON.parse(raw); } catch { return { lastDate:null }; }
    });

    // Memory state
    const [memCards, setMemCards] = useState([]);
    const [memFlipped, setMemFlipped] = useState([]);
    const [memMatched, setMemMatched] = useState([]);
    const [memLocked, setMemLocked] = useState(false);

    // Listen
    const [listenList, setListenList] = useState([]);
    const [listenIndex, setListenIndex] = useState(0);
    const [listenAnswered, setListenAnswered] = useState(false);
    const [listenCorrect, setListenCorrect] = useState(null);

    // Write
    const [writeList, setWriteList] = useState([]);
    const [writeIndex, setWriteIndex] = useState(0);
    const [writeInput, setWriteInput] = useState("");
    const [writeFeedback, setWriteFeedback] = useState(null); // {status, note}
    const [writeLocked, setWriteLocked] = useState(false);

    // Shop
    const [shopMessage, setShopMessage] = useState(null);
    const [spinResult, setSpinResult] = useState(null);
    const [spinBusy, setSpinBusy] = useState(false);

    /* Globale Speicherung */
    useEffect(() => localStorage.setItem("fr_xp", xp.toString()), [xp]);
    useEffect(() => localStorage.setItem("fr_coins", coins.toString()), [coins]);
    useEffect(() => localStorage.setItem("fr_owned", JSON.stringify(owned)), [owned]);
    useEffect(() => localStorage.setItem("fr_avatar", avatar), [avatar]);
    useEffect(() => localStorage.setItem("fr_spin", JSON.stringify(spinState)), [spinState]);

    const calcLevel = () => {
        let lvl = 1;
        for (let i = 0; i < XP_LEVELS.length; i++) {
            if (xp >= XP_LEVELS[i]) lvl = i + 1;
        }
        return Math.min(lvl, XP_LEVELS.length);
    };

    const level = calcLevel();
    const maxLevel = XP_LEVELS.length;
    const nextLevelXp = level >= maxLevel ? XP_LEVELS[maxLevel-1] : XP_LEVELS[level];
    const prevLevelXp = level > 1 ? XP_LEVELS[level-1] : 0;
    const levelProgress = level >= maxLevel ? 1 : (xp - prevLevelXp) / (nextLevelXp - prevLevelXp);

    const addReward = (baseXp, baseCoins) => {
        let bonusXp = baseXp;
        if (doubleXpRounds > 0) {
            bonusXp *= 2;
            setDoubleXpRounds(r => r - 1);
        }
        if (bonusXp > 0) setXp(x => x + bonusXp);
        if (baseCoins > 0) setCoins(c => c + baseCoins);
    };

    const resetAll = () => {
        if (!confirm("Wirklich alles zur√ºcksetzen? Level, M√ºnzen, gekaufte Dinge ‚Äì alles weg.")) return;
        setXp(0);
        setCoins(0);
        setOwned(["starter"]);
        setAvatar("starter");
        setDoubleXpRounds(0);
        setSpinState({ lastDate:null });
        setSpinResult(null);
        setShopMessage(null);
        setMode("menu");
    };

    /* Mode-Wechsel initialisiert jeweils das Spiel */
    useEffect(() => {
        if (mode === "memory") {
            const base = shuffle(WORDS).slice(0, 8); // 8 Paare
            const deck = shuffle(base.flatMap(w => ([
                { id: w.fr + "-fr", txt: w.fr, type:"fr", key:w.fr },
                { id: w.fr + "-de", txt: w.de, type:"de", key:w.fr }
            ])));
            setMemCards(deck);
            setMemFlipped([]);
            setMemMatched([]);
            setMemLocked(false);
        } else if (mode === "listen") {
            const list = shuffle(WORDS).slice(0, 15);
            setListenList(list);
            setListenIndex(0);
            setListenAnswered(false);
            setListenCorrect(null);
            if (list.length > 0) speakFR(list[0].fr);
        } else if (mode === "write") {
            const list = shuffle(WORDS).slice(0, 15);
            setWriteList(list);
            setWriteIndex(0);
            setWriteInput("");
            setWriteFeedback(null);
            setWriteLocked(false);
        } else if (mode === "menu") {
            // nichts
        }
    }, [mode]);

    /* MEMORY HANDLER */
    const handleFlip = (card) => {
        if (memLocked) return;
        if (memFlipped.includes(card.id) || memMatched.includes(card.id)) return;

        const newFlipped = [...memFlipped, card.id];
        setMemFlipped(newFlipped);

        if (newFlipped.length === 2) {
            setMemLocked(true);
            const [id1, id2] = newFlipped;
            const c1 = memCards.find(c => c.id === id1);
            const c2 = memCards.find(c => c.id === id2);
            if (c1 && c2 && c1.key === c2.key && c1.type !== c2.type) {
                // Treffer
                setTimeout(() => {
                    setMemMatched(m => [...m, id1, id2]);
                    setMemFlipped([]);
                    setMemLocked(false);
                    addReward(30, 10);
                    if (memMatched.length + 2 === memCards.length) {
                        safeConfetti();
                    }
                }, 550);
            } else {
                setTimeout(() => {
                    setMemFlipped([]);
                    setMemLocked(false);
                }, 750);
            }
        }
    };

    /* LISTEN HANDLER */
    const buildChoices = (current) => {
        const others = shuffle(WORDS.filter(w => w.de !== current.de)).slice(0,3);
        const opts = shuffle([current.de, ...others.map(o => o.de)]);
        return opts;
    };

    const [listenChoices, setListenChoices] = useState([]);
    useEffect(() => {
        if (mode !== "listen" || listenList.length === 0) return;
        const cur = listenList[listenIndex];
        if (!cur) return;
        setListenChoices(buildChoices(cur));
    }, [listenList, listenIndex, mode]);

    const handleListenAnswer = (option) => {
        if (listenAnswered) return;
        const cur = listenList[listenIndex];
        const correct = option === cur.de;
        setListenAnswered(true);
        setListenCorrect(correct);
        if (correct) {
            addReward(40, 15);
        }
    };

    const nextListen = () => {
        const nextIndex = listenIndex + 1;
        if (nextIndex >= listenList.length) {
            setMode("menu");
            return;
        }
        setListenIndex(nextIndex);
        setListenAnswered(false);
        setListenCorrect(null);
        const cur = listenList[nextIndex];
        speakFR(cur.fr);
    };

    /* WRITE HANDLER */
    const submitWrite = () => {
        if (writeLocked) return;
        const cur = writeList[writeIndex];
        const result = compareGerman(cur.de, writeInput);
        if (result.status === "empty") {
            setWriteFeedback({status:"empty", note:"Bitte etwas eingeben."});
            return;
        }
        setWriteLocked(true);
        setWriteFeedback(result);

        if (result.status === "full") {
            addReward(45, 15);
        } else if (result.status === "partial") {
            addReward(25, 8);
        }
    };

    const nextWrite = () => {
        const next = writeIndex + 1;
        if (next >= writeList.length) {
            setMode("menu");
            return;
        }
        setWriteIndex(next);
        setWriteInput("");
        setWriteFeedback(null);
        setWriteLocked(false);
    };

    /* SHOP / SPIN HANDLER */
    const buyItem = (item) => {
        if (owned.includes(item.id)) {
            setShopMessage("Das hast du schon.");
            return;
        }
        if (coins < item.price) {
            setShopMessage("Zu wenig M√ºnzen.");
            return;
        }
        setCoins(c => c - item.price);
        setOwned(o => [...o, item.id]);
        setShopMessage(`Gekauft: ${item.name}!`);
        if (item.type === "avatar") {
            setAvatar(item.id);
        }
        if (item.id === "double_xp_5") {
            setDoubleXpRounds(r => r + 5);
        }
    };

    const selectAvatar = (item) => {
        if (!owned.includes(item.id)) return;
        setAvatar(item.id);
    };

    const canSpinToday = () => {
        if (!spinState.lastDate) return true;
        const today = new Date().toISOString().slice(0,10);
        return spinState.lastDate !== today;
    };

    const doSpin = () => {
        if (!canSpinToday() || spinBusy) return;
        setSpinBusy(true);
        const today = new Date().toISOString().slice(0,10);
        const reward = chooseWeighted(SPIN_REWARDS);
        setTimeout(() => {
            setSpinBusy(false);
            setSpinState({ lastDate: today });
            let msg = reward.label;
            if (reward.type === "coins") {
                setCoins(c => c + reward.amount);
            } else if (reward.type === "xp") {
                setXp(x => x + reward.amount);
            } else if (reward.type === "item") {
                const candidates = SHOP_ITEMS.filter(i => i.type === "avatar" && i.rarity === reward.rarity);
                if (candidates.length > 0) {
                    const item = candidates[randInt(0, candidates.length-1)];
                    if (!owned.includes(item.id)) {
                        setOwned(o => [...o, item.id]);
                        setAvatar(item.id);
                        msg = `Gewonnen: ${item.name} (${reward.label})`;
                    } else {
                        setCoins(c => c + 150);
                        msg = `Du hattest den Avatar schon. Daf√ºr +150 M√ºnzen.`;
                    }
                }
            } else if (reward.type === "nothing") {
                // nichts
            }
            setSpinResult(msg);
            safeConfetti();
        }, 800);
    };

    /* RENDER-FUNKTIONEN */

    const renderHeader = () => (
        <header className="mb-5 flex flex-col gap-3">
            <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-2xl bg-slate-900 flex items-center justify-center text-2xl shadow-lg border border-slate-600">
                        {avatar === "starter" && "üöÄ"}
                        {avatar !== "starter" && (SHOP_ITEMS.find(i => i.id === avatar)?.emoji || "‚≠ê")}
                    </div>
                    <div>
                        <div className="text-slate-300 text-xs uppercase tracking-[0.2em]">Franz√∂sisch Galaxy</div>
                        <div className="font-game text-xl text-slate-50">Level {level} / {maxLevel}</div>
                    </div>
                </div>

                <div className="flex items-center gap-3 text-sm font-bold">
                    <a href="index.html" className="px-3 py-2 rounded-xl bg-slate-900 border border-slate-600 text-slate-200 hover:bg-slate-800">
                        ‚¨Ö Zur Startseite
                    </a>
                    <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-red-600 text-white text-xs font-bold border-b-4 border-red-900">
                        Reset alles
                    </button>
                </div>
            </div>

            <div className="flex items-center gap-4">
                <div className="flex-1">
                    <div className="flex justify-between text-xs text-slate-300 mb-1">
                        <span>XP: {xp}</span>
                        <span>{level >= maxLevel ? "Max Level" : `N√§chstes Level bei ${nextLevelXp} XP`}</span>
                    </div>
                    <div className="xp-track">
                        <div className="xp-fill" style={{ width: `${Math.min(100, Math.max(0, levelProgress * 100))}%` }}></div>
                    </div>
                </div>
                <div className="flex flex-col items-end">
                    <div className="text-sm font-bold text-amber-300">üí∞ {coins} M√ºnzen</div>
                    {doubleXpRounds > 0 && (
                        <div className="text-[0.7rem] text-emerald-300 font-bold">
                            ‚ö° Doppel-XP aktiv ({doubleXpRounds} Aufgaben)
                        </div>
                    )}
                </div>
            </div>
        </header>
    );

    const renderMenu = () => (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mt-2">
            <div className="mode-card" onClick={() => setMode("memory")}>
                <div className="flex items-center justify-between mb-3">
                    <div>
                        <div className="text-xs text-sky-300 uppercase tracking-[0.2em]">Modus</div>
                        <div className="font-game text-2xl text-sky-100">Memory</div>
                    </div>
                    <div className="text-4xl">üß†</div>
                </div>
                <p className="text-sm text-slate-300">
                    Finde passende Paare (FR/DE). Jede richtige Kombination bringt XP & M√ºnzen.
                </p>
            </div>

            <div className="mode-card" onClick={() => setMode("listen")}>
                <div className="flex items-center justify-between mb-3">
                    <div>
                        <div className="text-xs text-indigo-300 uppercase tracking-[0.2em]">Modus</div>
                        <div className="font-game text-2xl text-indigo-100">H√∂r zu</div>
                    </div>
                    <div className="text-4xl">üéß</div>
                </div>
                <p className="text-sm text-slate-300">
                    H√∂re das franz√∂sische Wort und w√§hle die richtige deutsche Bedeutung aus 4 M√∂glichkeiten.
                </p>
            </div>

            <div className="mode-card" onClick={() => setMode("write")}>
                <div className="flex items-center justify-between mb-3">
                    <div>
                        <div className="text-xs text-violet-300 uppercase tracking-[0.2em]">Modus</div>
                        <div className="font-game text-2xl text-violet-100">Schreiben</div>
                    </div>
                    <div className="text-4xl">‚úçÔ∏è</div>
                </div>
                <p className="text-sm text-slate-300">
                    Du siehst nur das franz√∂sische Wort und musst die deutsche Bedeutung schreiben.
                    Artikel-Fehler geben halbe Punkte.
                </p>
            </div>

            <div className="mode-card" onClick={() => setMode("shop")}>
                <div className="flex items-center justify-between mb-3">
                    <div>
                        <div className="text-xs text-emerald-300 uppercase tracking-[0.2em]">Modus</div>
                        <div className="font-game text-2xl text-emerald-100">Shop & Gl√ºcksrad</div>
                    </div>
                    <div className="text-4xl">üõí</div>
                </div>
                <p className="text-sm text-slate-300">
                    Kaufe Tiere, Avatare & Booster. Drehe einmal pro Tag am Gl√ºcksrad f√ºr Extra-Belohnungen.
                </p>
            </div>
        </div>
    );

    const renderMemory = () => (
        <div className="mt-2">
            <div className="flex items-center justify-between mb-3">
                <h2 className="font-game text-xl text-sky-100 flex items-center gap-2">
                    üß† Memory ‚Äì FR / DE
                </h2>
                <button
                    className="text-xs px-3 py-1 rounded-xl bg-slate-800 border border-slate-600"
                    onClick={() => setMode("menu")}
                >
                    ‚¨Ö Zur√ºck zum Modus-Men√º
                </button>
            </div>
            <p className="text-xs text-slate-400 mb-3">
                Tipp: Laut mitsprechen. Jede gefundene Karte gibt XP & M√ºnzen.
            </p>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                {memCards.map(card => {
                    const flipped = memFlipped.includes(card.id) || memMatched.includes(card.id);
                    const matched = memMatched.includes(card.id);
                    return (
                        <div key={card.id} className="scene">
                            <div
                                className={`card ${flipped ? "flipped" : ""} ${matched ? "matched" : ""}`}
                                onClick={() => handleFlip(card)}
                            >
                                <div className="face front">?</div>
                                <div className={`face back type-${card.type}`}>
                                    <span>{card.txt}</span>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );

    const renderListen = () => {
        if (listenList.length === 0) return null;
        const cur = listenList[listenIndex];

        return (
            <div className="mt-2">
                <div className="flex items-center justify-between mb-3">
                    <h2 className="font-game text-xl text-indigo-100 flex items-center gap-2">
                        üéß H√∂r zu ‚Äì Multiple Choice
                    </h2>
                    <button
                        className="text-xs px-3 py-1 rounded-xl bg-slate-800 border border-slate-600"
                        onClick={() => setMode("menu")}
                    >
                        ‚¨Ö Zur√ºck zum Modus-Men√º
                    </button>
                </div>

                <div className="mb-2 text-xs text-slate-400">
                    Aufgabe {listenIndex + 1} von {listenList.length}
                </div>

                <div className="glass-panel p-4 flex flex-col gap-4">
                    <div className="flex items-center justify-between">
                        <div>
                            <div className="text-xs uppercase tracking-[0.2em] text-indigo-300 mb-1">Franz√∂sisch anh√∂ren</div>
                            <div className="font-game text-2xl text-slate-50">{cur.fr}</div>
                        </div>
                        <button
                            className="btn-main btn-purple text-xs"
                            onClick={() => speakFR(cur.fr)}
                        >
                            ‚ñ∂ Nochmal h√∂ren
                        </button>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
                        {listenChoices.map(opt => {
                            const selected = listenAnswered && opt === cur.de;
                            const isCorrect = listenAnswered && opt === cur.de && listenCorrect;
                            const isWrong = listenAnswered && opt !== cur.de && !listenCorrect;
                            let extra = "";
                            if (isCorrect) extra = "answer-correct";
                            if (isWrong) extra = "answer-wrong";
                            return (
                                <button
                                    key={opt}
                                    className={`answer-btn ${listenAnswered ? "" : "hover:border-sky-400"} ${extra}`}
                                    onClick={() => handleListenAnswer(opt)}
                                    disabled={listenAnswered}
                                >
                                    {opt}
                                </button>
                            );
                        })}
                    </div>

                    <div className="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <div className="text-sm">
                            {!listenAnswered && (
                                <span className="text-slate-400">
                                    W√§hle die richtige deutsche Bedeutung.
                                </span>
                            )}
                            {listenAnswered && listenCorrect && (
                                <span className="text-emerald-300 font-semibold">
                                    ‚úî Richtig! Weiter zur n√§chsten Aufgabe.
                                </span>
                            )}
                            {listenAnswered && listenCorrect === false && (
                                <span className="text-red-300 font-semibold">
                                    ‚úñ Leider falsch. Du bekommst hier keine M√ºnzen.
                                </span>
                            )}
                        </div>
                        <button
                            className="btn-main btn-blue text-xs"
                            onClick={nextListen}
                            disabled={!listenAnswered}
                        >
                            N√§chste Aufgabe ‚ñ∂
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const renderWrite = () => {
        if (writeList.length === 0) return null;
        const cur = writeList[writeIndex];

        return (
            <div className="mt-2">
                <div className="flex items-center justify-between mb-3">
                    <h2 className="font-game text-xl text-violet-100 flex items-center gap-2">
                        ‚úçÔ∏è Schreiben ‚Äì Deutsch eingeben
                    </h2>
                    <button
                        className="text-xs px-3 py-1 rounded-xl bg-slate-800 border border-slate-600"
                        onClick={() => setMode("menu")}
                    >
                        ‚¨Ö Zur√ºck zum Modus-Men√º
                    </button>
                </div>

                <div className="mb-2 text-xs text-slate-400">
                    Aufgabe {writeIndex + 1} von {writeList.length}
                </div>

                <div className="glass-panel p-5 flex flex-col gap-4">
                    <div className="flex items-center justify-between gap-4">
                        <div>
                            <div className="text-xs uppercase tracking-[0.2em] text-violet-300 mb-1">
                                Franz√∂sisches Wort
                            </div>
                            <div className="font-game text-3xl text-slate-50">{cur.fr}</div>
                        </div>
                        <button
                            className="btn-main btn-purple text-xs"
                            onClick={() => speakFR(cur.fr)}
                        >
                            ‚ñ∂ Anh√∂ren
                        </button>
                    </div>

                    <div>
                        <label className="text-xs text-slate-300 mb-1 block">
                            Schreibe die deutsche Bedeutung (Gross/Klein egal, Artikel nur halbe Punkte).
                        </label>
                        <input
                            className="input-de"
                            value={writeInput}
                            onChange={e => setWriteInput(e.target.value)}
                            placeholder="z.B. die Schildkr√∂te"
                        />
                    </div>

                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mt-1">
                        <div className="text-sm min-h-[1.5rem]">
                            {writeFeedback && writeFeedback.status === "full" && (
                                <span className="text-emerald-300 font-semibold">
                                    ‚úî Voll richtig! Du bekommst volle Punkte.
                                </span>
                            )}
                            {writeFeedback && writeFeedback.status === "partial" && (
                                <span className="text-amber-300 font-semibold">
                                    ‚úì Bedeutung stimmt, aber der Artikel war nicht korrekt. Halbe Punkte.
                                </span>
                            )}
                            {writeFeedback && writeFeedback.status === "wrong" && (
                                <span className="text-red-300 font-semibold">
                                    ‚úñ Leider falsch. Richtig w√§re: <span className="underline">{cur.de}</span>
                                </span>
                            )}
                            {writeFeedback && writeFeedback.status === "empty" && (
                                <span className="text-slate-300">
                                    Bitte zuerst etwas eingeben.
                                </span>
                            )}
                        </div>

                        <div className="flex gap-2 justify-end">
                            <button
                                className="btn-main btn-blue text-xs"
                                onClick={submitWrite}
                                disabled={writeLocked}
                            >
                                Pr√ºfen ‚úî
                            </button>
                            <button
                                className="btn-main btn-green text-xs"
                                onClick={nextWrite}
                                disabled={!writeLocked}
                            >
                                N√§chste ‚ñ∂
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const renderShop = () => (
        <div className="mt-2">
            <div className="flex items-center justify-between mb-3">
                <h2 className="font-game text-xl text-emerald-100 flex items-center gap-2">
                    üõí Tier-Shop & Gl√ºcksrad
                </h2>
                <button
                    className="text-xs px-3 py-1 rounded-xl bg-slate-800 border border-slate-600"
                    onClick={() => setMode("menu")}
                >
                    ‚¨Ö Zur√ºck zum Modus-Men√º
                </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-4">
                <div className="glass-panel p-4">
                    <div className="flex items-center justify-between mb-3">
                        <div>
                            <div className="text-xs text-slate-400 uppercase tracking-[0.2em]">
                                Avatare & Booster
                            </div>
                            <div className="font-game text-lg text-slate-50">
                                W√§hle dein Lern-Team
                            </div>
                        </div>
                        {shopMessage && (
                            <div className="text-xs text-sky-300">
                                {shopMessage}
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        {SHOP_ITEMS.map(item => {
                            const ownedItem = owned.includes(item.id);
                            const isAvatar = item.type === "avatar";
                            const selectedAvatar = isAvatar && avatar === item.id;
                            return (
                                <div
                                    key={item.id}
                                    className={`shop-card rarity-${item.rarity} ${selectedAvatar ? "ring-2 ring-amber-300" : ""}`}
                                    onClick={() => (isAvatar && ownedItem) ? selectAvatar(item) : buyItem(item)}
                                >
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="text-2xl">{item.emoji}</div>
                                        <div className="text-[0.7rem] uppercase tracking-[0.2em] text-slate-400">
                                            {item.rarity === "common" && "Normal"}
                                            {item.rarity === "rare" && "Selten"}
                                            {item.rarity === "epic" && "Episch"}
                                            {item.rarity === "legendary" && "Legend√§r"}
                                        </div>
                                    </div>
                                    <div className="font-game text-lg text-slate-50">{item.name}</div>
                                    <div className="text-[0.8rem] text-slate-300 flex-1 mt-1">
                                        {item.desc}
                                    </div>
                                    <div className="mt-2 flex items-center justify-between text-xs font-bold">
                                        <span className={`${ownedItem ? "text-emerald-300" : "text-amber-300"}`}>
                                            {ownedItem ? "GEKAUFT" : `Preis: ${item.price} üí∞`}
                                        </span>
                                        {isAvatar && selectedAvatar && (
                                            <span className="text-sky-300">Aktiv</span>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                <div className="glass-panel p-4 flex flex-col gap-3">
                    <div>
                        <div className="text-xs text-slate-400 uppercase tracking-[0.2em]">
                            Gl√ºcksrad
                        </div>
                        <div className="font-game text-lg text-slate-50">
                            Einmal pro Tag drehen
                        </div>
                    </div>
                    <div className="flex flex-col items-center justify-center gap-3 py-3">
                        <div className="text-5xl animate-pulse">üé°</div>
                        <button
                            className="btn-main btn-yellow text-xs"
                            disabled={!canSpinToday() || spinBusy}
                            onClick={doSpin}
                        >
                            {canSpinToday() ? (spinBusy ? "Dreht..." : "Jetzt drehen") : "Heute schon gedreht"}
                        </button>
                        {spinResult && (
                            <div className="text-xs text-center text-sky-300">
                                {spinResult}
                            </div>
                        )}
                    </div>
                    <div className="text-[0.7rem] text-slate-400">
                        Belohnungen k√∂nnen M√ºnzen, XP oder seltene Avatare sein.
                        Wenn du einen Avatar doppelt bekommst, gibt es stattdessen Bonus-M√ºnzen.
                    </div>
                </div>
            </div>
        </div>
    );

    return (
        <main className="max-w-5xl mx-auto px-4 pt-6 pb-10">
            {renderHeader()}

            {mode === "menu"   && renderMenu()}
            {mode === "memory" && renderMemory()}
            {mode === "listen" && renderListen()}
            {mode === "write"  && renderWrite()}
            {mode === "shop"   && renderShop()}
        </main>
    );
};

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
